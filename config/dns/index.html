<!doctype html><html><head><title>内置DNS服务器 :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2020-12-27T15:37:18 UTC"><meta name=description content="Project X 的文档."><meta name=author content="Project X"><title>内置DNS服务器 :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/config/dns/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/about/>Project X&nbsp;⚡</a><ul><li data-nav-id=https://xtls.github.io/about/new/ class="dd-item
item_level_$level"><a href=/about/new/>大史记&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/guide/>快速入门&nbsp;</a></li><li data-nav-id=https://xtls.github.io/config/ class="dd-item parent active haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/config/>配置文件&nbsp;📜</a><ul><li data-nav-id=https://xtls.github.io/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/config/inbound-protocols/>inbound可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/config/outbound-protocols/>outbound可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/transports/ class="dd-item
item_level_$level"><a href=/config/transports/>传输方式列表</a></li><li data-nav-id=https://xtls.github.io/config/fallback/ class="dd-item
item_level_$level"><a href=/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/config/xtls/ class="dd-item
item_level_$level"><a href=/config/xtls/>XTLS</a></li><li data-nav-id=https://xtls.github.io/config/env/ class="dd-item
item_level_$level"><a href=/config/env/>环境变量</a></li><li data-nav-id=https://xtls.github.io/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/config/multiple_config/>多文件配置</a></li></ul></li><li data-nav-id=https://xtls.github.io/documents/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/documents/>使用心得&nbsp;📚</a><ul><li data-nav-id=https://xtls.github.io/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-1/>小小白白话文&nbsp;📙</a></li><li data-nav-id=https://xtls.github.io/documents/level-2/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-2/>进阶文档&nbsp;📘</a></li></ul></li><li data-nav-id=https://xtls.github.io/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/develop/>开发指南&nbsp;🖥️</a><ul><li data-nav-id=https://xtls.github.io/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/intro/>开发手册</a></li><li data-nav-id=https://xtls.github.io/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/protocols/>协议详解</a></li></ul></li><li data-nav-id=https://xtls.github.io/qa/ class="dd-item alwaysopen
item_level_$level"><a href=/qa/>常见问答&nbsp;💬</a></li><li data-nav-id=https://xtls.github.io/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/caseslip/>大案牍术&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/links/ class="dd-item alwaysopen
item_level_$level"><a href=/links/>常用链接&nbsp;🤝</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io>Home</a></li><li><a class=text-link href=/config/>配置文件</a></li><li class=active>内置DNS服务器</li></ol></nav><h1>配置文件<span>内置DNS服务器</span></h1><nav class=subpages><li><a title=$pagetitle href=/config/log/>日志配置</a></li><li><a title=$pagetitle href=/config/api/>API接口</a></li><li class=active><a title=$pagetitle href=/config/dns/>内置DNS服务器</a></li><li><a title=$pagetitle href=/config/routing/>路由</a></li><li><a title=$pagetitle href=/config/policy/>本地策略</a></li><li><a title=$pagetitle href=/config/inbounds/>Inbounds</a></li><li><a title=$pagetitle href=/config/outbounds/>Outbounds</a></li><li><a title=$pagetitle href=/config/transport/>传输方式</a></li><li><a title=$pagetitle href=/config/stats/>统计信息</a></li><li><a title=$pagetitle href=/config/reverse/>反向代理</a></li></nav><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#dns-服务器>DNS 服务器</a></li><li><a href=#dns-处理流程>DNS 处理流程</a></li><li><a href=#dnsobject>DnsObject</a><ul><li><a href=#serverobject>ServerObject</a></li></ul></li></ul></nav></div><div class=content><h2 ref=dns-服务器>DNS 服务器</h2><a class=anchor id=dns-服务器></a><hr><p>如果为 Xray 配置了 DNS 服务器模块，主要有两大用途：</p><ul><li><p>在路由阶段, 解析域名为 IP, 并且根据域名解析得到的 IP 进行规则匹配以分流. 是否解析域名及分流和路由配置模块中"domainStrategy"的值有关, 只有在设置以下两种值时,才会使用内置 DNS 服务器进行 DNS 查询:</p><ul><li>&ldquo;IPIfNonMatch&rdquo;, 请求一个域名时，进行路由里面的 domain 进行匹配，若无法匹配到结果，则对这个域名使用内置 DNS 服务器进行 DNS 查询，并且使用查询返回的 IP 地址再重新进行 IP 路由匹配。</li><li>&ldquo;IPOnDemand&rdquo;, 当匹配时碰到任何基于 IP 的规则，将域名立即解析为 IP 进行匹配。</li></ul></li><li><p>解析目标地址进行连接。</p><ul><li>如 在 <code>freedom</code> 协议的 <code>outbound</code> 中，将<code>domainStrategy</code> 设置为 <code>UseIP</code>, 由此 outbound 发出的请求, 会先将域名通过内置服务器解析成 IP, 然后进行连接</li></ul></li></ul><div class="notices info"><p><strong>TIP 1</strong><br>内置 DNS 服务器所发出的 DNS 查询请求，会自动根据路由配置进行转发。</p></div><div class="notices info"><p><strong>TIP 2</strong><br>只支持最基本的 IP 查询（A 和 AAAA 记录）。</p></div><p><br></p><h2 ref=dns-处理流程>DNS 处理流程</h2><a class=anchor id=dns-处理流程></a><hr><p>DNS 服务器配置模块可以配置多个DNS服务器, 并且指定优先匹配列表.</p><ol><li>查询的域名与某个 DNS 服务器指定的域名列表匹配时，Xray 会优先使用这个 DNS 服务器进行查询</li><li>无匹配时, 按从上往下的顺序进行查询</li><li>只返回匹配 expectIPs 的 IP 列表。</li></ol><p>DNS 服务器的处理流程示意图如下：</p><p><img src="../dns_flow.png?classes=border,shadow" alt></p><p><br></p><h2 ref=dnsobject>DnsObject</h2><a class=anchor id=dnsobject></a><hr><p><code>DnsObject</code> 对应配置文件的 <code>dns</code> 项。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;dns&#34;</span>: {
    <span style=color:#f92672>&#34;hosts&#34;</span>: {
      <span style=color:#f92672>&#34;baidu.com&#34;</span>: <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
    },
    <span style=color:#f92672>&#34;servers&#34;</span>: [
      <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>,
      <span style=color:#e6db74>&#34;8.8.4.4&#34;</span>,
      {
        <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;1.2.3.4&#34;</span>,
        <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>5353</span>,
        <span style=color:#f92672>&#34;domains&#34;</span>: [<span style=color:#e6db74>&#34;domain:xray.com&#34;</span>],
        <span style=color:#f92672>&#34;expectIPs&#34;</span>: [<span style=color:#e6db74>&#34;geoip:cn&#34;</span>]
      },
      <span style=color:#e6db74>&#34;localhost&#34;</span>
    ],
    <span style=color:#f92672>&#34;clientIp&#34;</span>: <span style=color:#e6db74>&#34;1.2.3.4&#34;</span>,
    <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;dns_inbound&#34;</span>
  }
}
</code></pre></div><div class="notices dark"><p><code>hosts</code>: map{string: address}</p></div><p>静态 IP 列表，其值为一系列的 &ldquo;域名&rdquo;: &ldquo;地址&rdquo;。其中地址可以是 IP 或者域名。在解析域名时，如果域名匹配这个列表中的某一项:</p><ul><li>当该项的地址为 IP 时，则解析结果为该项的 IP</li><li>当该项的地址为域名时，会使用此域名进行 IP 解析，而不使用原始域名。</li></ul><p>域名的格式有以下几种形式：</p><ul><li>纯字符串：当此字符串完整匹配目标域名时，该规则生效。例如 &ldquo;xray.com&rdquo; 匹配"xray.com" 但不匹配"www.xray.com"。</li><li>正则表达式：由 <code>"regexp:"</code> 开始，余下部分是一个正则表达式。当此正则表达式匹配目标域名时，该规则生效。例如 &ldquo;regexp:\\.goo.*\\.com$&rdquo; 匹配"www.google.com"或 &ldquo;fonts.googleapis.com&rdquo;，但不匹配 &ldquo;google.com&rdquo;。</li><li>子域名 (推荐)：由 <code>"domain:"</code> 开始，余下部分是一个域名。当此域名是目标域名或其子域名时，该规则生效。例如 &ldquo;domain:xray.com&rdquo; 匹配"www.xray.com"、&ldquo;xray.com&rdquo;，但不匹配"xray.com"。</li><li>子串：由 <code>"keyword:"</code> 开始，余下部分是一个字符串。当此字符串匹配目标域名中任意部分，该规则生效。比如 &ldquo;keyword:sina.com&rdquo; 可以匹配"sina.com"、&ldquo;sina.com.cn&rdquo; 和"www.sina.com"，但不匹配 &ldquo;sina.cn&rdquo;。</li><li>预定义域名列表：由 <code>"geosite:"</code> 开头，余下部分是一个名称，如 <code>geosite:google</code> 或者 <code>geosite:cn</code>。名称及域名列表参考 <a href=../routing/#%E9%A2%84%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D%E5%88%97%E8%A1%A8>预定义域名列表</a>。</li></ul><div class="notices dark"><p><code>servers</code>: [string | <a href=#serverobject>ServerObject</a> ]</p></div><p>一个 DNS 服务器列表，支持的类型有两种：DNS 地址（字符串形式）和 <a href=#serverobject>ServerObject</a> 。</p><p>当它的值是一个 DNS IP 地址时，如 <code>"8.8.8.8"</code>，Xray 会使用此地址的 53 端口进行 DNS 查询。</p><p>当值为 <code>"localhost"</code> 时，表示使用本机预设的 DNS 配置。</p><p>当值是 <code>"https://host:port/dns-query"</code> 的形式，如 <code>"https://dns.google/dns-query"</code>，Xray 会使用 <code>DNS over HTTPS</code> (RFC8484, 简称 DOH) 进行查询。有些服务商拥有 IP 别名的证书，可以直接写 IP 形式，比如 <code>https://1.1.1.1/dns-query</code>。也可使用非标准端口和路径，如 <code>"https://a.b.c.d:8443/my-dns-query"</code></p><p>当值是 <code>"https+local://host:port/dns-query"</code> 的形式，如 <code>"https+local://dns.google/dns-query"</code>，Xray 会使用 <code>DOH本地模式</code> 进行查询，即 DOH 请求不会经过 Routing/Outbound 等组件，直接对外请求，以降低耗时。一般适合在服务端使用。也可使用非标端口和路径。</p><div class="notices info"><p><strong>TIP 1</strong><br>当使用 <code>localhost</code> 时，本机的 DNS 请求不受 Xray 控制，需要额外的配置才可以使 DNS 请求由 Xray 转发。</p></div><div class="notices info"><p><strong>TIP 2</strong><br>不同规则初始化得到的 DNS 客户端会在 Xray 启动日志中以 <code>info</code> 级别体现，比如 <code>local DOH</code>、<code>remote DOH</code> 和 <code>udp</code> 等模式。</p></div><div class="notices dark"><p><code>clientIp</code>: string</p></div><p>用于 DNS 查询时通知服务器以指定IP位置。不能是私有地址。</p><div class="notices dark"><p><code>tag</code>: string</p></div><p>由内置 DNS 发出的查询流量，除 <code>localhost</code> 和 <code>DOHL_</code> 模式外，都可以用此标识在路由使用 <code>inboundTag</code> 进行匹配。</p><p><br></p><h3 ref=serverobject>ServerObject</h3><a class=anchor id=serverobject></a><hr><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;1.2.3.4&#34;</span>,
    <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>5353</span>,
    <span style=color:#f92672>&#34;domains&#34;</span>: [
        <span style=color:#e6db74>&#34;domain:xray.com&#34;</span>
    ],
    <span style=color:#f92672>&#34;expectIPs&#34;</span>: [
        <span style=color:#e6db74>&#34;geoip:cn&#34;</span>
    ]
}
</code></pre></div><div class="notices dark"><p><code>address</code>: address</p></div><p>一个 DNS 服务器列表，支持的类型有两种：DNS 地址（字符串形式）和 ServerObject 。</p><p>当它的值是一个 DNS IP 地址时，如 &ldquo;8.8.8.8&rdquo;，Xray 会使用此地址的 53 端口进行 DNS 查询。</p><p>当值为 &ldquo;localhost&rdquo; 时，表示使用本机预设的 DNS 配置。</p><p>当值是 &ldquo;https://host:port/dns-query&rdquo; 的形式，如 &ldquo;<a href=https://dns.google/dns-query%22>https://dns.google/dns-query"</a>，Xray 会使用 DNS over HTTPS (RFC8484, 简称 DOH) 进行查询。有些服务商拥有 IP 别名的证书，可以直接写 IP 形式，比如 https://1.1.1.1/dns-query。也可使用非标准端口和路径，如 &ldquo;<a href=https://a.b.c.d>https://a.b.c.d</a>:8443/my-dns-query&rdquo;</p><p>当值是 &ldquo;https+local://host:port/dns-query&rdquo; 的形式，如 &ldquo;https+local://dns.google/dns-query&rdquo;，Xray 会使用 DOH本地模式 进行查询，即 DOH 请求不会经过 Routing/Outbound 等组件，直接对外请求，以降低耗时。一般适合在服务端使用。也可使用非标端口和路径。</p><blockquote></blockquote><div class="notices dark"><p><code>port</code>: number</p></div><p>DNS 服务器端口，如 <code>53</code>。此项缺省时默认为 <code>53</code>。当使用 DOH 模式该项无效，非标端口应在 URL 中指定。</p><div class="notices dark"><p><code>domains</code>: [string]</p></div><p>一个域名列表，此列表包含的域名，将优先使用此服务器进行查询。域名格式和 <a href=../routing#ruleobject>路由配置</a> 中相同。</p><div class="notices dark"><p><code>expectIPs</code>:[string]</p></div><p>一个 IP 范围列表，格式和 <a href=../routing#ruleobject>路由配置</a> 中相同。</p><p>当配置此项时，Xray DNS 会对返回的 IP 的进行校验，只返回包含 expectIPs 列表中的地址。</p><p>如果未配置此项，会原样返回 IP 地址。</p></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/config/dns/>内置DNS服务器</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#dns-服务器>DNS 服务器</a></li><li><a href=#dns-处理流程>DNS 处理流程</a></li><li><a href=#dnsobject>DnsObject</a><ul><li><a href=#serverobject>ServerObject</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/config/dns.md target=blank><i class="fab fa-github"></i>Improve this page</a></li><li><i class="fas fa-calendar"></i>Last update on 23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>