<!doctype html><html><head><title>回落 (fallbacks) 功能简析 :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-03-14T08:21:39 UTC"><meta name=description content="入门心得"><meta name=author content="Project X"><title>回落 (fallbacks) 功能简析 :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https://xtls.github.io"</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/documents/level-1/fallbacks-lv1/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https://xtls.github.io"</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/about/>Project X&nbsp;⚡</a><ul><li data-nav-id=https://xtls.github.io/about/new/ class="dd-item
item_level_$level"><a href=/about/new/>大史记&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/guide/>快速入门&nbsp;</a></li><li data-nav-id=https://xtls.github.io/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/config/>配置文件&nbsp;📜</a><ul><li data-nav-id=https://xtls.github.io/config/base/ class="dd-item haschildren
item_level_$level"><a href=/config/base/>基础配置模块&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/config/base/log/ class="dd-item
item_level_$level"><a href=/config/base/log/>日志配置</a></li><li data-nav-id=https://xtls.github.io/config/base/api/ class="dd-item
item_level_$level"><a href=/config/base/api/>API接口</a></li><li data-nav-id=https://xtls.github.io/config/base/dns/ class="dd-item
item_level_$level"><a href=/config/base/dns/>内置DNS服务器</a></li><li data-nav-id=https://xtls.github.io/config/base/routing/ class="dd-item
item_level_$level"><a href=/config/base/routing/>路由</a></li><li data-nav-id=https://xtls.github.io/config/base/policy/ class="dd-item
item_level_$level"><a href=/config/base/policy/>本地策略</a></li><li data-nav-id=https://xtls.github.io/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/transport/ class="dd-item
item_level_$level"><a href=/config/base/transport/>传输方式</a></li><li data-nav-id=https://xtls.github.io/config/base/stats/ class="dd-item
item_level_$level"><a href=/config/base/stats/>统计信息</a></li><li data-nav-id=https://xtls.github.io/config/base/reverse/ class="dd-item
item_level_$level"><a href=/config/base/reverse/>反向代理</a></li></ul></li><li data-nav-id=https://xtls.github.io/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/config/inbound-protocols/>Inbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/config/outbound-protocols/>Outbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/transports/ class="dd-item
item_level_$level"><a href=/config/transports/>传输方式列表</a></li><li data-nav-id=https://xtls.github.io/config/vless/ class="dd-item
item_level_$level"><a href=/config/vless/>VLESS 协议详解</a></li><li data-nav-id=https://xtls.github.io/config/fallback/ class="dd-item
item_level_$level"><a href=/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/config/xtls/ class="dd-item
item_level_$level"><a href=/config/xtls/>XTLS 深度剖析</a></li><li data-nav-id=https://xtls.github.io/config/env/ class="dd-item
item_level_$level"><a href=/config/env/>环境变量</a></li><li data-nav-id=https://xtls.github.io/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/config/multiple_config/>多文件配置</a></li></ul></li><li data-nav-id=https://xtls.github.io/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/documents/>使用心得&nbsp;📚</a><ul><li data-nav-id=https://xtls.github.io/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-0/>小小白白话文&nbsp;📙</a></li><li data-nav-id=https://xtls.github.io/documents/level-1/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/documents/level-1/>入门技巧&nbsp;📚</a></li><li data-nav-id=https://xtls.github.io/documents/level-2/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-2/>进阶文档&nbsp;📘</a></li></ul></li><li data-nav-id=https://xtls.github.io/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/develop/>开发指南&nbsp;🖥️</a><ul><li data-nav-id=https://xtls.github.io/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/intro/>开发手册</a></li><li data-nav-id=https://xtls.github.io/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/protocols/>协议详解</a></li></ul></li><li data-nav-id=https://xtls.github.io/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/faq/>常见问答&nbsp;💬</a></li><li data-nav-id=https://xtls.github.io/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/caseslip/>大案牍术&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/links/ class="dd-item alwaysopen
item_level_$level"><a href=/links/>常用链接&nbsp;🤝</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io></a></li><li><a class=text-link href=/documents/>使用心得</a></li><li><a class=text-link href=/documents/level-1/>入门技巧</a></li><li class=active>回落 (fallbacks) 功能简析</li></ol></nav><h1>入门技巧<span>回落 (fallbacks) 功能简析</span></h1><nav class=subpages><li class=active><a title=$pagetitle href=/documents/level-1/fallbacks-lv1/>回落 (fallbacks) 功能简析&nbsp;📙</a></li><li><a title=$pagetitle href=/documents/level-1/fallbacks-with-sni/>通过 SNI 回落功能实现伪装与按域名分流</a></li><li><a title=$pagetitle href=/documents/level-1/routing-lv1-part1/>路由 (routing) 功能简析（上）&nbsp;📙</a></li><li><a title=$pagetitle href=/documents/level-1/routing-lv1-part2/>路由 (routing) 功能简析（下）&nbsp;📙</a></li><li><a title=$pagetitle href=/documents/level-1/work/>Xray的工作模式</a></li></nav><div class=jump-to-section><span onclick="$h=$(this),$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><span class="fas fa-align-right"></span><i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#1-回顾小小白白话文中的回落>1. 回顾《小小白白话文》中的回落</a></li><li><a href=#2-重新认识回落-what-how-v1>2. 重新认识回落 (WHAT, HOW <code>v1</code>)</a></li><li><a href=#3-为什么要回落-why-v1>3. 为什么要回落 (WHY <code>v1</code>)</a></li><li><a href=#4-重新认识回落の完全体-what-why-how-v2>4. 重新认识【回落の完全体】 (WHAT, WHY, HOW <code>v2</code>)</a></li><li><a href=#5-多层回落示例及解读>5. 多层回落示例及解读</a><ul><li></li></ul></li><li><a href=#6-结语>6. 结语</a></li><li><a href=#7-附加题>7. 附加题</a></li></ul></nav></div><div class=content><p>在使用Xray的过程中，你一定无数次的听说了【回落】这个功能。本文就稍微说明一下这个功能的逻辑以及使用方式。</p><h2 ref=1-回顾小小白白话文中的回落>1. 回顾《小小白白话文》中的回落</h2><a class=anchor id=1-回顾小小白白话文中的回落></a><p>如果你用了《小小白白话文》中的<a href=../../level-0/ch07-xray-server/#74-%E9%85%8D%E7%BD%AExray>Xray配置</a>，并完成了<a href=../../level-0/ch07-xray-server/#78-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%98%E5%8C%96%E4%B9%8B%E4%BA%8C%E5%BC%80%E5%90%AFhttp%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AChttps>HTTP自动跳转HTTPS优化</a>，那么你已经有了基于 <code>VLESS</code> 协议的简易回落：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>&#34;inbounds&#34;: [
    {
        &#34;port&#34;: 443,
        &#34;protocol&#34;: &#34;vless&#34;,
        &#34;settings&#34;: {
            &#34;clients&#34;: [
                ...
            ],
            &#34;decryption&#34;: &#34;none&#34;,
            &#34;fallbacks&#34;: [
                {
                    &#34;dest&#34;: 8080 // 默认回落到防探测的代理
                }
            ]
        },
        &#34;streamSettings&#34;: {
            ...
        }
    }
]
</code></pre></div><p>这一段配置用人话要怎么解释呢？</p><ol><li><p><font size=4><strong><code>Xray</code> 的入站端口 <code>[inbound port]</code> 是 <code>443</code></strong></font></p><p><font size=2>即由 <code>Xray</code> 负责监听 <code>443</code> 端口的 <code>HTTPS</code> 流量</font></p></li><li><p><font size=4><strong><code>Xray</code> 的入站协议 <code>[inbound protocol]</code> 是 <code>vless</code></strong></font></p><p><font size=2>只有 <code>vless</code> 协议的流量才会流入 <code>Xray</code> 中做后续处理。</font></p><div class="notices warning"><p><strong>注：</strong> <code>VLESS</code> 这个轻量协议开发的初衷就是给 <code>xray</code> 及 <code>v2fly</code> 等核心引入回落功能、并同时减少冗余校验/加密。（当然，到目前为止，<code>xray</code> 中的 <code>trojan</code> 协议也已完整支持回落功能。）</p></div></li><li><p><font size=4><strong>回落目标端口 <code>[fallback dest]</code> 是 <code>8080</code></strong></font></p><p><font size=2><code>Xray</code> 接受 <code>443</code> 端口的访问流量后，属于 <code>vless</code> 协议的流量、由 <code>Xray</code> 进行内部处理并转发至出站模块。而其他非 <code>vless</code> 协议的流量，则转发至 <code>8080</code> 端口。</font></p><div class="notices warning"><p><strong>问：到底是单数还是复数？</strong></p><p>答：一定有聪明的同学发现，配置文件中，明明是复数 <code>inbounds</code>, <code>fallbacks</code>，为什么我解释的时候都是单数：<code>inbound</code>, <code>fallback</code> 呢？</p><p>因为，配置文件中用复数，说明 <code>xray</code> 支持 N 个同等级的元素（即N个入站，M个回落等等），上面的示例解析中仅仅是其中一个，所以我用了单数。</p></div></li><li><p><font size=4><strong>回落给 <code>8080</code> 端口的流量，由后续程序处理</strong></font></p><p><font size=2>小小白白话文中的示例，就是 <code>8080</code> 端口由 <code>Nginx</code> 处理，根据配置找到并展示小熊猫的网页。</font></p></li><li><p><font size=4><strong>总结，小小白白话文示例中的最简单回落，完整数据路线如下：</strong></font></p><script defer src=https://unpkg.com/mermaid@8.8.2/dist/mermaid.min.js>mermaid.initialize({startOnLoad:!0})</script><div class=mermaid align=left>graph LR;
W(外部 HTTP:80 请求) --> N80(HTTP:80)
subgraph Nginx 外部监听
N80 -.- N301(301转写) -.- N443(HTTPS:443)
end
N443 --> X(Xray 监听 443) .- X1{入站判断}
X1 --> |接收 VLESS 流量| X2(Xray内部规则)
X2 --> O(Xray Outbounds 出站)
X1 ==> |回落 非VLESS 流量| N8080(Nginx:8080)
N8080:::nginxclass ==> H(index.html)
H:::nginxclass
classDef nginxclass fill:#FFFFDE</div></li></ol></br><h2 ref=2-重新认识回落-what-how-v1>2. 重新认识回落 (WHAT, HOW <code>v1</code>)</h2><a class=anchor id=2-重新认识回落-what-how-v1></a><p>基于上面的示例，你应该就可以明白什么是回落（What）和怎么回落（How）了，简单地说就是下面这几个要素：</p><ol><li>回落的时间是流量进入 <code>Xray监听端口</code> 后</li><li>回落的依据是 <code>协议类型</code> 等流量特征</li><li>回落的目标是某个 <code>端口</code></li><li>被回落的流量由监听 <code>回落端口</code> 的后续程序接手</li></ol></br><h2 ref=3-为什么要回落-why-v1>3. 为什么要回落 (WHY <code>v1</code>)</h2><a class=anchor id=3-为什么要回落-why-v1></a><p>最初，是为了防御 <strong>【主动探测】</strong> (Active Probing)</p><p><strong>主动探测：</strong> 简单粗暴的理解，就是指外部通过发送特定的网络请求，并解读服务器的回应内容，来推测服务器端是否运行了 <code>xray</code>, <code>v2fly</code>, <code>shadowsocks</code> 等代理工具。一旦可以准确认定，则服务器可能受到干扰或阻断。</p><p>之所以可以根据服务器回应内容进行解读，就是因为一次完整的数据请求，其实有很多数据交换的步骤，每一个步骤，都会产生一些软件特征。用大白话说就是：</p><ul><li>正常的网站的回应，一定【会有】类似 <code>Nginx</code>, <code>Apache</code>, <code>MySQL</code> 的Web服务、数据库等工具的特征</li><li>正常的网站的回应，一定【不会有】类似 <code>xray</code>, <code>v2fly</code>, <code>shadowsocks</code> 等代理工具的特征</li></ul><p>于是，当我们给 <code>Xray</code> 提供了【回落】功能后（如上例，回落给 <code>Nginx</code>），面对任何用来探测的请求，产生的结果是：</p><ul><li>探测流量无法掌握你的 <code>VLESS</code> 要素，故都会被回落至 <code>Nginx</code></li><li>探测流量全都回落进入 <code>Nginx</code> ，故VPS服务器的回应一定【会有】 <code>Nginx</code> 的特征</li><li>因为 <code>Xray</code> 本身不对探测流量做任何回应 ，所以VPS的回应一定【不会有】 <code>Xray</code> 的特征</li></ul><p>至此，【回落】功能就从数据交互逻辑上解决了服务器被 <strong>【主动探测】</strong> 的安全隐患。</p></br><h2 ref=4-重新认识回落の完全体-what-why-how-v2>4. 重新认识【回落の完全体】 (WHAT, WHY, HOW <code>v2</code>)</h2><a class=anchor id=4-重新认识回落の完全体-what-why-how-v2></a><p>为什么又要再次认识回落呢？ 因为，上面仅仅说清楚了基于“协议”的、抵抗【主动探测】的初版回落。</p><p>在 <a href=https://github.com/rprx>rprx</a> 不断开发迭代 <code>VLESS</code> 协议及 <code>fallback</code> 功能的过程种，逐渐发现，回落完全可以更加灵活强大，只要在保证抵抗【主动探测】的前提下，充分利用数据首包中的信息，其实可以做到多元素、多层次的回落。（如 <code>path</code>, <code>alpn</code> 等）</p><p>基于这个开发理念，【回落】功能才逐渐成长为现在的完全体，即完成了 <code>纯伪装 --> ws分流 --> 多协议多特征分流</code> 的进化。最终版甚至完全替代了以前要用Web服务器、其他工具才能完成的分流的功能。且由于上述的【回落/分流】处理都在首包判断阶段以毫秒级的速度完成、不涉及任何数据操作，所以几乎没有任何过程损耗。</p><p><strong>因此，现在 <code>Xray</code> 中【完整体的回落功能】，同时具备下述属性：</strong></p><ul><li><strong>安全：</strong> 充分抵御主动探测攻击</li><li><strong>高效：</strong> 几乎毫无性能损失</li><li><strong>灵活：</strong> 数据灵活分流、常用端口复用（如443）</li></ul><div class="notices warning"><p><strong>啰嗦君：</strong> 这样多轮介绍虽然略显繁琐，但只有这样层层深入展开，才能充分的说明【回落の完全体】独有的强大！</p></div></br><h2 ref=5-多层回落示例及解读>5. 多层回落示例及解读</h2><a class=anchor id=5-多层回落示例及解读></a><p>理解了【回落の完全体】是什么，那就可以动手操作配置多层回落了。其实，项目已经提供了非常完整的示例，即官方模板中的 <a href=https://github.com/XTLS/Xray-examples/blob/main/VLESS-TCP-XTLS-WHATEVER/>VLESS-TCP-XTLS-WHATEVER</a>。</p><h4 ref=51-首先我将服务器端配置的-443-监听段摘抄如下>5.1 首先，我将服务器端配置的 443 监听段摘抄如下：</h4><a class=anchor id=51-首先我将服务器端配置的-443-监听段摘抄如下></a><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>{
    &#34;port&#34;: 443,
    &#34;protocol&#34;: &#34;vless&#34;,
    &#34;settings&#34;: {
        &#34;clients&#34;: [
            {
                    &#34;id&#34;: &#34;&#34;, // 填写你的 UUID
                    &#34;flow&#34;: &#34;xtls-rprx-direct&#34;,
                    &#34;level&#34;: 0,
                    &#34;email&#34;: &#34;love@example.com&#34;
            }
        ],
        &#34;decryption&#34;: &#34;none&#34;,
        &#34;fallbacks&#34;: [
            {
                &#34;dest&#34;: 1310, // 默认回落到 Xray 的 Trojan 协议
                &#34;xver&#34;: 1
            },
            {
                &#34;path&#34;: &#34;/websocket&#34;, // 必须换成自定义的 PATH
                &#34;dest&#34;: 1234,
                &#34;xver&#34;: 1
            },
            {
                &#34;path&#34;: &#34;/vmesstcp&#34;, // 必须换成自定义的 PATH
                &#34;dest&#34;: 2345,
                &#34;xver&#34;: 1
            },
            {
                &#34;path&#34;: &#34;/vmessws&#34;, // 必须换成自定义的 PATH
                &#34;dest&#34;: 3456,
                &#34;xver&#34;: 1
            }
        ]
    },
    &#34;streamSettings&#34;: {
        &#34;network&#34;: &#34;tcp&#34;,
        &#34;security&#34;: &#34;xtls&#34;,
        &#34;xtlsSettings&#34;: {
            &#34;alpn&#34;: [
                &#34;http/1.1&#34;
            ],
            &#34;certificates&#34;: [
                {
                    &#34;certificateFile&#34;: &#34;/path/to/fullchain.crt&#34;, // 换成你的证书，绝对路径
                    &#34;keyFile&#34;: &#34;/path/to/private.key&#34; // 换成你的私钥，绝对路径
                }
            ]
        }
    }
},
</code></pre></div><p>这一段配置用人话要怎么解释呢？</p><ol><li><p><font size=4><strong><code>Xray</code> 的入站端口 (<code>inbound port</code>) 是 <code>443</code></strong></font></p><p><font size=2>即由 <code>Xray</code> 负责监听 <code>443</code> 端口的 <code>HTTPS</code> 流量，并使用 <code>certificates</code> 项下设定的 <code>TLS</code> 证书来进行验证</font></p></li><li><p><font size=4><strong><code>Xray</code> 的入站协议 (<code>inbound protocol</code>) 是 <code>vless</code></strong></font></p><p><font size=2><code>vless</code> 协议流量直接流入 <code>Xray</code> 中做后续处理</font></p></li><li><p><font size=4><strong>非 <code>VLESS</code> 协议流量有4个不同的回落目标：</strong></font></p><ol><li><code>path</code> 为 <code>websocket</code> 的流量，回落给端口 <code>1234</code> 后续处理</font></li><li><code>path</code> 为 <code>vmesstcp</code> 的流量，回落给端口 <code>2345</code> 后续处理</font></li><li><code>path</code> 为 <code>vmessws</code> 的流量，回落给端口 <code>3456</code> 后续处理</font></li><li>其它所有流量，回落给端口 <code>1310</code> 后续处理</font></li></ol></li><li><p><font size=4><strong><code>xver</code> 为 <code>1</code> 表示开启 <code>proxy protocol</code> 功能，向后传递来源真实IP</strong></font></p></li><li><p><font size=4><strong>上述回落结构如下图所示：</strong></font></p><script defer src=https://unpkg.com/mermaid@8.8.2/dist/mermaid.min.js>mermaid.initialize({startOnLoad:!0})</script><div class=mermaid align=left>graph LR;
W443(外部 HTTP:443 请求) --> X443(Xray-inbound: 443) .- X1{入站判断}
X1 --> |协议 = VLESS 的流量| X2(Xray内部规则)
X2 --> O(Xray Outbounds 出站)
X1 --> |path = /websocket 的流量| X1234(Xray-inbound:1234)
X1 --> |path = /vmesstcp 的流量| X2345(Xray-inbound:2345)
X1 --> |path = /vmessws 的流量| X3456(Xray-inbound:3456)
X1 --> |其它所有流量| X1310(Xray-inbound:1310)</div></li><li><p><font size=4><strong>网页回落不见了！</strong></font></p><p>没错，聪明的同学应该发现了，防御【主动探测】的 <code>nginx回落</code> 不见了！！！这是为什么呢？会不会不安全？别急，我们继续分析：</p></li></ol></br><h4 ref=52-后续监听处理的配置段摘抄如下>5.2 后续监听处理的配置段摘抄如下：</h4><a class=anchor id=52-后续监听处理的配置段摘抄如下></a><ol><li><p>后续处理回落至 <code>1310</code> 端口的流量，按照下面的配置验证、处理：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>{
    &#34;port&#34;: 1310,
    &#34;listen&#34;: &#34;127.0.0.1&#34;,
    &#34;protocol&#34;: &#34;trojan&#34;,
    &#34;settings&#34;: {
        &#34;clients&#34;: [
            {
                &#34;password&#34;: &#34;&#34;, // 填写你的密码
                &#34;level&#34;: 0,
                &#34;email&#34;: &#34;love@example.com&#34;
            }
        ],
        &#34;fallbacks&#34;: [
            {
                &#34;dest&#34;: 80 // 或者回落到其它也防探测的代理
            }
        ]
    },
    &#34;streamSettings&#34;: {
        &#34;network&#34;: &#34;tcp&#34;,
        &#34;security&#34;: &#34;none&#34;,
        &#34;tcpSettings&#34;: {
            &#34;acceptProxyProtocol&#34;: true
        }
    }
},
</code></pre></div><p>看，神奇的事情发生了， <code>trojan</code> 协议这里又出现了一个新的 <code>fallbacks</code>。前面已经说过，<code>xray</code> 中的 <code>trojan</code> 协议也具有完整的回落能力，所以，此时 <code>trojan</code> 协议可以再次做判断和回落（这也就是传说中的套娃回落了）：</p><ul><li>所有 <code>trojan</code> 协议的流量，流入 <code>Xray</code> 中做后续处理</li><li>所有非 <code>trojan</code> 协议的流量，转发至 <code>80</code> 端口，【主动探测】的防御，完成！</li></ul></li><li><p>后续处理回落至 <code>1234</code> 端口的流量，仔细看！它其实是 <code>vless+ws</code>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>{
    &#34;port&#34;: 1234,
    &#34;listen&#34;: &#34;127.0.0.1&#34;,
    &#34;protocol&#34;: &#34;vless&#34;,
    &#34;settings&#34;: {
        &#34;clients&#34;: [
            {
                &#34;id&#34;: &#34;&#34;, // 填写你的 UUID
                &#34;level&#34;: 0,
                &#34;email&#34;: &#34;love@example.com&#34;
            }
        ],
        &#34;decryption&#34;: &#34;none&#34;
    },
    &#34;streamSettings&#34;: {
        &#34;network&#34;: &#34;ws&#34;,
        &#34;security&#34;: &#34;none&#34;,
        &#34;wsSettings&#34;: {
            &#34;acceptProxyProtocol&#34;: true, // 提醒：若你用 Nginx/Caddy 等反代 WS，需要删掉这行
            &#34;path&#34;: &#34;/websocket&#34; // 必须换成自定义的 PATH，需要和分流的一致
        }
    }
},
</code></pre></div></li><li><p>后续处理回落至 <code>2345</code> 端口的流量，仔细看！它其实是 <code>vmess直连</code>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>{
    &#34;port&#34;: 2345,
    &#34;listen&#34;: &#34;127.0.0.1&#34;,
    &#34;protocol&#34;: &#34;vmess&#34;,
    &#34;settings&#34;: {
        &#34;clients&#34;: [
            {
                &#34;id&#34;: &#34;&#34;, // 填写你的 UUID
                &#34;level&#34;: 0,
                &#34;email&#34;: &#34;love@example.com&#34;
            }
        ]
    },
    &#34;streamSettings&#34;: {
        &#34;network&#34;: &#34;tcp&#34;,
        &#34;security&#34;: &#34;none&#34;,
        &#34;tcpSettings&#34;: {
            &#34;acceptProxyProtocol&#34;: true,
            &#34;header&#34;: {
                &#34;type&#34;: &#34;http&#34;,
                &#34;request&#34;: {
                    &#34;path&#34;: [
                        &#34;/vmesstcp&#34; // 必须换成自定义的 PATH，需要和分流的一致
                    ]
                }
            }
        }
    }
},
</code></pre></div></li><li><p>后续处理回落至 <code>3456</code> 端口的流量，再仔细看！它其实是是 <code>vmess+ws(+cdn)</code>。</p><div class="notices warning"><p><strong>说明：</strong> 你没看错，这就是 v2fly 曾经的推荐组合之一，并可完整支持 <code>CDN</code>。现已加入完美回落套餐哦！</p></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>{
    &#34;port&#34;: 3456,
    &#34;listen&#34;: &#34;127.0.0.1&#34;,
    &#34;protocol&#34;: &#34;vmess&#34;,
    &#34;settings&#34;: {
        &#34;clients&#34;: [
            {
                &#34;id&#34;: &#34;&#34;, // 填写你的 UUID
                &#34;level&#34;: 0,
                &#34;email&#34;: &#34;love@example.com&#34;
            }
        ]
    },
    &#34;streamSettings&#34;: {
        &#34;network&#34;: &#34;ws&#34;,
        &#34;security&#34;: &#34;none&#34;,
        &#34;wsSettings&#34;: {
            &#34;acceptProxyProtocol&#34;: true, // 提醒：若你用 Nginx/Caddy 等反代 WS，需要删掉这行
            &#34;path&#34;: &#34;/vmessws&#34; // 必须换成自定义的 PATH，需要和分流的一致
        }
    }
}
</code></pre></div></li><li><p>至此，我们就能够完整的画出模板的回落路线了：</p><script defer src=https://unpkg.com/mermaid@8.8.2/dist/mermaid.min.js>mermaid.initialize({startOnLoad:!0})</script><div class=mermaid align=left>graph LR;
W443(外部 HTTP:443 请求) --> X443(Xray-inbound: 443) .- X1{入站判断}
X1 --> |协议 = VLESS 的流量| X2(Xray内部规则)
X2 --> XO(Xray Outbounds 出站)
X1 --> |path = /websocket 的流量| X1234(Xray-inbound:1234)
X1 --> |path = /vmesstcp 的流量| X2345(Xray-inbound:2345)
X1 --> |path = /vmessws 的流量| X3456(Xray-inbound:3456)
X1 --> |其它所有流量| X1310(Xray-inbound:1310)
X1234 --> X2
X2345 --> X2
X3456 --> X2
X1310 --> |协议 = trojan 的流量| X2
X1310 --> |其他所有流量| N80(Nginx:80)
N80:::nginxclass --> H(index.html)
H:::nginxclass
classDef nginxclass fill:#FFFFDE</div></li></ol><h2 ref=6-结语>6. 结语</h2><a class=anchor id=6-结语></a><p>至此，<code>Xray</code> 的【回落】功能就介绍完了。希望本文能够对你理解 <code>Xray</code> 的强大有所帮助。</p></br><h2 ref=7-附加题>7. 附加题</h2><a class=anchor id=7-附加题></a><p>我再无耻的留一个附加题：本文详解的 <a href=https://github.com/XTLS/Xray-examples/blob/main/VLESS-TCP-XTLS-WHATEVER/>VLESS-TCP-XTLS-WHATEVER</a> 模板？是否有可以优化的地方？</p><p>提示：HTTP自动跳转HTTPS</p></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;</label><nav><ul><li><a href=/documents/level-1/fallbacks-lv1/>回落 (fallbacks) 功能简析</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#1-回顾小小白白话文中的回落>1. 回顾《小小白白话文》中的回落</a></li><li><a href=#2-重新认识回落-what-how-v1>2. 重新认识回落 (WHAT, HOW <code>v1</code>)</a></li><li><a href=#3-为什么要回落-why-v1>3. 为什么要回落 (WHY <code>v1</code>)</a></li><li><a href=#4-重新认识回落の完全体-what-why-how-v2>4. 重新认识【回落の完全体】 (WHAT, WHY, HOW <code>v2</code>)</a></li><li><a href=#5-多层回落示例及解读>5. 多层回落示例及解读</a><ul><li></li></ul></li><li><a href=#6-结语>6. 结语</a></li><li><a href=#7-附加题>7. 附加题</a></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-1/fallbacks-lv1.md target=blank><i class="fab fa-github"></i></a></li><li><i class="fas fa-calendar"></i>05 January 2021</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>