<!doctype html><html><head><title>路由 (routing) 功能简析（上） :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-02-25T00:45:39 UTC"><meta name=description content="入门心得"><meta name=author content="Project X"><title>路由 (routing) 功能简析（上） :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https://xtls.github.io"</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/documents/level-1/routing-lv1-part1/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https://xtls.github.io"</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/about/>Project X&nbsp;⚡</a><ul><li data-nav-id=https://xtls.github.io/about/new/ class="dd-item
item_level_$level"><a href=/about/new/>大史记&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/guide/>快速入门&nbsp;</a></li><li data-nav-id=https://xtls.github.io/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/config/>配置文件&nbsp;📜</a><ul><li data-nav-id=https://xtls.github.io/config/base/ class="dd-item haschildren
item_level_$level"><a href=/config/base/>基础配置模块&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/config/base/log/ class="dd-item
item_level_$level"><a href=/config/base/log/>日志配置</a></li><li data-nav-id=https://xtls.github.io/config/base/api/ class="dd-item
item_level_$level"><a href=/config/base/api/>API接口</a></li><li data-nav-id=https://xtls.github.io/config/base/dns/ class="dd-item
item_level_$level"><a href=/config/base/dns/>内置DNS服务器</a></li><li data-nav-id=https://xtls.github.io/config/base/routing/ class="dd-item
item_level_$level"><a href=/config/base/routing/>路由</a></li><li data-nav-id=https://xtls.github.io/config/base/policy/ class="dd-item
item_level_$level"><a href=/config/base/policy/>本地策略</a></li><li data-nav-id=https://xtls.github.io/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/transport/ class="dd-item
item_level_$level"><a href=/config/base/transport/>传输方式</a></li><li data-nav-id=https://xtls.github.io/config/base/stats/ class="dd-item
item_level_$level"><a href=/config/base/stats/>统计信息</a></li><li data-nav-id=https://xtls.github.io/config/base/reverse/ class="dd-item
item_level_$level"><a href=/config/base/reverse/>反向代理</a></li></ul></li><li data-nav-id=https://xtls.github.io/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/config/inbound-protocols/>Inbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/config/outbound-protocols/>Outbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/transports/ class="dd-item
item_level_$level"><a href=/config/transports/>传输方式列表</a></li><li data-nav-id=https://xtls.github.io/config/vless/ class="dd-item
item_level_$level"><a href=/config/vless/>VLESS 协议详解</a></li><li data-nav-id=https://xtls.github.io/config/fallback/ class="dd-item
item_level_$level"><a href=/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/config/xtls/ class="dd-item
item_level_$level"><a href=/config/xtls/>XTLS 深度剖析</a></li><li data-nav-id=https://xtls.github.io/config/env/ class="dd-item
item_level_$level"><a href=/config/env/>环境变量</a></li><li data-nav-id=https://xtls.github.io/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/config/multiple_config/>多文件配置</a></li></ul></li><li data-nav-id=https://xtls.github.io/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/documents/>使用心得&nbsp;📚</a><ul><li data-nav-id=https://xtls.github.io/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-0/>小小白白话文&nbsp;📙</a></li><li data-nav-id=https://xtls.github.io/documents/level-1/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/documents/level-1/>入门技巧&nbsp;📚</a></li><li data-nav-id=https://xtls.github.io/documents/level-2/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-2/>进阶文档&nbsp;📘</a></li></ul></li><li data-nav-id=https://xtls.github.io/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/develop/>开发指南&nbsp;🖥️</a><ul><li data-nav-id=https://xtls.github.io/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/intro/>开发手册</a></li><li data-nav-id=https://xtls.github.io/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/protocols/>协议详解</a></li></ul></li><li data-nav-id=https://xtls.github.io/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/faq/>常见问答&nbsp;💬</a></li><li data-nav-id=https://xtls.github.io/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/caseslip/>大案牍术&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/links/ class="dd-item alwaysopen
item_level_$level"><a href=/links/>常用链接&nbsp;🤝</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io></a></li><li><a class=text-link href=/documents/>使用心得</a></li><li><a class=text-link href=/documents/level-1/>入门技巧</a></li><li class=active>路由 (routing) 功能简析（上）</li></ol></nav><h1>入门技巧<span>路由 (routing) 功能简析（上）</span></h1><nav class=subpages><li><a title=$pagetitle href=/documents/level-1/fallbacks-lv1/>回落 (fallbacks) 功能简析&nbsp;📙</a></li><li class=active><a title=$pagetitle href=/documents/level-1/routing-lv1-part1/>路由 (routing) 功能简析（上）&nbsp;📙</a></li><li><a title=$pagetitle href=/documents/level-1/routing-lv1-part2/>路由 (routing) 功能简析（下）&nbsp;📙</a></li><li><a title=$pagetitle href=/documents/level-1/work/>Xray的工作模式</a></li></nav><div class=jump-to-section><span onclick="$h=$(this),$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><span class="fas fa-align-right"></span><i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#1-初识路由三兄弟>1. 初识【路由】三兄弟</a></li><li><a href=#2-基本功-兄弟一条心>2. 基本功： “兄弟一条心”</a></li><li><a href=#3-小试牛刀-三分天下-之-域名分流>3. 小试牛刀： “三分天下” 之 “域名分流”</a><ul><li></li></ul></li><li><a href=#4-三分天下-之-蜀魏争雄>4. “三分天下” 之 “蜀魏争雄”</a></li><li><a href=#5-攻城略池---多种路由匹配条件>5. 攻城略池 - 多种路由匹配条件</a></li></ul></nav></div><div class=content><p>如果说Xray的【强大】主要体现在它极致的速度和广泛的兼容性。那么Xray的【灵活】，则主要应该归功于它巧妙的【路由】功能。本文就稍微说明一下这个功能的逻辑以及使用方式。</p><h2 ref=1-初识路由三兄弟>1. 初识【路由】三兄弟</h2><a class=anchor id=1-初识路由三兄弟></a><p>要理解路由，就要理解完整的路由功能需要有三兄弟来合力完成：1. <strong>入站</strong>；2. <strong>路由</strong>；3. <strong>出站</strong>。</p><img src=../routing-lv1-img01-trio.png alt=路由三兄弟><p>三兄弟桃园结义，不求同年同月同日生，但求同年同月同日死。</p><p>所以谨记：任何一个元素错误，就可能导致路由功能无法正常工作。</p><p>因为路由的灵活性非常高，只看技术文档很容易把自己绕晕，所以本文我们用几个具体的示例来逐层讲解。</p><div class="notices warning"><p><strong>罗嗦君：</strong> 路由功能实在过于灵活，所以本文的示例，都是为了讲解对应的概念，实际使用时请根据自己的需求进行调整。</p></div></br><h2 ref=2-基本功-兄弟一条心>2. 基本功： “兄弟一条心”</h2><a class=anchor id=2-基本功-兄弟一条心></a><p>下图的示例，就是在客户端的 <code>Xray</code> 入站接收APP数据、在路由100%转发给出站，并从出站流向VPS。</p></br><script defer src=https://unpkg.com/mermaid@8.8.2/dist/mermaid.min.js>mermaid.initialize({startOnLoad:!0})</script><div class=mermaid align=left>graph LR;
S(APP数据) .-> I[入站]
subgraph Xray
I --> R[路由] --> O[出站]
end
O .-> V(VPS)
V:::greyclass
S:::greyclass
R:::routingclass
classDef greyclass fill:#C0C0C0
classDef routingclass fill:#FFFFDE</div><p>下面我们来逐个分析：</p></br><p><strong>2.1 入站</strong></p><div class="notices warning"><p><strong>入站：</strong> 就是流量如何流入 <code>Xray</code></p></div><p>下面的入站配置示例，用大白话说就是：数据按照 <code>socks</code> 协议，通过 <code>10808</code> 端口，从本机 <code>127.0.0.1</code> 流入<code>Xray</code>。同时，<code>Xray</code> 将这个入站用 <code>[tag]</code> 命名为 <code>inbound-10808</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>&#34;inbounds&#34;: [
    {
        &#34;tag&#34;: &#34;inbound-10808&#34;,
        &#34;protocol&#34;: &#34;socks&#34;,
        &#34;listen&#34;: &#34;127.0.0.1&#34;,
        &#34;port&#34;: 10808,
        &#34;settings&#34;: {
            &#34;udp&#34;: true
        }
    }
]
</code></pre></div></br><p><strong>2.2 出站</strong></p><div class="notices warning"><p><strong>出站：</strong> 就是流量如何流出 <code>Xray</code></p></div><p>下面的出站配置示例，用大白话说就是：数据按照 <code>VLESS</code> 协议，以 <code>tcp + xtls (direct)</code> 的方式、及其他相关设置，把流量发送给对应的VPS。同时，<code>Xray</code> 将这个出站用 <code>[tag]</code> 命名为 <code>proxy-out-vless</code>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>&#34;outbounds&#34;: [
    {
        &#34;tag&#34;: &#34;proxy-out-vless&#34;,
        &#34;protocol&#34;: &#34;vless&#34;,
        &#34;settings&#34;: {
            &#34;vnext&#34;: [
                {
                    &#34;address&#34;: &#34;a-name.yourdomain.com&#34;,
                    &#34;port&#34;: 443,
                    &#34;users&#34;: [
                        {
                            &#34;id&#34;: &#34;uuiduuid-uuid-uuid-uuid-uuiduuiduuid&#34;,
                            &#34;flow&#34;: &#34;xtls-rprx-direct&#34;,
                            &#34;encryption&#34;: &#34;none&#34;,
                            &#34;level&#34;: 0
                        }
                    ]
                }
            ]
        },
        &#34;streamSettings&#34;: {
            &#34;network&#34;: &#34;tcp&#34;,
            &#34;security&#34;: &#34;xtls&#34;,
            &#34;xtlsSettings&#34;: {
                &#34;serverName&#34;: &#34;a-name.yourdomain.com&#34;
            }
        }
    }
]
</code></pre></div></br><p><strong>2.3 路由</strong></p><div class="notices warning"><p><strong>路由：</strong> 就是把【入站】和【出站】之间的通道，用某种【条件】串联起来</p></div><p>下面的路由配置示例，用大白话说就是：把所有通过 <code>[tag]="inbound-10808"</code> 入站流入 <code>Xray</code> 的流量，<code>100%</code> 全部流转导入 <code>[tag]="proxy-out-vless"</code> 的出站，没有任何分流或其他操作。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>&#34;routing&#34;: {
    &#34;domainStrategy&#34;: &#34;AsIs&#34;,
    &#34;rules&#34;: [
        {
            &#34;type&#34;: &#34;field&#34;,
            &#34;inboundTag&#34;: [
                &#34;inbound-10808&#34;
            ],
            &#34;outboundTag&#34;: &#34;proxy-out-vless&#34;
        }
    ]
}
</code></pre></div><p>至此，我们最开始设计的极简规则【客户端的 <code>Xray</code> 入站接收APP数据、在路由100%转发给出站，并从出站流向VPS】已经完成。</p></br><p><strong>2.4 路由配置项解析之一：流量筛选的依据</strong></p><p>注意观察路由配置，我们可以看到几个新名词：</p><ol><li><code>"domainStrategy": "AsIs"</code></li><li><code>“rules”</code></li><li><code>"type": "field"</code></li><li><code>"inboundTag": ["inbound-10808"]</code></li><li><code>"outboundTag": "proxy-out-vless"</code></li></ol><p>其中 <code>domainStrategy</code> 我们暂且按下不表，先简单说明后面几个：</p><table><thead><tr><th style=text-align:center>配置名称</th><th style=text-align:center>配置值</th><th style=text-align:left>配置说明</th></tr></thead><tbody><tr><td style=text-align:center><code>“rules”</code></td><td style=text-align:center>                                                   </td><td style=text-align:left>它的内层就是【路由规则】的明细设置</td></tr><tr><td style=text-align:center><code>"type"</code></td><td style=text-align:center><code>"field"</code></td><td style=text-align:left>该项暂时没有特别定义，但是不能省略，所以记得写上就好</td></tr><tr><td style=text-align:center><code>"inboundTag"</code></td><td style=text-align:center><code>["inbound-10808"]</code></td><td style=text-align:left>筛选流量的 <strong>【依据】</strong> 是【入站Tag】，具体 <strong>【条件】</strong> 现在只有一个：【入站来源是 <code>inbound-10808</code>】</td></tr><tr><td style=text-align:center><code>"outboundTag"</code></td><td style=text-align:center><code>"proxy-out-vless"</code></td><td style=text-align:left>当上面的筛选条件成立时（即入站<code>[tag]="inbound-10808"</code>时 ），<code>Xray</code> 会将流量导入 <code>[tag]="proxy-out-vless"</code> 的出站</td></tr></tbody></table><p>本例中，我们只有一个入站，它的<code>"inboundTag" = "inbound-10808"</code> 。我们也只有一个出站，它的 <code>[tag]="proxy-out-vless"</code>。所以根据上面这个路由规则，从唯一入站端口 <code>10808</code> 流入<code>Xray</code>的流量，<code>100%</code> 符合筛选条件、会被路由模块选中，然后转发给唯一的出站。</p><p>至此，<strong>入站</strong>、<strong>路由</strong>、<strong>出站</strong> 三兄弟就已经可以携手工作了。当然，现在这个100%转发的工作并没有什么特别的意义。那么接下来，我们就看看这种分工合作的机制可以带来什么好处。</p></br><h2 ref=3-小试牛刀-三分天下-之-域名分流>3. 小试牛刀： “三分天下” 之 “域名分流”</h2><a class=anchor id=3-小试牛刀-三分天下-之-域名分流></a><h4 ref=geositedat><code>[geosite.dat]</code></h4><a class=anchor id=geositedat></a></br><script defer src=https://unpkg.com/mermaid@8.8.2/dist/mermaid.min.js>mermaid.initialize({startOnLoad:!0})</script><div class=mermaid align=left>graph LR;
S(APP数据) .-> I[入站]
subgraph Xray
I --> R[路由] -- "geosite:category-ads-all" --> O1[block]
R[路由] -- "geosite:cn" --> O2[direct]
R[路由] -- "geosite:geolocation-!cn" --> O3[proxy]
end
O2 .-> D(国内服务器)
O3 .-> V(VPS)
O1:::redclass
V:::greyclass
S:::greyclass
R:::routingclass
classDef redclass fill:#FF0000
classDef greyclass fill:#C0C0C0
classDef routingclass fill:#FFFFDE,stroke:#000000</div></br><p>这个配置逻辑，其实就是最简单、最常用的（《小小白白话文》中也在用的）路由配置三件套：</p><ol><li>广告流量屏蔽 <code>[block]</code></li><li>国内流量直连 <code>[direct]</code></li><li>国外流量转发VPS <code>[proxy]</code></li></ol><div class="notices warning"><p><strong>注意：</strong> 小小白白话文中的直连配置是包括【国内域名】、【国内IP】、【本机内部IP】的。这里先讲解【国内域名】。</p></div></br><p><strong>3.1 入站</strong></p><p>保持上例的 <code>inbound-10808</code> 不变。</p></br><p><strong>3.2 出站</strong></p><p>在上例的基础上，我们已经有了 <code>[proxy]</code> 的出站 <code>"proxy-out-vless"</code>，所以它保持不变。显而易见，我们需要加入两个新的出站方式：<code>[block]</code> 和 <code>[direct]</code>，如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>&#34;outbounds&#34;: [
    {
        &#34;tag&#34;: &#34;proxy-out-vless&#34;,
        ......
    },
    {
        &#34;tag&#34;: &#34;block&#34;,
        &#34;protocol&#34;: &#34;blackhole&#34;
    },
    {
        &#34;tag&#34;: &#34;direct-out&#34;,
        &#34;protocol&#34;: &#34;freedom&#34;
    }
]
</code></pre></div><p>上面的配置用大白话翻译如下：</p><ol><li>上例中的 <code>[proxy-out-vless]</code> 出站配置保持不变</li><li>加入 <strong><code>blackhole</code> 黑洞协议</strong>，通过这个协议出站的流量，其实都被发送到了 <code>Xray</code> 内部的黑洞里，再也无法逃脱，于是效果就是屏蔽 <code>[block]</code></li><li>加入 <strong><code>freedom</code> 自由协议</strong>，通过这个协议出站的流量，是自由的离开<code>Xray</code>去寻找原定的服务器，就像从没有来过，于是效果就是直连 <code>[direct]</code> （我这里起名叫做 <code>[direct-out]</code> 是为了强调它是一个出站）</li></ol></br><p><strong>3.3 路由</strong></p><p>接下来就是见证奇迹的时刻了，我们可以用【路由】的配置把这些连接起来！</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>&#34;routing&#34;: {
    &#34;domainStrategy&#34;: &#34;AsIs&#34;,
    &#34;rules&#34;: [
        {
            &#34;type&#34;: &#34;field&#34;,
            &#34;domain&#34;: [
                &#34;geosite:category-ads-all&#34;
            ],
            &#34;outboundTag&#34;: &#34;block&#34;
        },
        {
            &#34;type&#34;: &#34;field&#34;,
            &#34;domain&#34;: [
                &#34;geosite:cn&#34;
            ],
            &#34;outboundTag&#34;: &#34;direct-out&#34;
        },
        {
            &#34;type&#34;: &#34;field&#34;,
            &#34;domain&#34;: [
                &#34;geosite:geolocation-!cn&#34;
            ],
            &#34;outboundTag&#34;: &#34;proxy-out-vless&#34;
        }
    ]
}
</code></pre></div><p>为了理解这个配置文件，我们要稍微解释一下这里出现的几个新配置项：</p><ul><li><code>"domain": ["geosite:category-ads-all"]</code></li><li><code>"domain": ["geosite:cn"]</code></li><li><code>"domain": ["geosite:geolocation-!cn"]</code></li></ul></br><p><strong>3.4 简析域名文件： <code>geosite.dat</code></strong></p><p>其实，聪明的你大概可以通过这些配置项的名称猜出来个大概：</p><ul><li><code>"domain"</code>：就是这次筛选流量的 <strong>【依据】</strong> 是 <strong>【域名】</strong> （而不再是入站tag）</li><li><code>"geosite"</code>：就是 <code>Xray</code> 会去 <code>geosite.dat</code> 文件中寻找 <strong>【符合条件的域名】</strong></li><li><code>"category-ads-all"</code>：就是该文件中的 <strong>【所有广告类域名】</strong></li><li><code>"cn"</code>：就是该文件中的 <strong>【中国域名】</strong></li><li><code>"geolocation-!cn"</code>：就是该文件中的 <strong>【非中国域名】</strong></li></ul><p>结合这些说明，3.3 中的配置用大白话翻译就是：</p><ol><li>APP试图访问国外域名 <code>"domain": "geolocation-!cn"</code> 的流量，通过 <code>[proxy-out-vless]</code> 出站，转发至VPS</li><li>APP试图访问国外域名广告域名 <code>"domain": "geosite:category-ads-all"</code> 的流量，通过 <code>[block]</code> 出站，转发至黑洞进行屏蔽</li><li>APP试图访问国内域名 <code>"domain": "geosite:cn"</code> 的流量，通过 <code>[direct-out]</code> 出站，自由离开完成直连</li></ol><p>这时，才让【路由功能】的好处稍微得到了一些展现。</p></br><p><strong>3.5 所以 <code>geosite.dat</code> 到底是什么？不是有个 <code>GFWList</code> 吗？</strong></p><p>你想，这世界上的域名何止千万，如果我们每写一个基于【域名】匹配的路由规则，都要自己收集、手动输入域名，那效率将会何其低下！</p><p>而如果所有的域名都只有一个种类，<code>[direct], [proxy], [block]</code> 只能三选其一，那又是多么的不方便！</p><p>就如关羽需要他的青龙偃月刀，<code>geosite.dat</code> 文件便作为【路由功能】驱使的神兵利器横空出世了，它致力于为用户提供成熟完善的【域名分类表】。让用户可以简单的通过 <code>geosite:xxx</code> 这种格式方便的调用任何子类，定制符合自身需求的路由规则。</p><p>这种模块化结构提供的灵活性，其实远超传统的一揽子防火墙域名列表 <a href=https://github.com/gfwlist/gfwlist><code>GFWList</code></a>。为什么这么说呢？比如，你可以指定苹果的域名 <code>geosite:apple</code> 和icloud相关域名 <code>geosite:icloud</code> 通过代理 <code>[proxy]</code>，但是苹果的软件域名 <code>geosite:apple-update</code> 保持直连 <code>[direct]</code> 来保持最大下载速度。</p><div class="notices warning"><p><strong>注意：</strong> 现在，<code>geosite.dat</code> 文件其实有多种选择：</p><p>最初，从 <code>Victoria Raymond</code> 主力维护 <code>Project V</code> 项目时期，便提供了最初的配套项目：<a href=https://github.com/v2ray/domain-list-community><code>domain-list-community</code></a>，用来收集、沉淀、分类各种常用的域名类型；</p><p>之后，随着V姐突然消失导致 <code>Project V</code> 的原项目开发陷入停滞，<code>v2fly</code> 社区维护并持续更新了社区版本的 <a href=https://github.com/v2fly/domain-list-community><code>domain-list-community</code></a>；</p><p>同时，<a href=Loyalsoldier>@Loyalsoldier</a> 维护了其个人修改增强的路由规则文件 <a href=https://github.com/Loyalsoldier/v2ray-rules-dat>v2ray-rules-dat</a>，提供了诸多不同的选择和分类逻辑；</p><p>另外，<code>Project X</code> 也计划于未来定制维护更适合 <code>Xray</code> 使用的路由规则文件 <a href=https://github.com/XTLS/Xray-rules-dat>Xray-rules-dat</a>。<del>(你们看，文件夹都建好了，所以快了快了)</del></p><p>甚至，你还可以定制自己的 <code>geosite</code> 文件，外挂给 <code>Xray</code> 使用，但是这个就跑题了，本文不展开。</p><p>如果你发现有些你遇到的域名没有被合理分类，请向上面的项目们提出 <code>issue</code> 甚至提交 <code>Pull Request</code> 吧！社区列表社区维护，人人为我我为人人！</p></div></br><p><strong>3.6 军师锦囊藏奇兵：一条隐藏的路由规则</strong></p><p>事实上，当你认真思考上面的规则，不难发现一个问题，我们的所有规则都只规定了【当入站流量 <strong>符合某种条件时</strong> 应该被转发给哪个出站】，那么，如果 <code>geosite.dat</code> 文件不全面，我们的入站流量【<strong>不符合任何条件时</strong>】，<code>Xray</code> 会怎么处理呢？</p><div class="notices warning"><p><strong>注意：</strong> 如果你认为【不符合条件当然就无法连接啦！】的话，你可要重新思考一下哦。因为只有指定了 <code>[block]</code> 规则，才会被导入到 <code>blackhole</code> 黑洞协议从而阻断连接</p></div><p>事实上，<code>Xray</code> 为了避免路由规则不完全导致的规则混乱，已经贴心的提供了一条隐藏的路由规则：【<strong>当入站流量不符合任何条件时，转发给第一个出站</strong> 】</p><p>这样，就不会有任何流量被漏掉了。所以，你一定要把你最信赖的心腹大将放在【第一条出站】，让它为你守城护池。</p></br><p><strong>3.7 再看“三分天下”的大地图</strong></p><p>因为我们在前面的示例中把 <code>[proxy-out-vless]</code> 放在了出站的第一位，所以隐藏规则生效时，流量会通过 <code>VLESS</code> 协议被转发至远端的VPS。因此，<code>Xray</code> 此时的完整工作逻辑如下：</p><script defer src=https://unpkg.com/mermaid@8.8.2/dist/mermaid.min.js>mermaid.initialize({startOnLoad:!0})</script><div class=mermaid align=left>graph LR;
S(APP数据) .-> I[入站]
subgraph Xray
I --> R[路由] -- "geosite:category-ads-all" --> O1[block]
R[路由] -- "geosite:cn" --> O2[direct]
R[路由] -- "geosite:geolocation-!cn" --> O3[proxy]
R[路由] -. "没有命中规则的流量" .-> O4[第一条出站]
end
O2 .-> D(国内服务器)
O3 .-> V(VPS)
O4 .-> V(VPS)
O1:::redclass
V:::greyclass
S:::greyclass
R:::routingclass
classDef redclass fill:#FF0000
classDef greyclass fill:#C0C0C0
classDef routingclass fill:#FFFFDE,stroke:#000000</div></br><p>事实上，这就是传统所谓的 <strong>【默认科学上网、国内网站白名单直连】</strong> 的配置。</p></br><h2 ref=4-三分天下-之-蜀魏争雄>4. “三分天下” 之 “蜀魏争雄”</h2><a class=anchor id=4-三分天下-之-蜀魏争雄></a><p>现在，你已经知道了隐藏的默认路由规则：【<strong>当入站流量不符合任何条件时，转发给第一个出站</strong> 】。这时候，你应该能看出来，究竟是【科学上网】为王，还是【直连】称霸，全看你的第一条出站是什么！</p><p>上一步我们已经配置出了 <strong>【默认科学上网、国内网站白名单直连】</strong> 的规则。那么现在只要 <strong>【把直连规则放在第一位】</strong>，就立即变成了正好相反的 <strong>【默认直连、国外网站白名单科学上网】</strong> 规则。</p><p>是不是，非常的简单？</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>&#34;outbounds&#34;: [
    {
        &#34;tag&#34;: &#34;direct-out&#34;,
        &#34;protocol&#34;: &#34;freedom&#34;
    },
    {
        &#34;tag&#34;: &#34;proxy-out-vless&#34;,
        ......
    },
    {
        &#34;tag&#34;: &#34;block&#34;,
        &#34;protocol&#34;: &#34;blackhole&#34;
    }
]
</code></pre></div><p>此时，路由规则其实变成了：</p><script defer src=https://unpkg.com/mermaid@8.8.2/dist/mermaid.min.js>mermaid.initialize({startOnLoad:!0})</script><div class=mermaid align=left>graph LR;
S(APP数据) .-> I[入站]
subgraph Xray
I --> R[路由] -- "geosite:category-ads-all" --> O1[block]
R[路由] -- "geosite:geolocation-!cn" --> O3[proxy]
R[路由] -- "geosite:cn" --> O2[direct]
R[路由] -. "没有命中规则的流量" .-> O4[第一条出站]
end
O2 .-> D(国内服务器)
O3 .-> V(VPS)
O4 .-> D
O1:::redclass
V:::greyclass
S:::greyclass
R:::routingclass
classDef redclass fill:#FF0000
classDef greyclass fill:#C0C0C0
classDef routingclass fill:#FFFFDE,stroke:#000000</div><p>这就是路由功能的灵活之处了，你可以自由的改变它的顺序来实现不同的设计。</p><p>至此，我们已经解释完了 <strong>【如何利用 <code>geosite.dat</code> 文件，通过路由规则，根据【域名】来分流网络流量】。</strong></p></br><h2 ref=5-攻城略池---多种路由匹配条件>5. 攻城略池 - 多种路由匹配条件</h2><a class=anchor id=5-攻城略池---多种路由匹配条件></a><p>请确保你已经读懂了上面的内容，因为这样，你就已经理解了【路由】功能的工作逻辑。有了这个基础，我们就可以继续分析【路由】功能更多更详细的配置方式和匹配条件了。</p><p>等你看完后面的内容，就完全可以自由的定制属于自己的路由规则啦！还等什么，让我们一起进入 <a href=../routing-lv1-part2>《路由 (routing) 功能简析（下）》</a> 吧！</p></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;</label><nav><ul><li><a href=/documents/level-1/routing-lv1-part1/>路由 (routing) 功能简析（上）</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#1-初识路由三兄弟>1. 初识【路由】三兄弟</a></li><li><a href=#2-基本功-兄弟一条心>2. 基本功： “兄弟一条心”</a></li><li><a href=#3-小试牛刀-三分天下-之-域名分流>3. 小试牛刀： “三分天下” 之 “域名分流”</a><ul><li></li></ul></li><li><a href=#4-三分天下-之-蜀魏争雄>4. “三分天下” 之 “蜀魏争雄”</a></li><li><a href=#5-攻城略池---多种路由匹配条件>5. 攻城略池 - 多种路由匹配条件</a></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-1/routing-lv1-part1.md target=blank><i class="fab fa-github"></i></a></li><li><i class="fas fa-calendar"></i>05 January 2021</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>