<!doctype html><html><head><title>é€æ˜ä»£ç†é€šè¿‡gidè§„é¿Xrayæµé‡ :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-01-20T15:03:58 UTC"><meta name=description content="Project X çš„æ–‡æ¡£."><meta name=author content="Project X"><title>é€æ˜ä»£ç†é€šè¿‡gidè§„é¿Xrayæµé‡ :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/documents/level-2/iptables_gid/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/about/>Project X&nbsp;âš¡</a><ul><li data-nav-id=https://xtls.github.io/about/new/ class="dd-item
item_level_$level"><a href=/about/new/>å¤§å²è®°&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/guide/>å¿«é€Ÿå…¥é—¨&nbsp;</a></li><li data-nav-id=https://xtls.github.io/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/config/>é…ç½®æ–‡ä»¶&nbsp;ğŸ“œ</a><ul><li data-nav-id=https://xtls.github.io/config/base/ class="dd-item haschildren
item_level_$level"><a href=/config/base/>åŸºç¡€é…ç½®æ¨¡å—&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/config/base/log/ class="dd-item
item_level_$level"><a href=/config/base/log/>æ—¥å¿—é…ç½®</a></li><li data-nav-id=https://xtls.github.io/config/base/api/ class="dd-item
item_level_$level"><a href=/config/base/api/>APIæ¥å£</a></li><li data-nav-id=https://xtls.github.io/config/base/dns/ class="dd-item
item_level_$level"><a href=/config/base/dns/>å†…ç½®DNSæœåŠ¡å™¨</a></li><li data-nav-id=https://xtls.github.io/config/base/routing/ class="dd-item
item_level_$level"><a href=/config/base/routing/>è·¯ç”±</a></li><li data-nav-id=https://xtls.github.io/config/base/policy/ class="dd-item
item_level_$level"><a href=/config/base/policy/>æœ¬åœ°ç­–ç•¥</a></li><li data-nav-id=https://xtls.github.io/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/transport/ class="dd-item
item_level_$level"><a href=/config/base/transport/>ä¼ è¾“æ–¹å¼</a></li><li data-nav-id=https://xtls.github.io/config/base/stats/ class="dd-item
item_level_$level"><a href=/config/base/stats/>ç»Ÿè®¡ä¿¡æ¯</a></li><li data-nav-id=https://xtls.github.io/config/base/reverse/ class="dd-item
item_level_$level"><a href=/config/base/reverse/>åå‘ä»£ç†</a></li></ul></li><li data-nav-id=https://xtls.github.io/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/config/inbound-protocols/>Inbounds å¯ç”¨åè®®åˆ—è¡¨</a></li><li data-nav-id=https://xtls.github.io/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/config/outbound-protocols/>Outbounds å¯ç”¨åè®®åˆ—è¡¨</a></li><li data-nav-id=https://xtls.github.io/config/transports/ class="dd-item
item_level_$level"><a href=/config/transports/>ä¼ è¾“æ–¹å¼åˆ—è¡¨</a></li><li data-nav-id=https://xtls.github.io/config/vless/ class="dd-item
item_level_$level"><a href=/config/vless/>VLESS åè®®è¯¦è§£</a></li><li data-nav-id=https://xtls.github.io/config/fallback/ class="dd-item
item_level_$level"><a href=/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/config/xtls/ class="dd-item
item_level_$level"><a href=/config/xtls/>XTLS æ·±åº¦å‰–æ</a></li><li data-nav-id=https://xtls.github.io/config/env/ class="dd-item
item_level_$level"><a href=/config/env/>ç¯å¢ƒå˜é‡</a></li><li data-nav-id=https://xtls.github.io/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/config/multiple_config/>å¤šæ–‡ä»¶é…ç½®</a></li></ul></li><li data-nav-id=https://xtls.github.io/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/documents/>ä½¿ç”¨å¿ƒå¾—&nbsp;ğŸ“š</a><ul><li data-nav-id=https://xtls.github.io/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-0/>å°å°ç™½ç™½è¯æ–‡&nbsp;ğŸ“™</a></li><li data-nav-id=https://xtls.github.io/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-1/>å…¥é—¨æŠ€å·§&nbsp;ğŸ“š</a></li><li data-nav-id=https://xtls.github.io/documents/level-2/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/documents/level-2/>è¿›é˜¶æ–‡æ¡£&nbsp;ğŸ“˜</a></li></ul></li><li data-nav-id=https://xtls.github.io/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/develop/>å¼€å‘æŒ‡å—&nbsp;ğŸ–¥ï¸</a><ul><li data-nav-id=https://xtls.github.io/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/intro/>å¼€å‘æ‰‹å†Œ</a></li><li data-nav-id=https://xtls.github.io/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/protocols/>åè®®è¯¦è§£</a></li></ul></li><li data-nav-id=https://xtls.github.io/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/faq/>å¸¸è§é—®ç­”&nbsp;ğŸ’¬</a></li><li data-nav-id=https://xtls.github.io/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/caseslip/>å¤§æ¡ˆç‰æœ¯&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/links/ class="dd-item alwaysopen
item_level_$level"><a href=/links/>å¸¸ç”¨é“¾æ¥&nbsp;ğŸ¤</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io></a></li><li><a class=text-link href=/documents/>ä½¿ç”¨å¿ƒå¾—</a></li><li><a class=text-link href=/documents/level-2/>è¿›é˜¶æ–‡æ¡£</a></li><li class=active>é€æ˜ä»£ç†é€šè¿‡gidè§„é¿Xrayæµé‡</li></ol></nav><h1>è¿›é˜¶æ–‡æ¡£<span>é€æ˜ä»£ç†é€šè¿‡gidè§„é¿Xrayæµé‡</span></h1><nav class=subpages><li><a title=$pagetitle href=/documents/level-2/transparent_proxy/transparent_proxy/>é€æ˜ä»£ç†å…¥é—¨</a></li><li><a title=$pagetitle href=/documents/level-2/tproxy/>é€æ˜ä»£ç†ï¼ˆTProxyï¼‰é…ç½®æ•™ç¨‹</a></li><li class=active><a title=$pagetitle href=/documents/level-2/iptables_gid/>é€æ˜ä»£ç†é€šè¿‡gidè§„é¿Xrayæµé‡</a></li></nav><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span><i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#æ€è·¯>æ€è·¯</a></li><li><a href=#é…ç½®è¿‡ç¨‹>é…ç½®è¿‡ç¨‹</a><ul><li><a href=#1-å‰æœŸå‡†å¤‡>1. å‰æœŸå‡†å¤‡</a></li><li><a href=#2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥>2. æ·»åŠ ç”¨æˆ·(å®‰å“ç”¨æˆ·è¯·å¿½ç•¥)</a></li><li><a href=#3-é…ç½®è¿è¡Œxrayé…ç½®iptablesè§„åˆ™>3. é…ç½®è¿è¡ŒXrayï¼Œé…ç½®iptablesè§„åˆ™</a></li></ul></li><li><a href=#ä¸‹é¢æä¾›ä¸€ä¸ªå®ç°tproxyå…¨å±€ä»£ç†çš„å®Œæ•´é…ç½®è¿‡ç¨‹>ä¸‹é¢æä¾›ä¸€ä¸ªå®ç°tproxyå…¨å±€ä»£ç†çš„å®Œæ•´é…ç½®è¿‡ç¨‹</a><ul><li><a href=#1-å®Œæˆ-å‰æœŸå‡†å¤‡1-å‰æœŸå‡†å¤‡-å’Œ-æ·»åŠ ç”¨æˆ·2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥>1. å®Œæˆ <strong><a href=#1-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87>å‰æœŸå‡†å¤‡</a></strong> å’Œ <strong><a href=#2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%AE%89%E5%8D%93%E7%94%A8%E6%88%B7%E8%AF%B7%E5%BF%BD%E7%95%A5>æ·»åŠ ç”¨æˆ·</a></strong></a></li><li><a href=#2-å‡†å¤‡xrayé…ç½®æ–‡ä»¶>2. å‡†å¤‡Xrayé…ç½®æ–‡ä»¶</a></li><li><a href=#3-é…ç½®æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°è¿è¡Œxrayå®¢æˆ·ç«¯>3. é…ç½®æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°&è¿è¡ŒXrayå®¢æˆ·ç«¯</a></li><li><a href=#4-è®¾ç½®iptablesè§„åˆ™>4. è®¾ç½®iptablesè§„åˆ™</a></li></ul></li></ul></nav></div><div class=content><p>åœ¨ç°æœ‰çš„iptablesé€æ˜ä»£ç†ç™½è¯æ–‡(<strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>æ–° V2Ray ç™½è¯æ–‡æŒ‡å—-é€æ˜ä»£ç†</a></strong> ã€ <strong><a href=https://guide.v2fly.org/app/tproxy.html>æ–° V2Ray ç™½è¯æ–‡æŒ‡å—-é€æ˜ä»£ç†(TPROXY)</a></strong> ã€ <strong><a href=../tproxy>é€æ˜ä»£ç†ï¼ˆTProxyï¼‰é…ç½®æ•™ç¨‹</a></strong>)æ•™ç¨‹ä¸­ï¼Œå¯¹Xrayæµé‡çš„è§„é¿å¤„ç†æ˜¯æ‰“markå®ç°çš„ã€‚å³å¯¹Xrayå‡ºç«™æµé‡æ‰“markï¼Œé€šè¿‡è®¾ç½®iptablesè§„åˆ™å¯¹å¯¹åº”markçš„æµé‡ç›´è¿ï¼Œæ¥è§„é¿Xrayæµé‡ï¼Œé˜²æ­¢å›ç¯ã€‚</p><p>è¿™ä¹ˆåšæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li><p><strong><a href=https://github.com/v2ray/v2ray-core/issues/2621>è«åæµé‡è¿›å…¥PREROUTINGé“¾</a></strong></p></li><li><p>å®‰å“ç³»ç»Ÿæœ‰è‡ªå·±çš„markæœºåˆ¶ï¼Œè¯¥æ–¹æ¡ˆåœ¨å®‰å“ä¸Šä¸å¯ç”¨</p></li></ol><p>æœ¬æ•™ç¨‹çš„æ–¹æ¡ˆä¸éœ€è¦è®¾ç½®markï¼Œç†è®ºæ€§èƒ½æ›´é«˜ï¼ŒåŒæ—¶ä¹Ÿä¸å­˜åœ¨ä¸Šè¿°é—®é¢˜ã€‚</p><h2 ref=æ€è·¯>æ€è·¯</h2><a class=anchor id=æ€è·¯></a><p>tproxyæµé‡åªèƒ½è¢«rootæƒé™ç”¨æˆ·(uid==0)æˆ–å…¶ä»–æœ‰CAP_NET_ADMINæƒé™çš„ç”¨æˆ·æ¥æ”¶ã€‚</p><p>iptablesè§„åˆ™å¯ä»¥é€šè¿‡uid(ç”¨æˆ·id)å’Œgid(ç”¨æˆ·ç»„id)åˆ†æµã€‚</p><p>è®©Xrayè¿è¡Œåœ¨ä¸€ä¸ªuid==0ä½†gid!=0çš„ç”¨æˆ·ä¸Šï¼Œè®¾ç½®iptablesè§„åˆ™ä¸ä»£ç†è¯¥gidçš„æµé‡æ¥è§„é¿Xrayæµé‡ã€‚</p><h2 ref=é…ç½®è¿‡ç¨‹>é…ç½®è¿‡ç¨‹</h2><a class=anchor id=é…ç½®è¿‡ç¨‹></a><h3 ref=1-å‰æœŸå‡†å¤‡>1. å‰æœŸå‡†å¤‡</h3><a class=anchor id=1-å‰æœŸå‡†å¤‡></a><p><strong>å®‰å“ç³»ç»Ÿ</strong></p><ol><li><p>ç³»ç»Ÿå·²root</p></li><li><p>å®‰è£… <strong><a href="https://play.google.com/store/apps/details?id=stericson.busybox">busybox</a></strong></p></li><li><p>æœ‰ä¸€ä¸ªå¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ç»ˆç«¯ï¼Œå¯ä»¥ä½¿ç”¨adb shellï¼Œtermuxç­‰ã€‚</p></li></ol><p><strong>å…¶å®ƒLinuxç³»ç»Ÿ</strong></p><p>éœ€è¦ä¾èµ–sudoï¼Œiptablesçš„tproxyæ¨¡å—å’Œextraæ¨¡å—ã€‚</p><p>ä¸€èˆ¬ç³»ç»Ÿéƒ½æœ‰è‡ªå¸¦ï¼Œopenwrtè¿è¡Œï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>opkg install sudo iptables-mod-tproxy iptables-mod-extra
</code></pre></div><p>å¦é™„ä¸Šä¸€äº›openwrtå¸¸ç”¨çš„ä¾èµ–ï¼Œç¼ºå°‘å¯èƒ½å¯¼è‡´Xrayæ— æ³•è¿è¡Œ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>opkg install libopenssl ca-certificates
</code></pre></div><h3 ref=2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥>2. æ·»åŠ ç”¨æˆ·(å®‰å“ç”¨æˆ·è¯·å¿½ç•¥)</h3><a class=anchor id=2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥></a><p>å®‰å“ç³»ç»Ÿä¸æ”¯æŒ/etc/passwdæ–‡ä»¶æ¥ç®¡ç†ç”¨æˆ·ï¼Œè¯·å¿½ç•¥ï¼Œç›´æ¥ä¸‹ä¸€æ­¥ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>grep -qw xray_tproxy /etc/passwd <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#34;xray_tproxy:x:0:23333:::&#34;</span> &gt;&gt; /etc/passwd
</code></pre></div><p>å…¶ä¸­xray_tproxyæ˜¯ç”¨æˆ·åï¼Œ0æ˜¯uidï¼Œ23333æ˜¯gidï¼Œç”¨æˆ·åå’Œgidå¯ä»¥è‡ªå·±å®šï¼Œuidå¿…é¡»ä¸º0ã€‚
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ·»åŠ æˆåŠŸï¼Œè¿è¡Œ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo -u xray_tproxy id
</code></pre></div><p>æ˜¾ç¤ºçš„ç»“æœåº”è¯¥æ˜¯uidä¸º0ï¼Œgidä¸º23333</p><h3 ref=3-é…ç½®è¿è¡Œxrayé…ç½®iptablesè§„åˆ™>3. é…ç½®è¿è¡ŒXrayï¼Œé…ç½®iptablesè§„åˆ™</h3><a class=anchor id=3-é…ç½®è¿è¡Œxrayé…ç½®iptablesè§„åˆ™></a><p>åœ¨ç°æœ‰çš„iptablesé€æ˜ä»£ç†ç™½è¯æ–‡(<strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>æ–° V2Ray ç™½è¯æ–‡æŒ‡å—-é€æ˜ä»£ç†</a></strong> ã€ <strong><a href=https://guide.v2fly.org/app/tproxy.html>æ–° V2Ray ç™½è¯æ–‡æŒ‡å—-é€æ˜ä»£ç†(TPROXY)</a></strong> ã€ <strong><a href=../tproxy>é€æ˜ä»£ç†ï¼ˆTProxyï¼‰é…ç½®æ•™ç¨‹</a></strong>)æ•™ç¨‹çš„åŸºç¡€ä¸Šä¿®æ”¹ï¼š</p><ol><li><p>ä¿®æ”¹jsoné…ç½®æ–‡ä»¶ï¼Œåˆ é™¤markç›¸å…³å†…å®¹</p></li><li><p>ä¿®æ”¹iptablesè§„åˆ™ï¼Œåˆ é™¤markç›¸å…³å†…å®¹ï¼Œå¹¶åœ¨OUTPUTé“¾åº”ç”¨è§„åˆ™å¤„æ·»åŠ é€‰é¡¹"-m owner ! &ndash;gid-owner 23333"ã€‚</p></li></ol><p>å¦‚ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>iptables -t mangle -A OUTPUT -j XRAY_SELF
</code></pre></div><p>æ”¹ä¸º</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>iptables -t mangle -A OUTPUT -m owner ! --gid-owner <span style=color:#ae81ff>23333</span> -j XRAY_SELF
</code></pre></div><ol start=3><li>ä¿®æ”¹è¿è¡ŒXrayçš„æ–¹å¼ï¼Œä½¿å…¶è¿è¡Œåœ¨uidä¸º0ï¼Œgidä¸º23333çš„ç”¨æˆ·ä¸Šï¼Œå‚è€ƒ<a href=#3-%E9%85%8D%E7%BD%AE%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%A7%E5%BC%80%E6%95%B0%E8%BF%90%E8%A1%8Cxray%E5%AE%A2%E6%88%B7%E7%AB%AF>è¿™é‡Œ</a>ã€‚</li></ol><h2 ref=ä¸‹é¢æä¾›ä¸€ä¸ªå®ç°tproxyå…¨å±€ä»£ç†çš„å®Œæ•´é…ç½®è¿‡ç¨‹>ä¸‹é¢æä¾›ä¸€ä¸ªå®ç°tproxyå…¨å±€ä»£ç†çš„å®Œæ•´é…ç½®è¿‡ç¨‹</h2><a class=anchor id=ä¸‹é¢æä¾›ä¸€ä¸ªå®ç°tproxyå…¨å±€ä»£ç†çš„å®Œæ•´é…ç½®è¿‡ç¨‹></a><h3 ref=1-å®Œæˆ-å‰æœŸå‡†å¤‡1-å‰æœŸå‡†å¤‡-å’Œ-æ·»åŠ ç”¨æˆ·2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥>1. å®Œæˆ <strong><a href=#1-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87>å‰æœŸå‡†å¤‡</a></strong> å’Œ <strong><a href=#2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%AE%89%E5%8D%93%E7%94%A8%E6%88%B7%E8%AF%B7%E5%BF%BD%E7%95%A5>æ·»åŠ ç”¨æˆ·</a></strong></h3><a class=anchor id=1-å®Œæˆ-å‰æœŸå‡†å¤‡1-å‰æœŸå‡†å¤‡-å’Œ-æ·»åŠ ç”¨æˆ·2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥></a><h3 ref=2-å‡†å¤‡xrayé…ç½®æ–‡ä»¶>2. å‡†å¤‡Xrayé…ç½®æ–‡ä»¶</h3><a class=anchor id=2-å‡†å¤‡xrayé…ç½®æ–‡ä»¶></a><p>é…ç½®Xrayä»»æ„é—¨ç›‘å¬12345ï¼Œå¼€å¯followRedirectå’Œtproxyï¼Œä¸éœ€è¦è®¾ç½®sniffingï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;inbounds&#34;</span>: [
    {
      <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>12345</span>,
      <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dokodemo-door&#34;</span>,
      <span style=color:#f92672>&#34;settings&#34;</span>: {
        <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp,udp&#34;</span>,
        <span style=color:#f92672>&#34;followRedirect&#34;</span>: <span style=color:#66d9ef>true</span>
      },
      <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
        <span style=color:#f92672>&#34;sockopt&#34;</span>: {
          <span style=color:#f92672>&#34;tproxy&#34;</span>: <span style=color:#e6db74>&#34;tproxy&#34;</span>
        }
      }
    }
  ],
  <span style=color:#f92672>&#34;outbounds&#34;</span>: [
    {
       <span style=color:#960050;background-color:#1e0010>ä½ çš„æœåŠ¡å™¨é…ç½®</span>
    }
  ]
}
</code></pre></div><h3 ref=3-é…ç½®æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°è¿è¡Œxrayå®¢æˆ·ç«¯>3. é…ç½®æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°&è¿è¡ŒXrayå®¢æˆ·ç«¯</h3><a class=anchor id=3-é…ç½®æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°è¿è¡Œxrayå®¢æˆ·ç«¯></a><p>å…³äºæœ€å¤§æ–‡ä»¶å¤§å¼€æ•°é—®é¢˜è§ï¼š <strong><a href=https://guide.v2fly.org/app/tproxy.html#%E8%A7%A3%E5%86%B3-too-many-open-files-%E9%97%AE%E9%A2%98>too many open files é—®é¢˜</a></strong></p><p>ç›®å‰XrayæœåŠ¡ç«¯ä½¿ç”¨å®˜æ–¹è„šæœ¬å®‰è£…çš„å·²ç»è‡ªåŠ¨é…ç½®äº†æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°ï¼Œæ— éœ€å†ä¿®æ”¹ã€‚</p><p><strong>å®‰å“ç³»ç»Ÿ</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ulimit -SHn <span style=color:#ae81ff>1000000</span>
setuidgid 0:23333 <span style=color:#e6db74>&#34;è¿è¡ŒXrayçš„å‘½ä»¤&#34;</span>&amp;
</code></pre></div><p><strong>å…¶å®ƒLinuxç³»ç»Ÿ</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ulimit -SHn <span style=color:#ae81ff>1000000</span>
sudo -u xray_tproxy <span style=color:#e6db74>&#34;è¿è¡ŒXrayçš„å‘½ä»¤&#34;</span>&amp;
</code></pre></div><p><em>ç¬¬ä¸€æ¡å‘½ä»¤ï¼š</em></p><p>æ”¹å˜æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°ï¼Œåªå¯¹å½“å‰ç»ˆç«¯æœ‰æ•ˆï¼Œæ¯æ¬¡å¯åŠ¨Xrayå‰éƒ½è¦è¿è¡Œï¼Œè¯¥å‘½ä»¤æ˜¯è®¾ç½®å®¢æˆ·ç«¯çš„æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°</p><p><em>ç¬¬äºŒæ¡å‘½ä»¤ï¼š</em></p><p>ä»¥uidä¸º0ï¼Œgidä¸ä¸º0çš„ç”¨æˆ·æ¥è¿è¡ŒXrayå®¢æˆ·ç«¯ï¼Œåé¢åŠ &ä»£è¡¨æ”¾åœ¨åå°è¿è¡Œ</p><p><strong>æ£€æŸ¥æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°æ˜¯å¦è®¾ç½®æˆåŠŸ</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>cat /proc/Xrayçš„pid/limits
</code></pre></div><p>æ‰¾åˆ°max open filesä¸€é¡¹ï¼Œåº”è¯¥æ˜¯ä½ è®¾ç½®çš„æ•°å€¼ã€‚pidçš„è·å–æ–¹æ³•ä¸ºè¿è¡Œ<code>ps</code>æˆ–<code>ps -aux</code>æˆ–<code>ps -a</code></p><p>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½è¦æ£€æŸ¥</p><h3 ref=4-è®¾ç½®iptablesè§„åˆ™>4. è®¾ç½®iptablesè§„åˆ™</h3><a class=anchor id=4-è®¾ç½®iptablesè§„åˆ™></a><p><strong>ä»£ç†ipv4</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>

<span style=color:#75715e># ä»£ç†å±€åŸŸç½‘è®¾å¤‡</span>
iptables -t mangle -N XRAY
<span style=color:#75715e>#  &#34;ç½‘å…³æ‰€åœ¨ipv4ç½‘æ®µ&#34; é€šè¿‡è¿è¡Œå‘½ä»¤&#34;ip address | grep -w inet | awk &#39;{print $2}&#39;&#34;è·å¾—ï¼Œä¸€èˆ¬æœ‰å¤šä¸ª</span>
iptables -t mangle -A XRAY -d ç½‘å…³æ‰€åœ¨ipv4ç½‘æ®µ1 -j RETURN
iptables -t mangle -A XRAY -d ç½‘å…³æ‰€åœ¨ipv4ç½‘æ®µ2 -j RETURN
...

<span style=color:#75715e># ç»„æ’­åœ°å€ç›´è¿</span>
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN

<span style=color:#75715e>#å¦‚æœç½‘å…³ä½œä¸ºä¸»è·¯ç”±ï¼Œåˆ™åŠ ä¸Šè¿™ä¸€å¥ï¼Œè§ï¼šhttps://xtls.github.io/documents/level-2/transparent_proxy/transparent_proxy.md#iptablesé€æ˜ä»£ç†çš„å…¶å®ƒæ³¨æ„äº‹é¡¹</span>
<span style=color:#75715e>#ç½‘å…³LAN_IPv4åœ°å€æ®µï¼Œè¿è¡Œå‘½ä»¤&#34;ip address | grep -w &#34;inet&#34; | awk &#39;{print $2}&#39;&#34;è·å¾—ï¼Œæ˜¯å…¶ä¸­çš„ä¸€ä¸ª</span>
iptables -t mangle -A XRAY ! -s ç½‘å…³LAN_IPv4åœ°å€æ®µ -j RETURN

<span style=color:#75715e># ç»™ TCP æ‰“æ ‡è®° 1ï¼Œè½¬å‘è‡³ 12345 ç«¯å£</span>
<span style=color:#75715e># markåªæœ‰è®¾ç½®ä¸º1ï¼Œæµé‡æ‰èƒ½è¢«Xrayä»»æ„é—¨æ¥å—</span>
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
<span style=color:#75715e># åº”ç”¨è§„åˆ™</span>
iptables -t mangle -A PREROUTING -j XRAY

<span style=color:#75715e># ä»£ç†ç½‘å…³æœ¬æœº</span>
iptables -t mangle -N XRAY_MASK
iptables -t mangle -A XRAY_MASK -m owner --gid-owner <span style=color:#ae81ff>23333</span> -j RETURN
iptables -t mangle -A XRAY_MASK -d ç½‘å…³æ‰€åœ¨ipv4ç½‘æ®µ1 -j RETURN
iptables -t mangle -A XRAY_MASK -d ç½‘å…³æ‰€åœ¨ipv4ç½‘æ®µ2 -j RETURN
...
iptables -t mangle -A XRAY_MASK -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_MASK -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A OUTPUT -p tcp -j XRAY_MASK
iptables -t mangle -A OUTPUT -p udp -j XRAY_MASK
</code></pre></div><p><strong>ä»£ç†ipv6(å¯é€‰)</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip -6 rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>106</span>
ip -6 route add local ::/0 dev lo table <span style=color:#ae81ff>106</span>

<span style=color:#75715e># ä»£ç†å±€åŸŸç½‘è®¾å¤‡</span>
ip6tables -t mangle -N XRAY6
<span style=color:#75715e># &#34;ç½‘å…³æ‰€åœ¨ip6ç½‘æ®µ&#34; é€šè¿‡è¿è¡Œå‘½ä»¤&#34;ip address | grep -w inet6 | awk &#39;{print $2}&#39;&#34;è·å¾—ã€‚</span>
ip6tables -t mangle -A XRAY6 -d ç½‘å…³æ‰€åœ¨ipv6ç½‘æ®µ1 -j RETURN
ip6tables -t mangle -A XRAY6 -d ç½‘å…³æ‰€åœ¨ipv6ç½‘æ®µ2 -j RETURN
...

<span style=color:#75715e># å¦‚æœç½‘å…³ä½œä¸ºä¸»è·¯ç”±ï¼Œåˆ™åŠ ä¸Šè¿™ä¸€å¥ï¼Œè§ï¼šhttps://xtls.github.io/documents/level-2/transparent_proxy/transparent_proxy.md#iptablesé€æ˜ä»£ç†çš„å…¶å®ƒæ³¨æ„äº‹é¡¹</span>
<span style=color:#75715e># ç½‘å…³LAN_IPv6åœ°å€æ®µï¼Œè¿è¡Œå‘½ä»¤&#34;ip address | grep -w &#34;inet6&#34; | awk &#39;{print $2}&#39;&#34;è·å¾—ï¼Œæ˜¯å…¶ä¸­çš„ä¸€ä¸ª</span>
ip6tables -t mangle -A XRAY6 ! -s ç½‘å…³LAN_IPv6åœ°å€æ®µ -j RETURN

ip6tables -t mangle -A XRAY6 -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A XRAY6 -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A PREROUTING -j XRAY6

<span style=color:#75715e># ä»£ç†ç½‘å…³æœ¬æœº</span>
ip6tables -t mangle -N XRAY6_MASK
ip6tables -t mangle -A XRAY6_MASK -m owner --gid-owner <span style=color:#ae81ff>23333</span> -j RETURN
ip6tables -t mangle -A XRAY6_MASK -d ç½‘å…³æ‰€åœ¨ipv6ç½‘æ®µ1 -j RETURN
ip6tables -t mangle -A XRAY6_MASK -d ç½‘å…³æ‰€åœ¨ipv6ç½‘æ®µ2 -j RETURN
...
ip6tables -t mangle -A XRAY6_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A OUTPUT -p tcp -j XRAY6_MASK
ip6tables -t mangle -A OUTPUT -p udp -j XRAY6_MASK
</code></pre></div></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;</label><nav><ul><li><a href=/documents/level-2/iptables_gid/>é€æ˜ä»£ç†é€šè¿‡gidè§„é¿Xrayæµé‡</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#æ€è·¯>æ€è·¯</a></li><li><a href=#é…ç½®è¿‡ç¨‹>é…ç½®è¿‡ç¨‹</a><ul><li><a href=#1-å‰æœŸå‡†å¤‡>1. å‰æœŸå‡†å¤‡</a></li><li><a href=#2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥>2. æ·»åŠ ç”¨æˆ·(å®‰å“ç”¨æˆ·è¯·å¿½ç•¥)</a></li><li><a href=#3-é…ç½®è¿è¡Œxrayé…ç½®iptablesè§„åˆ™>3. é…ç½®è¿è¡ŒXrayï¼Œé…ç½®iptablesè§„åˆ™</a></li></ul></li><li><a href=#ä¸‹é¢æä¾›ä¸€ä¸ªå®ç°tproxyå…¨å±€ä»£ç†çš„å®Œæ•´é…ç½®è¿‡ç¨‹>ä¸‹é¢æä¾›ä¸€ä¸ªå®ç°tproxyå…¨å±€ä»£ç†çš„å®Œæ•´é…ç½®è¿‡ç¨‹</a><ul><li><a href=#1-å®Œæˆ-å‰æœŸå‡†å¤‡1-å‰æœŸå‡†å¤‡-å’Œ-æ·»åŠ ç”¨æˆ·2-æ·»åŠ ç”¨æˆ·å®‰å“ç”¨æˆ·è¯·å¿½ç•¥>1. å®Œæˆ <strong><a href=#1-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87>å‰æœŸå‡†å¤‡</a></strong> å’Œ <strong><a href=#2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%AE%89%E5%8D%93%E7%94%A8%E6%88%B7%E8%AF%B7%E5%BF%BD%E7%95%A5>æ·»åŠ ç”¨æˆ·</a></strong></a></li><li><a href=#2-å‡†å¤‡xrayé…ç½®æ–‡ä»¶>2. å‡†å¤‡Xrayé…ç½®æ–‡ä»¶</a></li><li><a href=#3-é…ç½®æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°è¿è¡Œxrayå®¢æˆ·ç«¯>3. é…ç½®æœ€å¤§æ–‡ä»¶å¤§å¼€æ•°&è¿è¡ŒXrayå®¢æˆ·ç«¯</a></li><li><a href=#4-è®¾ç½®iptablesè§„åˆ™>4. è®¾ç½®iptablesè§„åˆ™</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-2/iptables_gid.md target=blank><i class="fab fa-github"></i></a></li><li><i class="fas fa-calendar"></i>23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>