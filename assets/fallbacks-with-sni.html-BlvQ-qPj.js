import{_ as p,r as o,o as l,c as r,a,b as n,d as s,e as t}from"./app-D67lhmby.js";const c="/assets/xray-fallbacks-gLm6MqAx.svg",d="/assets/xray-dns-records-lpau4JTO.webp",u="/assets/cf-api-token-permissions-for-acme-BmGfLU86.webp",v={},h=n("h1",{id:"implementing-camouflage-and-domain-based-routing-through-sni-fallback-function",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#implementing-camouflage-and-domain-based-routing-through-sni-fallback-function"},[n("span",null,"Implementing camouflage and domain-based routing through SNI fallback function")])],-1),m=t(`<p>VLESS is a lightweight protocol that, like Trojan, does not perform complex encryption and obfuscation on traffic. Instead, it is encrypted through the TLS protocol and mixed in with other HTTPS traffic, making it difficult to detect. In order to better disguise itself and respond to active probing, the fallback function appeared with VLESS at the same time. This tutorial will demonstrate how to use the fallback function of VLESS inbound protocol in Xray, combined with Nginx or Caddy, to achieve domain name-based traffic routing while ensuring complete disguise.</p><h2 id="application-scenarios" tabindex="-1"><a class="header-anchor" href="#application-scenarios"><span>Application Scenarios</span></a></h2><p>Due to XTLS, Xray needs to listen on port 443, which means that if there is a website running on the server, it cannot run or needs to run on another port, which is obviously unreasonable. There are three solutions to this problem:</p><ul><li>Xray monitors other commonly used ports (such as 22, 3389, 8443).</li></ul><p>This plan is the simplest, but not perfect enough.</p><ul><li>Nginx or HAProxy listens on port 443, uses SNI for L4 load balancing, and achieves port multiplexing through reverse proxy.</li></ul><p>This plan is relatively complicated and requires some understanding of using Nginx or HAProxy. We will not explain it in too much detail here.</p><ul><li>Xray listens on port 443, and uses Fallbacks feature to split website traffic based on SNI and fallbacks it to Nginx or Caddy.</li></ul><p>This plan has a moderate level of difficulty and is the scheme that this tutorial will demonstrate next.</p><h2 id="introduction-to-sni" tabindex="-1"><a class="header-anchor" href="#introduction-to-sni"><span>Introduction to SNI</span></a></h2><p>Server Name Indication (SNI) is an extension protocol of TLS. Friends who are familiar with reverse proxies know that the following configuration is required if you want to proxy traffic to the correct content through a domain name:</p><div class="language-nginx line-numbers-mode" data-ext="nginx" data-title="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_set_header</span> Host hostname</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>(Note: &quot;hostname&quot; should be replaced with the actual hostname.)</p><p>This sentence sets the HTTP Header named &quot;Host&quot; to a certain hostname. Why do we need to do this? Generally, one server corresponds to one IP address, but it runs multiple websites. Visitors access the server by querying the IP address via domain name to visit the website. Then the question arises, how to determine which website the visitor wants to access? This requires &quot;name-based virtual hosting&quot;.</p><p>When a Web server receives a request, it looks at the host header to direct the visitor to the correct website. However, this simple method cannot be used when HTTP protocol is encrypted by TLS protocol. This is because the TLS handshake occurs before the server sees any HTTP headers, so the server cannot use the information in the HTTP host header to determine which certificate to present or which destination the visitor wants to access.</p><p>The principle of SNI is also very simple. It solves the problem by allowing the client to send the hostname as part of the TLS negotiation. Therefore, when using Nginx to reverse proxy the HTTPS protocol, you need to add <code>proxy_ssl_server_name on;</code> to the configuration. At this time, Nginx will send SNI information to the proxied server, solving the problem of virtual host failure under the HTTPS protocol. In addition, when using SNI, even if the host header is not specified, the website can be accessed correctly.</p><h2 id="idea" tabindex="-1"><a class="header-anchor" href="#idea"><span>Idea</span></a></h2><p><img src="`+c+'" alt="Xray Fallback Process"></p><p>After receiving traffic from port 443, Xray will decrypt the TLS and forward the traffic that has a first packet length &lt; 18, invalid protocol version, or failed authentication through matching name, path, and alpn to the address specified by dest.</p><h2 id="adding-dns-records" tabindex="-1"><a class="header-anchor" href="#adding-dns-records"><span>Adding DNS Records</span></a></h2><p><img src="'+d+'" alt="DNS Records"></p><p>Please modify the domain name and IP according to the actual situation.</p><h2 id="applying-for-tls-certificate" tabindex="-1"><a class="header-anchor" href="#applying-for-tls-certificate"><span>Applying for TLS Certificate</span></a></h2>',23),k=n("code",null,"*.example.com",-1),b=n("code",null,"example.com",-1),f=n("code",null,"*.*.example.com",-1),g={href:"https://en.wikipedia.org/wiki/Subject_Alternative_Name",target:"_blank",rel:"noopener noreferrer"},y={href:"https://acme.sh",target:"_blank",rel:"noopener noreferrer"},q={href:"https://github.com/acmesh-official/acme.sh/wiki/dnsapi",target:"_blank",rel:"noopener noreferrer"},x={href:"https://dash.cloudflare.com/profile/api-tokens",target:"_blank",rel:"noopener noreferrer"},w=t('<p><img src="'+u+`" alt="API Token permission settings"></p><p>The permission part is crucial, while other parts are optional.</p><p>After creating, you will receive a mysterious string of characters. Please keep it safe in a secure and non-losing place, as it will not be displayed again. This string of characters is the <code>CF_Token</code> that will be used soon.</p><div class="custom-container tip"><p class="custom-container-title">Note</p><p>The following operations need to be performed under the root user. Using sudo will result in errors.</p></div><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">curl</span> https://get.acme.sh <span class="token operator">|</span> <span class="token function">sh</span> <span class="token comment"># Install acme.sh</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CF_Token</span><span class="token operator">=</span><span class="token string">&quot;sdfsdfsdfljlbjkljlkjsdfoiwje&quot;</span> <span class="token comment"># Set API Token variable</span>
acme.sh <span class="token parameter variable">--issue</span> <span class="token parameter variable">-d</span> example.com <span class="token parameter variable">-d</span> *.example.com <span class="token parameter variable">--dns</span> dns_cf <span class="token comment"># Apply for a certificate using DNS-01 validation method</span>
<span class="token function">mkdir</span> /etc/ssl/xray <span class="token comment"># Create a directory to store the certificate</span>
acme.sh --install-cert <span class="token parameter variable">-d</span> example.com --fullchain-file /etc/ssl/xray/cert.pem --key-file /etc/ssl/xray/privkey.key <span class="token parameter variable">--reloadcmd</span> <span class="token string">&quot;chown nobody:nogroup -R /etc/ssl/xray &amp;&amp; systemctl restart xray&quot;</span> <span class="token comment"># Install the certificate to the specified directory and set the effective command for automatic renewal</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="xray-configuration" tabindex="-1"><a class="header-anchor" href="#xray-configuration"><span>Xray Configuration</span></a></h2><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;log&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;loglevel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;warning&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;inbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">443</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vless&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;clients&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UUID&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;flow&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xtls-rprx-vision&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;decryption&quot;</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;fallbacks&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;example.com&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/vmessws&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
            <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5001</span><span class="token punctuation">,</span>
            <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;alpn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;h2&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5002</span><span class="token punctuation">,</span>
            <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blog.example.com&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5003</span><span class="token punctuation">,</span>
            <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blog.example.com&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;alpn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;h2&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5004</span><span class="token punctuation">,</span>
            <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;security&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tls&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tlsSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;alpn&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;h2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http/1.1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;certificates&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token property">&quot;certificateFile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/etc/ssl/xray/cert.pem&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;keyFile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/etc/ssl/xray/privkey.key&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;listen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vmess&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;clients&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UUID&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ws&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;wsSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;acceptProxyProtocol&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/vmessws&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;freedom&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The above configuration is for Nginx. Here are some details that need to be noted.</p><ul><li>About Proxy Protocol</li></ul><p>Proxy Protocol is a protocol developed by HaProxy to solve the problem of easily losing client information during proxying. It is often used for chain proxying and reverse proxying. The traditional approach to handling this problem is often complex and has many limitations, while Proxy Protocol simply attaches the original connection quadruple information packet to the transmitted data, solving this problem in a very simple way.</p><p>Everything has its advantages and disadvantages, and the same goes for the Proxy Protocol.</p><ul><li>If there is sending, there must be receiving, and vice versa.</li><li>The same port cannot be compatible with connections that have Proxy Protocol data and those that don&#39;t have data (e.g., different virtual hosts (servers) on the same port in Nginx, which is essentially the previous point). <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></li></ul><p>Please consider whether the configuration meets the above conditions when encountering exceptions.</p><p>Here, we use the Proxy Protocol to allow the fallback target to obtain the real IP address of the client.</p><p>In addition, when the <code>&quot;acceptProxyProtocol&quot;: true</code> exists in a certain inbound configuration of Xray, ReadV will be invalidated.</p><ul><li>Regarding HTTP/2</li></ul><p>First, <code>inbounds.streamSettings.tlsSettings.alpn</code> has an order. <code>h2</code> should be placed before <code>http/1.1</code> to prioritize the use of HTTP/2 while ensuring compatibility. Placing them in reverse order will cause HTTP/2 to be negotiated as HTTP/1.1, resulting in an invalid configuration.</p><p>In the above configuration, each <code>fallback</code> configuration that falls back to Nginx needs to be divided into two. This is because h2 is an HTTP/2 connection that requires TLS encryption, which is beneficial for the security of data transmission over the Internet, but is unnecessary within the server. On the other hand, h2c is a non-encrypted HTTP/2 connection that is suitable for this environment. However, Nginx cannot listen for HTTP/1.1 and h2c on the same port at the same time. To solve this problem, the <code>alpn</code> option (in <code>fallbacks</code> rather than <code>tlsSettings</code>) needs to be specified in the fallback to try to match the TLS ALPN negotiation result.</p><p>Suggestion: Use only two types of fillings for the <code>alpn</code> item as needed: <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p><ul><li>Omitted</li><li><code>&quot;h2&quot;</code></li></ul><p>If you use Caddy, you don&#39;t need to be so complicated, because <strong>it can</strong> listen to HTTP/1.1 and h2c on the same port at the same time. The configuration changes are as follows:</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;fallbacks&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;example.com&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/vmessws&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
      <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5001</span><span class="token punctuation">,</span>
      <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blog.example.com&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token number">5002</span><span class="token punctuation">,</span>
      <span class="token property">&quot;xver&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(Note: This is a JSON code block. It describes fallback configurations for a service.)</p><h2 id="nginx-configuration" tabindex="-1"><a class="header-anchor" href="#nginx-configuration"><span>Nginx Configuration</span></a></h2><p>Nginx will be installed through official sources.</p><p>This is a set of Bash commands to install Nginx on Ubuntu.</p><p>The first command installs the necessary packages for the installation process.</p><p>The second command adds the Nginx repository to the list of sources that Ubuntu uses to find software packages.</p><p>The third command downloads the Nginx signing key and adds it to the system&#39;s keyring, which verifies the authenticity of the package.</p><p>The fourth command updates the package list with the newly added Nginx repository.</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">curl</span> gnupg2 ca-certificates lsb-release
<span class="token builtin class-name">echo</span> <span class="token string">&quot;deb [arch=amd64] http://nginx.org/packages/ubuntu <span class="token variable"><span class="token variable">\`</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">\`</span></span> nginx&quot;</span> <span class="token punctuation">\\</span>
    <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/nginx.list
<span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://nginx.org/keys/nginx_signing.key <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Delete <code>/etc/nginx/conf.d/default.conf</code> and create <code>/etc/nginx/conf.d/fallbacks.conf</code> with the following content:</p><div class="language-nginx line-numbers-mode" data-ext="nginx" data-title="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">set_real_ip_from</span> 127.0.0.1</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">real_ip_header</span> proxy_protocol</span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> 127.0.0.1:5001 proxy_protocol default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span> 127.0.0.1:5002 proxy_protocol default_server http2</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /srv/http/default</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> 127.0.0.1:5003 proxy_protocol</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span> 127.0.0.1:5004 proxy_protocol http2</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">server_name</span> blog.example.com</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /srv/http/blog.example.com</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="caddy-configuration" tabindex="-1"><a class="header-anchor" href="#caddy-configuration"><span>Caddy Configuration</span></a></h2>`,34),_={href:"https://caddyserver.com/docs/install",target:"_blank",rel:"noopener noreferrer"},T=t(`<p>To enable Caddy to obtain the real IP address of visitors, it is necessary to compile Caddy with the Proxy Protocol module. It is recommended to compile it directly on the Caddy website.</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-o</span> /usr/bin/caddy <span class="token string">&quot;https://caddyserver.com/api/download?os=linux&amp;arch=amd64&amp;p=github.com%2Fmastercactapus%2Fcaddy2-proxyprotocol&amp;idempotency=79074247675458&quot;</span>

<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/bin/caddy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This is a bash script that downloads the Caddy web server and sets the necessary permissions to run it on a Linux system.</p><p>Just replace it directly.</p><div class="custom-container tip"><p class="custom-container-title">Tip</p><p>It is recommended to install Caddy through the official website documentation first, and then replace the binary file. This way, there is no need to manually set the process management.</p></div><p>Edit <code>/etc/caddy/Caddyfile</code>:</p><p>This is a Caddyfile, which is a configuration file used by the Caddy web server.</p><p>In this specific configuration, there are two servers defined: one listening on <code>127.0.0.1:5001</code> and another on <code>127.0.0.1:5002</code>. Both servers have a <code>listener_wrapper</code> defined for <code>proxy_protocol</code>, which is a protocol used for passing client connection information through a proxy or load balancer. Additionally, both servers have the <code>allow_h2c</code> option enabled, which allows clients to connect using HTTP/2 cleartext (h2c) protocol.</p><div class="language-Caddyfile line-numbers-mode" data-ext="Caddyfile" data-title="Caddyfile"><pre class="language-Caddyfile"><code>{
    servers 127.0.0.1:5001 {
        listener_wrappers {
            proxy_protocol
        }
	protocol {
            allow_h2c
        }
    }
    servers 127.0.0.1:5002 {
        listener_wrappers {
            proxy_protocol
        }
	protocol {
            allow_h2c
        }
    }
}

:5001 {
    root * /srv/http/default
    file_server
    log
    bind 127.0.0.1
}

http://blog.example.com:5002 {
    root * /srv/http/blog.example.com
    file_server
    log
    bind 127.0.0.1
}

:80 {
    redir https://{host}{uri} permanent
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference"><span>Reference</span></a></h2>`,10),P={href:"https://en.wikipedia.org/wiki/Server_Name_Indication",target:"_blank",rel:"noopener noreferrer"},S={href:"https://github.com/acmesh-official/acme.sh/wiki",target:"_blank",rel:"noopener noreferrer"},I={href:"https://en.wikipedia.org/wiki/HTTP/2",target:"_blank",rel:"noopener noreferrer"},N=n("h2",{id:"quotation",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#quotation"},[n("span",null,"Quotation")])],-1),H=n("hr",{class:"footnotes-sep"},null,-1),C={class:"footnotes"},L={class:"footnotes-list"},A={id:"fn1",class:"footnote-item"},j={href:"https://www.haproxy.com/blog/haproxy/proxy-protocol/",target:"_blank",rel:"noopener noreferrer"},F=n("a",{href:"#fnref1",class:"footnote-backref"},"↩︎",-1),E={id:"fn2",class:"footnote-item"},D={href:"https://www.jianshu.com/p/cc8d592582c9",target:"_blank",rel:"noopener noreferrer"},U=n("a",{href:"#fnref2",class:"footnote-backref"},"↩︎",-1),V={id:"fn3",class:"footnote-item"},W={href:"https://github.com/rprx/v2fly-github-io/blob/master/docs/config/protocols/vless.md",target:"_blank",rel:"noopener noreferrer"},X=n("a",{href:"#fnref3",class:"footnote-backref"},"↩︎",-1);function B(R,J){const i=o("I18nTip"),e=o("ExternalLinkIcon");return l(),r("div",null,[h,a(i),m,n("p",null,[s("As it is necessary to route traffic to different domain name prefixes, but a wildcard certificate is only valid between two dots (for example, applying for "),k,s(", the certificate cannot be used for "),b,s(" and "),f,s("), it is necessary to apply for a "),n("a",g,[s("SAN"),a(e)]),s(" (Subject Alternative Name) wildcard certificate. According to the information on the Let's Encrypt official website, applying for a wildcard certificate requires DNS-01 verification. Here, we demonstrate how to apply for a free TLS certificate from Let's Encrypt using "),n("a",y,[s("acme.sh"),a(e)]),s(" for a domain with NS records hosted on Cloudflare. For the application method using other domain name hosting providers, please refer to "),n("a",q,[s("dnsapi · acmesh-official/acme.sh Wiki"),a(e)]),s(".")]),n("p",null,[s("First, you need to go to the "),n("a",x,[s("Cloudflare dashboard"),a(e)]),s(" to create an API token. The parameters are as follows:")]),w,n("p",null,[s("Please refer to "),n("a",_,[s("Install — Caddy Documentation"),a(e)]),s(" for installing Caddy.")]),T,n("ol",null,[n("li",null,[n("a",P,[s("Server Name Indication - Wikipedia, the free encyclopedia"),a(e)])]),n("li",null,[n("a",S,[s("Home · acmesh-official/acme.sh Wiki"),a(e)])]),n("li",null,[n("a",I,[s("HTTP/2 - Wikipedia, the free encyclopedia"),a(e)])])]),N,H,n("section",C,[n("ol",L,[n("li",A,[n("p",null,[n("a",j,[s("Proxy Protocol - HAProxy Technologies"),a(e)]),s(),F])]),n("li",E,[n("p",null,[n("a",D,[s("Introduction to Proxy Protocol and Nginx Configuration - Jianshu"),a(e)]),s(),U])]),n("li",V,[n("p",null,[n("a",W,[s("v2fly-github-io/vless.md at master · rprx/v2fly-github-io"),a(e)]),s(),X])])])])])}const G=p(v,[["render",B],["__file","fallbacks-with-sni.html.vue"]]);export{G as default};
