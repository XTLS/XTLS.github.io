import{_ as l,r as t,o as i,c as o,a as n,b as a,d as s,e as p}from"./app-Dp4t6tDQ.js";const c={},d=a("h1",{id:"прозрачное-проксирование-исключение-трафика-xray-с-помощью-gid",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#прозрачное-проксирование-исключение-трафика-xray-с-помощью-gid"},[a("span",null,"Прозрачное проксирование: Исключение трафика Xray с помощью GID")])],-1),m={href:"https://guide.v2fly.org/app/transparent_proxy.html",target:"_blank",rel:"noopener noreferrer"},v={href:"https://guide.v2fly.org/app/tproxy.html",target:"_blank",rel:"noopener noreferrer"},b=a("strong",null,[a("a",{href:"./tproxy"},"Руководство по настройке прозрачного проксирования (TProxy)")],-1),u=a("p",null,"У такого подхода есть несколько недостатков:",-1),k={href:"https://github.com/v2ray/v2ray-core/issues/2621",target:"_blank",rel:"noopener noreferrer"},h=a("li",null,[a("p",null,"Android использует собственный механизм меток, поэтому данный метод не применим к Android")],-1),g=p('<p>Предлагаемый в данном руководстве подход не требует использования меток, теоретически обеспечивая более высокую производительность и избегая описанных выше проблем.</p><h2 id="идея" tabindex="-1"><a class="header-anchor" href="#идея"><span>Идея</span></a></h2><p>Tproxy трафик может приниматься только пользователями с правами root (uid==0) или CAP_NET_ADMIN.</p><p>Правила iptables позволяют разделять трафик на основе UID (идентификатор пользователя) и GID (идентификатор группы).</p><p>Запустим Xray от имени пользователя с uid==0 и gid!=0 и настроим правила iptables, чтобы исключить трафик с этим GID, избегая проксирования трафика Xray.</p><h2 id="настроика" tabindex="-1"><a class="header-anchor" href="#настроика"><span>Настройка</span></a></h2><h3 id="_1-предварительная-подготовка" tabindex="-1"><a class="header-anchor" href="#_1-предварительная-подготовка"><span>1. Предварительная подготовка</span></a></h3><p><strong>Android</strong></p>',8),D=a("li",null,"На устройстве должны быть получены root-права.",-1),B={href:"https://play.google.com/store/apps/details?id=stericson.busybox",target:"_blank",rel:"noopener noreferrer"},_=a("li",null,"Наличие терминала для выполнения команд, например, adb shell, Termux и т.д.",-1),A=p(`<p><strong>Другие Linux системы</strong></p><p>Необходимо наличие sudo, модуля tproxy для iptables и модуля extra.</p><p>Обычно все это уже установлено в системе, для OpenWRT выполните:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>opkg <span class="token function">install</span> <span class="token function">sudo</span> iptables-mod-tproxy iptables-mod-extra
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Также могут понадобиться следующие зависимости для OpenWRT, их отсутствие может помешать запуску Xray:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>opkg <span class="token function">install</span> libopenssl ca-certificates
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-добавление-пользователя-пропустите-для-android" tabindex="-1"><a class="header-anchor" href="#_2-добавление-пользователя-пропустите-для-android"><span>2. Добавление пользователя (пропустите для Android)</span></a></h3><p>Android не поддерживает файл /etc/passwd для управления пользователями, пропустите этот шаг и перейдите к следующему.</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">grep</span> <span class="token parameter variable">-qw</span> xray_tproxy /etc/passwd <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;xray_tproxy:x:0:23333:::&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/passwd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Где xray_tproxy - имя пользователя, 0 - UID, 23333 - GID. Имя пользователя и GID можно задать произвольно, UID должен быть равен 0. Проверьте, успешно ли добавлен пользователь, выполнив:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token parameter variable">-u</span> xray_tproxy <span class="token function">id</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>В результате должен отобразиться UID 0 и GID 23333.</p><h3 id="_3-настроика-запуска-xray-и-правил-iptables" tabindex="-1"><a class="header-anchor" href="#_3-настроика-запуска-xray-и-правил-iptables"><span>3. Настройка запуска Xray и правил iptables</span></a></h3>`,13),y={href:"https://guide.v2fly.org/app/transparent_proxy.html",target:"_blank",rel:"noopener noreferrer"},x={href:"https://guide.v2fly.org/app/tproxy.html",target:"_blank",rel:"noopener noreferrer"},R=a("strong",null,[a("a",{href:"./tproxy"},"Руководство по настройке прозрачного проксирования (TProxy)")],-1),f=p(`<ol><li><p>Измените конфигурационный файл JSON, удалив все, что связано с метками.</p></li><li><p>Измените правила iptables, удалив все, что связано с метками, и добавьте опцию &quot;-m owner ! --gid-owner 23333&quot; в цепочку OUTPUT перед применением правила XRAY_SELF.</p></li></ol><p>Например:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-j</span> XRAY_SELF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Замените на:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-m</span> owner <span class="token operator">!</span> --gid-owner <span class="token number">23333</span> <span class="token parameter variable">-j</span> XRAY_SELF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="3"><li>Измените способ запуска Xray, чтобы он запускался от имени пользователя с UID 0 и GID 23333, см. <a href="#3-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BC%D0%B0%D0%BA%D1%81%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B3%D0%BE-%D0%BA%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B0-%D0%BE%D1%82%D0%BA%D1%80%D1%8B%D1%82%D1%8B%D1%85-%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2-%D0%B8-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D0%B0-xray">здесь</a>.</li></ol><h2 id="ниже-приведен-пример-полнои-настроики-глобального-проксирования-с-использованием-tproxy" tabindex="-1"><a class="header-anchor" href="#ниже-приведен-пример-полнои-настроики-глобального-проксирования-с-использованием-tproxy"><span>Ниже приведен пример полной настройки глобального проксирования с использованием TPROXY</span></a></h2><h3 id="_1-выполните-предварительную-подготовку-и-добавление-пользователя" tabindex="-1"><a class="header-anchor" href="#_1-выполните-предварительную-подготовку-и-добавление-пользователя"><span>1. Выполните <a href="#1-%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F-%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0">предварительную подготовку</a> и <a href="#2-%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F-%D0%BF%D1%80%D0%BE%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5-%D0%B4%D0%BB%D1%8F-android">добавление пользователя</a>.</span></a></h3><h3 id="_2-подготовьте-конфигурационныи-фаил-xray" tabindex="-1"><a class="header-anchor" href="#_2-подготовьте-конфигурационныи-фаил-xray"><span>2. Подготовьте конфигурационный файл Xray.</span></a></h3><p>Настройте произвольную дверь Xray для прослушивания порта 12345, включите followRedirect и tproxy, sniffing не требуется:</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;inbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">12345</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dokodemo-door&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp,udp&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;followRedirect&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;sockopt&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;tproxy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tproxy&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Конфигурация вашего сервера</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-настроика-максимального-количества-открытых-фаилов-и-запуск-клиента-xray" tabindex="-1"><a class="header-anchor" href="#_3-настроика-максимального-количества-открытых-фаилов-и-запуск-клиента-xray"><span>3. Настройка максимального количества открытых файлов и запуск клиента Xray</span></a></h3>`,12),X={href:"https://guide.v2fly.org/app/tproxy.html#%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B-too-many-open-files",target:"_blank",rel:"noopener noreferrer"},q=p(`<p>В настоящее время при установке сервера Xray с помощью официального скрипта максимальное количество открытых файлов настраивается автоматически, никаких дополнительных действий не требуется.</p><p><strong>Android</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">1000000</span>
setuidgid <span class="token number">0</span>:23333 <span class="token string">&quot;команда запуска Xray&quot;</span><span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Другие Linux системы</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">1000000</span>
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> xray_tproxy <span class="token string">&quot;команда запуска Xray&quot;</span><span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>Например:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">1000000</span>
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> xray_tproxy xray <span class="token parameter variable">-c</span> /etc/xray/config.json <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><em>Первая команда:</em></p><p>Изменяет максимальное количество открытых файлов, действует только в текущем терминале, необходимо выполнять перед каждым запуском Xray. Эта команда устанавливает максимальное количество открытых файлов для клиента.</p><p><em>Вторая команда:</em></p><p>Запускает клиент Xray от имени пользователя с UID 0 и GID, отличным от 0. Символ &amp; в конце команды означает запуск в фоновом режиме.</p><p><strong>Проверка настройки максимального количества открытых файлов</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">cat</span> /proc/PID Xray/limits
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Найдите строку &quot;Max open files&quot;, значение должно соответствовать установленному вами. PID процесса Xray можно узнать, выполнив команду <code>ps</code>, <code>ps -aux</code>, <code>ps -a</code> или <code>pidof xray</code>.</p><p>Проверьте как сервер, так и клиент.</p><h3 id="_4-настроика-правил-iptables" tabindex="-1"><a class="header-anchor" href="#_4-настроика-правил-iptables"><span>4. Настройка правил iptables</span></a></h3><p><strong>Проксирование IPv4</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">ip</span> rule <span class="token function">add</span> fwmark <span class="token number">1</span> table <span class="token number">100</span>
<span class="token function">ip</span> route <span class="token function">add</span> <span class="token builtin class-name">local</span> <span class="token number">0.0</span>.0.0/0 dev lo table <span class="token number">100</span>

<span class="token comment"># Проксирование устройств локальной сети</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-N</span> XRAY
<span class="token comment">#  &quot;Сегмент IPv4-сети шлюза&quot; можно получить, выполнив команду &quot;ip address | grep -w inet | awk &#39;{print $2}&#39;&quot;, как правило, их несколько</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY <span class="token parameter variable">-d</span> Сегмент IPv4-сети шлюза <span class="token number">1</span> <span class="token parameter variable">-j</span> RETURN
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY <span class="token parameter variable">-d</span> Сегмент IPv4-сети шлюза <span class="token number">2</span> <span class="token parameter variable">-j</span> RETURN
<span class="token punctuation">..</span>.

<span class="token comment"># Прямое подключение для многоадресных адресов/адресов класса E/широковещательных адресов</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY <span class="token parameter variable">-d</span> <span class="token number">224.0</span>.0.0/3 <span class="token parameter variable">-j</span> RETURN

<span class="token comment"># Если шлюз является основным маршрутизатором, добавьте эту строку, см.: https://xtls.github.io/documents/level-2/transparent_proxy/transparent_proxy.md#iptables-прозрачное-проксирование-другие-замечания</span>
<span class="token comment"># &quot;Диапазон LAN-адресов IPv4 шлюза&quot; можно получить, выполнив команду &quot;ip address | grep -w &quot;inet&quot; | awk &#39;{print $2}&#39;&quot;, это будет один из адресов</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY <span class="token operator">!</span> <span class="token parameter variable">-s</span> Диапазон LAN-адресов IPv4 шлюза <span class="token parameter variable">-j</span> RETURN

<span class="token comment"># Пометить TCP-трафик меткой 1 и перенаправить на порт 12345</span>
<span class="token comment"># Трафик будет приниматься произвольной дверью Xray только при наличии метки 1</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-j</span> TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
<span class="token comment"># Применить правило</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-j</span> XRAY

<span class="token comment"># Проксирование хоста шлюза</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-N</span> XRAY_MASK
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY_MASK <span class="token parameter variable">-m</span> owner --gid-owner <span class="token number">23333</span> <span class="token parameter variable">-j</span> RETURN
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY_MASK <span class="token parameter variable">-d</span> Сегмент IPv4-сети шлюза <span class="token number">1</span> <span class="token parameter variable">-j</span> RETURN
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY_MASK <span class="token parameter variable">-d</span> Сегмент IPv4-сети шлюза <span class="token number">2</span> <span class="token parameter variable">-j</span> RETURN
<span class="token punctuation">..</span>.
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY_MASK <span class="token parameter variable">-d</span> <span class="token number">224.0</span>.0.0/3 <span class="token parameter variable">-j</span> RETURN
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY_MASK <span class="token parameter variable">-j</span> MARK --set-mark <span class="token number">1</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> XRAY_MASK
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-j</span> XRAY_MASK
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Проксирование IPv6 (необязательно)</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">ip</span> <span class="token parameter variable">-6</span> rule <span class="token function">add</span> fwmark <span class="token number">1</span> table <span class="token number">106</span>
<span class="token function">ip</span> <span class="token parameter variable">-6</span> route <span class="token function">add</span> <span class="token builtin class-name">local</span> ::/0 dev lo table <span class="token number">106</span>

<span class="token comment"># Проксирование устройств локальной сети</span>
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-N</span> XRAY6
<span class="token comment">#  &quot;Сегмент IPv6-сети шлюза&quot; можно получить, выполнив команду &quot;ip address | grep -w inet6 | awk &#39;{print $2}&#39;&quot;.</span>
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6 <span class="token parameter variable">-d</span> Сегмент IPv6-сети шлюза <span class="token number">1</span> <span class="token parameter variable">-j</span> RETURN
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6 <span class="token parameter variable">-d</span> Сегмент IPv6-сети шлюза <span class="token number">2</span> <span class="token parameter variable">-j</span> RETURN
<span class="token punctuation">..</span>.

<span class="token comment"># Если шлюз является основным маршрутизатором, добавьте эту строку, см.: https://xtls.github.io/documents/level-2/transparent_proxy/transparent_proxy.md#iptables-прозрачное-проксирование-другие-замечания</span>
<span class="token comment"># &quot;Диапазон LAN-адресов IPv6 шлюза&quot; можно получить, выполнив команду &quot;ip address | grep -w &quot;inet6&quot; | awk &#39;{print $2}&#39;&quot;, это будет один из адресов</span>
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6 <span class="token operator">!</span> <span class="token parameter variable">-s</span> Диапазон LAN-адресов IPv6 шлюза <span class="token parameter variable">-j</span> RETURN

ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6 <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-j</span> TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-j</span> XRAY6

<span class="token comment"># Проксирование хоста шлюза</span>
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-N</span> XRAY6_MASK
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6_MASK <span class="token parameter variable">-m</span> owner --gid-owner <span class="token number">23333</span> <span class="token parameter variable">-j</span> RETURN
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6_MASK <span class="token parameter variable">-d</span> Сегмент IPv6-сети шлюза <span class="token number">1</span> <span class="token parameter variable">-j</span> RETURN
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6_MASK <span class="token parameter variable">-d</span> Сегмент IPv6-сети шлюза <span class="token number">2</span> <span class="token parameter variable">-j</span> RETURN
<span class="token punctuation">..</span>.
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> XRAY6_MASK <span class="token parameter variable">-j</span> MARK --set-mark <span class="token number">1</span>
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> XRAY6_MASK
ip6tables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-p</span> udp <span class="token parameter variable">-j</span> XRAY6_MASK
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,20);function T(I,Y){const r=t("I18nTip"),e=t("ExternalLinkIcon");return i(),o("div",null,[d,n(r),a("p",null,[s("В существующих русскоязычных руководствах по прозрачному проксированию с использованием iptables ("),a("strong",null,[a("a",m,[s("Новое руководство по V2Ray на русском языке - Прозрачное проксирование"),n(e)])]),s(", "),a("strong",null,[a("a",v,[s("Новое руководство по V2Ray на русском языке - Прозрачное проксирование (TPROXY)"),n(e)])]),s(", "),b,s(") исключение трафика Xray осуществляется с помощью меток. Исходящий трафик Xray помечается, а затем с помощью правил iptables трафик с соответствующей меткой направляется напрямую, минуя Xray и предотвращая зацикливание.")]),u,a("ol",null,[a("li",null,[a("p",null,[a("strong",null,[a("a",k,[s("Необъяснимый трафик попадает в цепочку PREROUTING"),n(e)])])])]),h]),g,a("ol",null,[D,a("li",null,[s("Установите "),a("strong",null,[a("a",B,[s("busybox"),n(e)])]),s(".")]),_]),A,a("p",null,[s("Внесите изменения в существующие русскоязычные руководства по прозрачному проксированию с использованием iptables ("),a("strong",null,[a("a",y,[s("Новое руководство по V2Ray на русском языке - Прозрачное проксирование"),n(e)])]),s(", "),a("strong",null,[a("a",x,[s("Новое руководство по V2Ray на русском языке - Прозрачное проксирование (TPROXY)"),n(e)])]),s(", "),R,s("):")]),f,a("p",null,[s('О проблеме "too many open files" см.: '),a("strong",null,[a("a",X,[s("Проблема too many open files"),n(e)])])]),q])}const P=l(c,[["render",T],["__file","iptables_gid.html.vue"]]);export{P as default};
