import{_ as i,r as p,o as u,c as r,a as o,b as n,d as s,w as d,e as a}from"./app-oFgL5Vdc.js";const D="/assets/routing-lv1-img01-trio-Dac-S2au.jpg",g={},k=a('<h1 id="краткии-обзор-функции-маршрутизации-routing-часть-1" tabindex="-1"><a class="header-anchor" href="#краткии-обзор-функции-маршрутизации-routing-часть-1"><span>Краткий обзор функции маршрутизации (routing) (часть 1)</span></a></h1><p>Если &quot;мощность&quot; Xray в основном заключается в его высокой скорости и широкой совместимости, то его &quot;гибкость&quot; в первую очередь связана с продуманной функцией <strong>&quot;routing&quot; (маршрутизация)</strong>. В этой статье мы кратко рассмотрим логику этой функции и способы ее применения.</p><h2 id="_1-знакомство-с-тремя-братьями-маршрутизаторами" tabindex="-1"><a class="header-anchor" href="#_1-знакомство-с-тремя-братьями-маршрутизаторами"><span>1. Знакомство с тремя братьями-маршрутизаторами</span></a></h2><p>Чтобы понять маршрутизацию, нужно понимать, что для ее полноценной работы нужны три компонента: 1. <strong>входящий трафик</strong> (inbound); 2. <strong>маршрутизация</strong> (routing); 3. <strong>исходящий трафик</strong> (outbound).</p><p><img src="'+D+'" alt="Три брата-маршрутизатора"></p><p>Три брата, поклявшиеся в верности, не обязательно родились в один день, но должны быть готовы умереть в один день.</p><p>Поэтому запомните: если один из элементов работает неправильно, функция маршрутизации может не работать.</p><p>Поскольку маршрутизация очень гибкая, чтение только технической документации может вас запутать, поэтому в этой статье мы будем использовать конкретные примеры, чтобы объяснить все пошагово.</p><div class="custom-container warning"><p class="custom-container-title">Внимание</p><p>Функция маршрутизации настолько гибкая, что примеры в этой статье приведены только для объяснения соответствующих концепций. На практике, пожалуйста, корректируйте их в соответствии с вашими потребностями.</p></div><h2 id="_2-основы-братья-едины" tabindex="-1"><a class="header-anchor" href="#_2-основы-братья-едины"><span>2. Основы: &quot;Братья едины&quot;</span></a></h2><p>На рисунке ниже показан пример, когда входящий трафик от приложения поступает на <code>Xray</code> на клиенте, маршрутизируется на исходящий трафик и отправляется на VPS.</p>',11),q=a(`<p>Давайте проанализируем каждый шаг:</p><h3 id="_2-1-входящии-трафик" tabindex="-1"><a class="header-anchor" href="#_2-1-входящии-трафик"><span>2.1 Входящий трафик</span></a></h3><div class="custom-container tip"><p class="custom-container-title">Подсказка</p><p><strong>Входящий трафик (inbound):</strong> это то, как трафик попадает в <code>Xray</code>.</p></div><p>Пример конфигурации входящего трафика ниже означает, что данные поступают в <code>Xray</code> по протоколу <code>socks</code> через порт <code>10808</code> с локального адреса <code>127.0.0.1</code>. <code>Xray</code> присваивает этому входящему трафику имя <code>inbound-10808</code> с помощью <code>[tag]</code>.</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;inbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;inbound-10808&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;socks&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;listen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">10808</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;udp&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-исходящии-трафик" tabindex="-1"><a class="header-anchor" href="#_2-2-исходящии-трафик"><span>2.2 Исходящий трафик</span></a></h3><div class="custom-container tip"><p class="custom-container-title">Подсказка</p><p><strong>Исходящий трафик (outbound):</strong> это то, как трафик выходит из <code>Xray</code>.</p></div><p>Пример конфигурации исходящего трафика ниже означает, что данные отправляются на соответствующий VPS по протоколу <code>VLESS</code> с использованием <code>tcp + xtls</code> и других параметров. <code>Xray</code> присваивает этому исходящему трафику имя <code>proxy-out-vless</code> с помощью <code>[tag]</code>.</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;proxy-out-vless&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vless&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;vnext&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a-name.yourdomain.com&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">443</span><span class="token punctuation">,</span>
            <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uuiduuid-uuid-uuid-uuid-uuiduuiduuid&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;flow&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xtls-rprx-vision&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;encryption&quot;</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;level&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;security&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tls&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tlsSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;serverName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a-name.yourdomain.com&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;allowInsecure&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">&quot;fingerprint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-маршрутизация" tabindex="-1"><a class="header-anchor" href="#_2-3-маршрутизация"><span>2.3 Маршрутизация</span></a></h3><div class="custom-container tip"><p class="custom-container-title">Подсказка</p><p><strong>Маршрутизация (routing):</strong> это соединение канала между <strong>входящим</strong> и <strong>исходящим</strong> трафиком с помощью определенного <strong>условия</strong>.</p></div><p>Пример конфигурации маршрутизации ниже означает, что весь трафик, поступающий в <code>Xray</code> через входящий трафик с <code>[tag]=&quot;inbound-10808&quot;</code>, <strong>на 100%</strong> перенаправляется на исходящий трафик с <code>[tag]=&quot;proxy-out-vless&quot;</code> без разделения или каких-либо других действий.</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;routing&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;domainStrategy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AsIs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;rules&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;field&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;inboundTag&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;inbound-10808&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;outboundTag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;proxy-out-vless&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Таким образом, мы реализовали очень простое правило, описанное в начале: <strong>входящий трафик от приложения поступает на <code>Xray</code> на клиенте, маршрутизируется на исходящий трафик и отправляется на VPS</strong>.</p><h3 id="_2-4-анализ-параметров-конфигурации-маршрутизации-критерии-фильтрации-трафика" tabindex="-1"><a class="header-anchor" href="#_2-4-анализ-параметров-конфигурации-маршрутизации-критерии-фильтрации-трафика"><span>2.4 Анализ параметров конфигурации маршрутизации: критерии фильтрации трафика</span></a></h3><p>Обратите внимание на конфигурацию маршрутизации. Мы видим несколько новых терминов:</p><ol><li><code>&quot;domainStrategy&quot;: &quot;AsIs&quot;</code></li><li><code>“rules”</code></li><li><code>&quot;type&quot;: &quot;field&quot;</code></li><li><code>&quot;inboundTag&quot;: [&quot;inbound-10808&quot;]</code></li><li><code>&quot;outboundTag&quot;: &quot;proxy-out-vless&quot;</code></li></ol><p>Пока оставим <code>domainStrategy</code> в стороне и кратко объясним остальные:</p><table><thead><tr><th style="text-align:left;">Название параметра</th><th style="text-align:left;">Значение параметра</th><th style="text-align:left;">Описание параметра</th></tr></thead><tbody><tr><td style="text-align:left;"><code>“rules”</code></td><td style="text-align:left;">                                                   </td><td style="text-align:left;">Внутри этого параметра находятся подробные настройки <strong>правил маршрутизации</strong>.</td></tr><tr><td style="text-align:left;"><code>&quot;type&quot;</code></td><td style="text-align:left;"><code>&quot;field&quot;</code></td><td style="text-align:left;">На данный момент этот параметр не имеет особого значения, но его нельзя опускать, поэтому просто укажите его.</td></tr><tr><td style="text-align:left;"><code>&quot;inboundTag&quot;</code></td><td style="text-align:left;"><code>[&quot;inbound-10808&quot;]</code></td><td style="text-align:left;"><strong>Критерий</strong> фильтрации трафика - это <strong>тег входящего трафика</strong>, а <strong>условие</strong> сейчас только одно: <strong>источник входящего трафика - <code>inbound-10808</code></strong>.</td></tr><tr><td style="text-align:left;"><code>&quot;outboundTag&quot;</code></td><td style="text-align:left;"><code>&quot;proxy-out-vless&quot;</code></td><td style="text-align:left;">Если указанное выше условие фильтрации выполняется (т.е. входящий трафик имеет <code>[tag]=&quot;inbound-10808&quot;</code>), <code>Xray</code> направит трафик на исходящий трафик с <code>[tag]=&quot;proxy-out-vless&quot;</code>.</td></tr></tbody></table><p>В этом примере у нас есть только один входящий трафик с <code>&quot;inboundTag&quot; = &quot;inbound-10808&quot;</code> и один исходящий трафик с <code>[tag]=&quot;proxy-out-vless&quot;</code>. Поэтому, согласно приведенному выше правилу маршрутизации, весь трафик, поступающий в <code>Xray</code> через порт <code>10808</code>, <strong>на 100%</strong> соответствует условиям фильтрации, выбирается модулем маршрутизации и перенаправляется на единственный исходящий трафик.</p><p>Таким образом, <strong>входящий трафик</strong>, <strong>маршрутизация</strong> и <strong>исходящий трафик</strong> уже могут работать вместе. Конечно, в данном случае 100% перенаправление не имеет особого смысла. Давайте посмотрим, какие преимущества может дать такой механизм разделения труда.</p><h2 id="_3-первые-шаги-разделение-мира-на-три-части-разделение-по-домену" tabindex="-1"><a class="header-anchor" href="#_3-первые-шаги-разделение-мира-на-три-части-разделение-по-домену"><span>3. Первые шаги: &quot;Разделение мира на три части&quot; - &quot;Разделение по домену&quot;</span></a></h2><blockquote><p><code>[geosite.dat]</code></p></blockquote>`,23),v=a(`<p>Эта конфигурация реализует самый простой и распространенный (используемый в нашем руководстве) набор правил маршрутизации:</p><ol><li>Блокировка рекламы (<code>[block]</code>)</li><li>Прямое подключение к внутренним ресурсам (<code>[direct]</code>)</li><li>Перенаправление трафика на VPS (<code>[proxy]</code>)</li></ol><div class="custom-container warning"><p class="custom-container-title">Внимание</p><p>В нашем руководстве прямое подключение настроено для <strong>внутренних доменов</strong>, <strong>внутренних IP-адресов</strong> и <strong>локальных IP-адресов</strong>. Здесь мы рассмотрим только <strong>внутренние домены</strong>.</p></div><h3 id="_3-1-входящии-трафик" tabindex="-1"><a class="header-anchor" href="#_3-1-входящии-трафик"><span>3.1 Входящий трафик</span></a></h3><p>Оставляем <code>inbound-10808</code> из предыдущего примера без изменений.</p><h3 id="_3-2-исходящии-трафик" tabindex="-1"><a class="header-anchor" href="#_3-2-исходящии-трафик"><span>3.2 Исходящий трафик</span></a></h3><p>В предыдущем примере у нас уже есть исходящий трафик <code>[proxy]</code> - <code>&quot;proxy-out-vless&quot;</code>, поэтому он остается без изменений. Очевидно, что нам нужно добавить два новых типа исходящего трафика: <code>[block]</code> и <code>[direct]</code>, как показано ниже:</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;proxy-out-vless&quot;</span>
      <span class="token comment">// ... ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;block&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blackhole&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;direct-out&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;freedom&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Приведенная выше конфигурация означает:</p><ol><li>Конфигурация исходящего трафика <code>[proxy-out-vless]</code> из предыдущего примера остается без изменений.</li><li>Добавлен протокол <strong><code>blackhole</code> (черная дыра)</strong>. Трафик, отправляемый через этот протокол, попадает в &quot;черную дыру&quot; внутри <code>Xray</code> и не может выйти наружу, что фактически блокирует его (<code>[block]</code>).</li><li>Добавлен протокол <strong><code>freedom</code> (свобода)</strong>. Трафик, отправляемый через этот протокол, свободно покидает <code>Xray</code> и следует к своему первоначальному адресу, как будто его и не было, что фактически означает прямое подключение (<code>[direct]</code>). (Здесь я назвал его <code>[direct-out]</code>, чтобы подчеркнуть, что это исходящий трафик).</li></ol><h3 id="_3-3-маршрутизация" tabindex="-1"><a class="header-anchor" href="#_3-3-маршрутизация"><span>3.3 Маршрутизация</span></a></h3><p>Настало время для чуда! Мы можем связать все это вместе с помощью конфигурации <strong>маршрутизации</strong>!</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;routing&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;domainStrategy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AsIs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;rules&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;field&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;domain&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;geosite:category-ads-all&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;outboundTag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;block&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;field&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;domain&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;geosite:cn&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;outboundTag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;direct-out&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;field&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;domain&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;geosite:geolocation-!cn&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;outboundTag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;proxy-out-vless&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Чтобы понять этот файл конфигурации, нам нужно кратко объяснить несколько новых параметров:</p><ul><li><code>&quot;domain&quot;: [&quot;geosite:category-ads-all&quot;]</code></li><li><code>&quot;domain&quot;: [&quot;geosite:cn&quot;]</code></li><li><code>&quot;domain&quot;: [&quot;geosite:geolocation-!cn&quot;]</code></li></ul><h3 id="_3-4-краткии-обзор-фаила-доменов-geosite-dat" tabindex="-1"><a class="header-anchor" href="#_3-4-краткии-обзор-фаила-доменов-geosite-dat"><span>3.4 Краткий обзор файла доменов: <code>geosite.dat</code></span></a></h3><p>На самом деле, вы, вероятно, уже догадались по названиям этих параметров:</p><ul><li><code>&quot;domain&quot;</code>: <strong>критерий</strong> фильтрации трафика в этот раз - это <strong>доменное имя</strong> (а не тег входящего трафика).</li><li><code>&quot;geosite&quot;</code>: <code>Xray</code> будет искать <strong>соответствующие доменные имена</strong> в файле <code>geosite.dat</code>.</li><li><code>&quot;category-ads-all&quot;</code>: <strong>все рекламные домены</strong>, указанные в этом файле.</li><li><code>&quot;cn&quot;</code>: <strong>китайские домены</strong>, указанные в этом файле.</li><li><code>&quot;geolocation-!cn&quot;</code>: <strong>не китайские домены</strong>, указанные в этом файле.</li></ul><p>С учетом этих пояснений конфигурацию из пункта 3.3 можно перевести так:</p><ol><li>Трафик от приложений, пытающихся получить доступ к иностранным доменам (<code>&quot;domain&quot;: &quot;geolocation-!cn&quot;</code>), перенаправляется на VPS через исходящий трафик <code>[proxy-out-vless]</code>.</li><li>Трафик от приложений, пытающихся получить доступ к иностранным рекламным доменам (<code>&quot;domain&quot;: &quot;geosite:category-ads-all&quot;</code>), блокируется (<code>[block]</code>) путем перенаправления в &quot;черную дыру&quot;.</li><li>Трафик от приложений, пытающихся получить доступ к китайским доменам (<code>&quot;domain&quot;: &quot;geosite:cn&quot;</code>), отправляется напрямую (<code>[direct-out]</code>).</li></ol><p>Вот так проявляются преимущества <strong>функции маршрутизации</strong>.</p><h3 id="_3-5-так-что-же-такое-geosite-dat-разве-у-нас-нет-gfwlist" tabindex="-1"><a class="header-anchor" href="#_3-5-так-что-же-такое-geosite-dat-разве-у-нас-нет-gfwlist"><span>3.5 Так что же такое <code>geosite.dat</code>? Разве у нас нет <code>GFWList</code>?</span></a></h3><p>Представьте, что в мире миллионы доменов. Если бы нам приходилось вручную собирать и вводить каждый домен для каждого правила маршрутизации, основанного на доменном имени, это было бы крайне неэффективно!</p><p>А если бы все домены относились только к одному типу и могли быть обработаны только одним из трех способов: <code>[direct], [proxy], [block]</code>, это было бы очень неудобно!</p><p>Как Гуань Юю нужен его Цинлун Яньюэдао, так и <strong>функции маршрутизации</strong> нужен свой волшебный меч - файл <code>geosite.dat</code>, который представляет собой готовый к использованию <strong>список категорий доменов</strong>. Он позволяет пользователям легко вызывать любую подкатегорию с помощью формата <code>geosite:xxx</code> и настраивать правила маршрутизации в соответствии со своими потребностями.</p>`,25),B={href:"https://github.com/gfwlist/gfwlist",target:"_blank",rel:"noopener noreferrer"},m=n("code",null,"GFWList",-1),b=n("code",null,"geosite:apple",-1),h=n("code",null,"geosite:icloud",-1),y=n("code",null,"[proxy]",-1),_=n("code",null,"geosite:apple-update",-1),A=n("code",null,"[direct]",-1),f={class:"custom-container warning"},x=n("p",{class:"custom-container-title"},"Внимание",-1),E=n("p",null,[n("strong",null,"Внимание:"),s(" на данный момент существует несколько вариантов файла "),n("code",null,"geosite.dat"),s(":")],-1),F=n("code",null,"Victoria Raymond",-1),S=n("code",null,"Project V",-1),C={href:"https://github.com/v2ray/domain-list-community",target:"_blank",rel:"noopener noreferrer"},V=n("code",null,"domain-list-community",-1),j=n("code",null,"Project V",-1),X=n("code",null,"v2fly",-1),O={href:"https://github.com/v2fly/domain-list-community",target:"_blank",rel:"noopener noreferrer"},R=n("code",null,"domain-list-community",-1),I=n("a",{href:"Loyalsoldier"},"@Loyalsoldier",-1),L={href:"https://github.com/Loyalsoldier/v2ray-rules-dat",target:"_blank",rel:"noopener noreferrer"},P=n("code",null,"Project X",-1),T={href:"https://github.com/XTLS/Xray-rules-dat",target:"_blank",rel:"noopener noreferrer"},w=n("code",null,"Xray",-1),N=n("s",null,"(Как видите, папка уже создана, так что это дело времени)",-1),G=n("p",null,[s("Вы даже можете создать свой собственный файл "),n("code",null,"geosite"),s(" и подключить его к "),n("code",null,"Xray"),s(", но это выходит за рамки данной статьи, поэтому мы не будем на этом останавливаться.")],-1),M=n("p",null,"Если вы обнаружите, что некоторые домены не классифицированы должным образом, пожалуйста, создайте issue или отправьте pull request в один из перечисленных выше проектов! Поддерживайте сообщество - каждый за всех, и все за одного!",-1),W=a('<h3 id="_3-6-секретное-оружие-скрытое-правило-маршрутизации" tabindex="-1"><a class="header-anchor" href="#_3-6-секретное-оружие-скрытое-правило-маршрутизации"><span>3.6 Секретное оружие: скрытое правило маршрутизации</span></a></h3><p>На самом деле, если вы внимательно посмотрите на приведенные выше правила, то заметите одну проблему: все наши правила определяют только то, <strong>куда</strong> следует перенаправлять входящий трафик, <strong>если он соответствует определенному условию</strong>. Но что произойдет, если файл <code>geosite.dat</code> неполный, и наш входящий трафик <strong>не соответствует ни одному условию</strong>? Как поступит <code>Xray</code>?</p><div class="custom-container warning"><p class="custom-container-title">Внимание</p><p>Если вы думаете, что <strong>если условие не выполняется, то соединение не будет установлено</strong>, то вам нужно подумать еще раз. Соединение будет разорвано только в том случае, если указано правило <code>[block]</code>, которое перенаправляет трафик в &quot;черную дыру&quot; (<code>blackhole</code>).</p></div><p>На самом деле, чтобы избежать путаницы из-за неполных правил маршрутизации, <code>Xray</code> предоставляет скрытое правило: <strong>если входящий трафик не соответствует ни одному условию, он перенаправляется на первый исходящий трафик</strong>.</p><p>Таким образом, ни один трафик не будет потерян. Поэтому важно поместить ваш самый надежный исходящий трафик на <strong>первое место</strong>, чтобы он служил вам верным стражем.</p><h3 id="_3-7-снова-смотрим-на-карту-трех-царств" tabindex="-1"><a class="header-anchor" href="#_3-7-снова-смотрим-на-карту-трех-царств"><span>3.7 Снова смотрим на карту &quot;трех царств&quot;</span></a></h3><p>Поскольку в предыдущем примере мы поместили <code>[proxy-out-vless]</code> на первое место в списке исходящего трафика, при срабатывании скрытого правила трафик будет перенаправляться на удаленный VPS по протоколу <code>VLESS</code>. Таким образом, полная логика работы <code>Xray</code> выглядит следующим образом:</p>',7),z=a(`<p>Фактически, это и есть то, что традиционно называется <strong>&quot;проксирование по умолчанию, прямой доступ к внутренним сайтам по белому списку&quot;</strong>.</p><h2 id="_4-разделение-мира-на-три-части-битва-вэи-и-шу" tabindex="-1"><a class="header-anchor" href="#_4-разделение-мира-на-три-части-битва-вэи-и-шу"><span>4. &quot;Разделение мира на три части&quot; - &quot;Битва Вэй и Шу&quot;</span></a></h2><p>Теперь, когда вы знаете о скрытом правиле маршрутизации по умолчанию (<strong>&quot;если входящий трафик не соответствует ни одному условию, он перенаправляется на первый исходящий трафик&quot;</strong>), вы должны понимать, что то, будет ли <strong>проксирование</strong> или <strong>прямое подключение</strong> основным режимом работы, зависит от того, какой исходящий трафик стоит на первом месте!</p><p>На предыдущем шаге мы настроили правило <strong>&quot;проксирование по умолчанию, прямой доступ к внутренним сайтам по белому списку&quot;</strong>. Теперь, чтобы получить правило <strong>&quot;прямое подключение по умолчанию, проксирование иностранных сайтов по белому списку&quot;</strong>, нам просто нужно <strong>поместить правило прямого подключения на первое место</strong>.</p><p>Это очень просто, не правда ли?</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;direct-out&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;freedom&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;proxy-out-vless&quot;</span>
      <span class="token comment">// ... ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;block&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blackhole&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Теперь правила маршрутизации выглядят так:</p>`,7),H=n("p",null,"В этом и заключается гибкость функции маршрутизации - вы можете свободно менять порядок правил для достижения различных результатов.",-1),J=n("p",null,[s("На этом мы закончили объяснение того, "),n("strong",null,[s("как использовать файл "),n("code",null,"geosite.dat"),s(" для разделения сетевого трафика по доменному имени с помощью правил маршрутизации")]),s(".")],-1),K=n("h2",{id:"_5-покорение-новых-высот-различные-условия-сопоставления-маршрутов",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_5-покорение-новых-высот-различные-условия-сопоставления-маршрутов"},[n("span",null,"5. Покорение новых высот - Различные условия сопоставления маршрутов")])],-1),Q=n("p",null,[s("Пожалуйста, убедитесь, что вы хорошо усвоили материал, изложенный выше, поскольку это основа для понимания принципов работы "),n("strong",null,"функции маршрутизации"),s(". Имея эту базу, мы можем двигаться дальше и рассмотреть более подробные параметры конфигурации и условия сопоставления.")],-1);function U(Y,Z){const c=p("I18nTip"),e=p("Mermaid"),t=p("ExternalLinkIcon"),l=p("RouterLink");return u(),r("div",null,[o(c),k,o(e,{id:"mermaid-37",code:"%20%20%20%20graph%20LR;%0A%0A%20%20%20%20S(%D0%94%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F)%20.-%3E%20I%5B%D0%92%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%5D%0A%0A%20%20%20%20subgraph%20Xray%0A%20%20%20%20I%20--%3E%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%3E%20O%5B%D0%98%D1%81%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%5D%0A%20%20%20%20end%0A%0A%20%20%20%20O%20.-%3E%20V(VPS)%0A%0A%20%20%20%20V:::greyclass%0A%20%20%20%20S:::greyclass%0A%20%20%20%20R:::routingclass%0A%20%20%20%20classDef%20greyclass%20fill:#C0C0C0%0A%20%20%20%20classDef%20routingclass%20fill:#FFFFDE%0A%0A"}),q,o(e,{id:"mermaid-191",code:"%20%20%20%20graph%20LR;%0A%0A%20%20%20%20S(%D0%94%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F)%20.-%3E%20I%5B%D0%92%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%5D%0A%0A%20%20%20%20subgraph%20Xray%0A%20%20%20%20I%20--%3E%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:category-ads-all%22%20--%3E%20O1%5Bblock%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:cn%22%20--%3E%20O2%5Bdirect%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:geolocation-!cn%22%20--%3E%20O3%5Bproxy%5D%0A%0A%20%20%20%20end%0A%0A%20%20%20%20O2%20.-%3E%20D(%D0%92%D0%BD%D1%83%D1%82%D1%80%D0%B5%D0%BD%D0%BD%D0%B8%D0%B9%20%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80)%0A%20%20%20%20O3%20.-%3E%20V(VPS)%0A%0A%20%20%20%20O1:::redclass%0A%20%20%20%20V:::greyclass%0A%20%20%20%20S:::greyclass%0A%20%20%20%20R:::routingclass%0A%0A%20%20%20%20classDef%20redclass%20fill:#FF0000%0A%20%20%20%20classDef%20greyclass%20fill:#C0C0C0%0A%20%20%20%20classDef%20routingclass%20fill:#FFFFDE,stroke:#000000%0A%0A"}),v,n("p",null,[s("Такая модульная структура обеспечивает гораздо большую гибкость, чем традиционный список заблокированных доменов "),n("a",B,[m,o(t)]),s(". Например, вы можете указать, что домены Apple ("),b,s(") и домены, связанные с iCloud ("),h,s("), должны проксироваться ("),y,s("), а домены обновлений Apple ("),_,s(") должны подключаться напрямую ("),A,s(") для максимальной скорости загрузки.")]),n("div",f,[x,E,n("ul",null,[n("li",null,[s("Изначально, когда "),F,s(" активно занималась проектом "),S,s(", она предоставляла соответствующий проект "),n("a",C,[V,o(t)]),s(", который использовался для сбора, хранения и классификации часто используемых типов доменов.")]),n("li",null,[s("После того, как Виктория внезапно исчезла, и разработка "),j,s(" приостановилась, сообщество "),X,s(" продолжило поддерживать и обновлять свою версию "),n("a",O,[R,o(t)]),s(".")]),n("li",null,[s("В то же время "),I,s(" ведет свой собственный, модифицированный и расширенный файл правил маршрутизации "),n("a",L,[s("v2ray-rules-dat"),o(t)]),s(", который предлагает множество различных вариантов и логики классификации.")]),n("li",null,[s("Кроме того, команда "),P,s(" планирует в будущем создать и поддерживать файл правил маршрутизации "),n("a",T,[s("Xray-rules-dat"),o(t)]),s(", который будет лучше подходить для использования с "),w,s(". "),N])]),G,M]),W,o(e,{id:"mermaid-404",code:"%20%20%20%20graph%20LR;%0A%0A%20%20%20%20S(%D0%94%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F)%20.-%3E%20I%5B%D0%92%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%5D%0A%0A%20%20%20%20subgraph%20Xray%0A%20%20%20%20I%20--%3E%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:category-ads-all%22%20--%3E%20O1%5Bblock%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:cn%22%20--%3E%20O2%5Bdirect%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:geolocation-!cn%22%20--%3E%20O3%5Bproxy%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20-.%20%22%D0%A2%D1%80%D0%B0%D1%84%D0%B8%D0%BA,%20%D0%BD%D0%B5%20%D1%81%D0%BE%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B8%D0%B9%20%D0%BD%D0%B8%20%D0%BE%D0%B4%D0%BD%D0%BE%D0%BC%D1%83%20%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D1%83%22%20.-%3E%20O4%5B%D0%9F%D0%B5%D1%80%D0%B2%D1%8B%D0%B9%20%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%5D%0A%0A%20%20%20%20end%0A%0A%20%20%20%20O2%20.-%3E%20D(%D0%92%D0%BD%D1%83%D1%82%D1%80%D0%B5%D0%BD%D0%BD%D0%B8%D0%B9%20%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80)%0A%20%20%20%20O3%20.-%3E%20V(VPS)%0A%20%20%20%20O4%20.-%3E%20V(VPS)%0A%0A%20%20%20%20O1:::redclass%0A%20%20%20%20V:::greyclass%0A%20%20%20%20S:::greyclass%0A%20%20%20%20R:::routingclass%0A%0A%20%20%20%20classDef%20redclass%20fill:#FF0000%0A%20%20%20%20classDef%20greyclass%20fill:#C0C0C0%0A%20%20%20%20classDef%20routingclass%20fill:#FFFFDE,stroke:#000000%0A%0A"}),z,o(e,{id:"mermaid-424",code:"%20%20%20%20graph%20LR;%0A%0A%20%20%20%20S(%D0%94%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F)%20.-%3E%20I%5B%D0%92%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%5D%0A%0A%20%20%20%20subgraph%20Xray%0A%20%20%20%20I%20--%3E%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:category-ads-all%22%20--%3E%20O1%5Bblock%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:geolocation-!cn%22%20--%3E%20O3%5Bproxy%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20--%20%22geosite:cn%22%20--%3E%20O2%5Bdirect%5D%0A%20%20%20%20R%5B%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D%20-.%20%22%D0%A2%D1%80%D0%B0%D1%84%D0%B8%D0%BA,%20%D0%BD%D0%B5%20%D1%81%D0%BE%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B8%D0%B9%20%D0%BD%D0%B8%20%D0%BE%D0%B4%D0%BD%D0%BE%D0%BC%D1%83%20%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D1%83%22%20.-%3E%20O4%5B%D0%9F%D0%B5%D1%80%D0%B2%D1%8B%D0%B9%20%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%5D%0A%0A%20%20%20%20end%0A%0A%20%20%20%20O2%20.-%3E%20D(%D0%92%D0%BD%D1%83%D1%82%D1%80%D0%B5%D0%BD%D0%BD%D0%B8%D0%B9%20%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80)%0A%20%20%20%20O3%20.-%3E%20V(VPS)%0A%20%20%20%20O4%20.-%3E%20D%0A%0A%20%20%20%20O1:::redclass%0A%20%20%20%20V:::greyclass%0A%20%20%20%20S:::greyclass%0A%20%20%20%20R:::routingclass%0A%20%20%20%20classDef%20redclass%20fill:#FF0000%0A%20%20%20%20classDef%20greyclass%20fill:#C0C0C0%0A%20%20%20%20classDef%20routingclass%20fill:#FFFFDE,stroke:#000000%0A%0A"}),H,J,K,Q,n("p",null,[s("После того, как вы прочитаете следующий раздел, вы сможете свободно настраивать свои собственные правила маршрутизации! Так чего же мы ждем? Давайте перейдем к "),o(l,{to:"/ru/document/level-1/routing-lv1-part2.html"},{default:d(()=>[s("части 2")]),_:1}),s("!")])])}const nn=i(g,[["render",U],["__file","routing-lv1-part1.html.vue"]]);export{nn as default};
