<!doctype html><html><head><title>Transparent proxy to circumvent Xray traffic via gid :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-05-26T12:19:00 UTC"><meta name=description content="Project X Documentation."><meta name=author content="Project X"><title>Transparent proxy to circumvent Xray traffic via gid :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https://xtls.github.io"</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/en/documents/level-2/iptables_gid/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https://xtls.github.io/en"</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/en/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i>
<a href=/en/about/>Project X&nbsp;âš¡</a><ul><li data-nav-id=https://xtls.github.io/en/about/new/ class="dd-item
item_level_$level"><a href=/en/about/new/>X History&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/en/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/en/guide/>Quick start&nbsp;</a></li><li data-nav-id=https://xtls.github.io/en/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i>
<a href=/en/config/>Configuration files&nbsp;ğŸ“œ</a><ul><li data-nav-id=https://xtls.github.io/en/config/base/ class="dd-item haschildren
item_level_$level"><a href=/en/config/base/>Basic configuration module&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/en/config/base/log/ class="dd-item
item_level_$level"><a href=/en/config/base/log/>æ—¥å¿—é…ç½®</a></li><li data-nav-id=https://xtls.github.io/en/config/base/api/ class="dd-item
item_level_$level"><a href=/en/config/base/api/>API interfaces</a></li><li data-nav-id=https://xtls.github.io/en/config/base/dns/ class="dd-item
item_level_$level"><a href=/en/config/base/dns/>Built-in dns server</a></li><li data-nav-id=https://xtls.github.io/en/config/base/routing/ class="dd-item
item_level_$level"><a href=/en/config/base/routing/>Routing</a></li><li data-nav-id=https://xtls.github.io/en/config/base/policy/ class="dd-item
item_level_$level"><a href=/en/config/base/policy/>æœ¬åœ°ç­–ç•¥</a></li><li data-nav-id=https://xtls.github.io/en/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/en/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/en/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/en/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/en/config/base/transport/ class="dd-item
item_level_$level"><a href=/en/config/base/transport/>ä¼ è¾“æ–¹å¼</a></li><li data-nav-id=https://xtls.github.io/en/config/base/stats/ class="dd-item
item_level_$level"><a href=/en/config/base/stats/>ç»Ÿè®¡ä¿¡æ¯</a></li><li data-nav-id=https://xtls.github.io/en/config/base/reverse/ class="dd-item
item_level_$level"><a href=/en/config/base/reverse/>åå‘ä»£ç†</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/en/config/inbound-protocols/>Inbounds å¯ç”¨åè®®åˆ—è¡¨</a></li><li data-nav-id=https://xtls.github.io/en/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/en/config/outbound-protocols/>Outbounds å¯ç”¨åè®®åˆ—è¡¨</a></li><li data-nav-id=https://xtls.github.io/en/config/transports/ class="dd-item
item_level_$level"><a href=/en/config/transports/>ä¼ è¾“æ–¹å¼åˆ—è¡¨</a></li><li data-nav-id=https://xtls.github.io/en/config/fallback/ class="dd-item
item_level_$level"><a href=/en/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/en/config/xtls/ class="dd-item
item_level_$level"><a href=/en/config/xtls/>XTLS</a></li><li data-nav-id=https://xtls.github.io/en/config/env/ class="dd-item
item_level_$level"><a href=/en/config/env/>Environment Variables</a></li><li data-nav-id=https://xtls.github.io/en/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/en/config/multiple_config/>å¤šæ–‡ä»¶é…ç½®</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i>
<a href=/en/documents/>Using Experiences&nbsp;ğŸ“š</a><ul><li data-nav-id=https://xtls.github.io/en/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/en/documents/level-0/>å°å°ç™½ç™½è¯æ–‡&nbsp;ğŸ“™</a></li><li data-nav-id=https://xtls.github.io/en/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/en/documents/level-1/>Getting Started Skills&nbsp;</a></li><li data-nav-id=https://xtls.github.io/en/documents/level-2/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/en/documents/level-2/>Advanced Documentation&nbsp;ğŸ“˜</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i>
<a href=/en/develop/>å¼€å‘æŒ‡å—&nbsp;ğŸ–¥ï¸</a><ul><li data-nav-id=https://xtls.github.io/en/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/en/develop/intro/>å¼€å‘æ‰‹å†Œ</a></li><li data-nav-id=https://xtls.github.io/en/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/en/develop/protocols/>åè®®è¯¦è§£</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/en/faq/>å¸¸è§é—®ç­”&nbsp;ğŸ’¬</a></li><li data-nav-id=https://xtls.github.io/en/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/en/caseslip/>å¤§æ¡ˆç‰æœ¯&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/en/links/ class="dd-item alwaysopen
item_level_$level"><a href=/en/links/>å¸¸ç”¨é“¾æ¥&nbsp;ğŸ¤</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io>Home</a></li><li><a class=text-link href=/en/documents/>Using Experiences</a></li><li><a class=text-link href=/en/documents/level-2/>Advanced Documentation</a></li><li class=active>Transparent proxy to circumvent Xray traffic via gid</li></ol></nav><h1>Advanced Documentation<span>Transparent proxy to circumvent Xray traffic via gid</span></h1><nav class=subpages><li><a title=$pagetitle href=/en/documents/level-2/transparent_proxy/transparent_proxy/>Getting Started with Transparent Proxy</a></li><li><a title=$pagetitle href=/en/documents/level-2/tproxy/>TProxy Configuration</a></li><li class=active><a title=$pagetitle href=/en/documents/level-2/iptables_gid/>Transparent proxy to circumvent Xray traffic via gid</a></li></nav><div class=jump-to-section><span onclick="$h=$(this),$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#ideas>Ideas</a></li><li><a href=#configuration-procedure>Configuration Procedure</a><ul><li><a href=#1-preliminary-preparation>1. Preliminary preparation</a></li><li><a href=#2-add-user-android-users-please-ignore-this-section>2. Add user (Android users please ignore this section)</a></li><li><a href=#3-configure-and-run-xray-and-configure-iptables-rules>3. Configure and run Xray, and configure iptables rules</a></li></ul></li><li><a href=#the-following-provides-a-complete-configuration-process-for-implementing-the-tproxy-global-proxy>The following provides a complete configuration process for implementing the tproxy global proxy</a><ul><li><a href=#1-finish-preliminary-preparation1-preliminary_preparation-å’Œ-add-user2-add_user>1. Finish <strong><a href=#1-Preliminary_preparation>Preliminary preparation</a></strong> å’Œ <strong><a href=#2-Add_user>Add user</a></strong></a></li><li><a href=#2-preparing-xray-profiles>2. Preparing Xray profiles</a></li><li><a href=#3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client>3. Configuring the maximum number of open files and run the Xray client</a></li><li><a href=#4-setting-up-iptables-rules>4. Setting up iptables rules</a></li></ul></li></ul></nav></div><div class=content><p>In the existing transparent proxy configuration(<strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>New V2Ray vernacular tutorial on transparent proxy</a></strong> ã€ <strong><a href=https://guide.v2fly.org/app/tproxy.html>New V2Ray vernacular tutorial on transparent proxy (TProxy)</a></strong> ã€ <strong><a href=../tproxy>Transparent proxyï¼ˆTProxyï¼‰configuration tutorial</a></strong>)tutorials, the circumvention of Xray traffic is achieved by using mark. That is, mark the Xray outbound traffic and circumvent the Xray traffic by setting up iptables rules for direct connection of the traffic corresponding to the mark to prevent loopback.</p><p>There are several problems with this method:</p><ol><li><p><strong><a href=https://github.com/v2ray/v2ray-core/issues/2621>Inexplicable traffic into PREROUTING chain</a></strong></p></li><li><p>Android has its own mark mechanism and this solution is not available on Android</p></li></ol><p>The solution in this tutorial does not require a mark setting and has a higher theoretical performance, as well as not having the problems mentioned above.</p><h2 ref=ideas>Ideas</h2><a class=anchor id=ideas></a><p>TProxy traffic can only be received by users with root privileges (uid==0) or other users with CAP_NET_ADMIN privileges.</p><p>The iptables rules can separate network traffic by uid (user id) and gid (user group id).
Let Xray run on a user with uid==0 but gid!=0. Set the iptables rule to not proxy traffic for that gid to circumvent Xray traffic.</p><h2 ref=configuration-procedure>Configuration Procedure</h2><a class=anchor id=configuration-procedure></a><h3 ref=1-preliminary-preparation>1. Preliminary preparation</h3><a class=anchor id=1-preliminary-preparation></a><p><strong>Android</strong></p><ol><li><p>System has root privilege.</p></li><li><p>Install <strong><a href="https://play.google.com/store/apps/details?id=stericson.busybox">busybox</a></strong></p></li><li><p>There is a terminal that can execute commands, you can use adb shell, termux etc.</p></li></ol><p><strong>Other Linux system</strong></p><p>Need sudo, iptables-tproxy module and iptables-extra moduleã€‚</p><p>Usually the system comes with these functions. If you are using openwrt, you will need to run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>opkg install sudo iptables-mod-tproxy iptables-mod-extra
</code></pre></div><p>Also attached are some common dependencies for openwrt, the lack of which may prevent Xray from running</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>opkg install libopenssl ca-certificates
</code></pre></div><h3 ref=2-add-user-android-users-please-ignore-this-section>2. Add user (Android users please ignore this section)</h3><a class=anchor id=2-add-user-android-users-please-ignore-this-section></a><p>Android does not support managing users by modifying the /etc/passwd file, please ignore it and go straight to the next step.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>grep -qw xray_tproxy /etc/passwd <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#34;xray_tproxy:x:0:23333:::&#34;</span> &gt;&gt; /etc/passwd
</code></pre></div><p>where xray_tproxy is the username, 0 is the uid and 23333 is the gid, the username and gid can be set by yourself, the uid must be 0.
To check if the user was added successfully, run</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo -u xray_tproxy id
</code></pre></div><p>The result displayed should be uid 0 and gid 23333.</p><h3 ref=3-configure-and-run-xray-and-configure-iptables-rules>3. Configure and run Xray, and configure iptables rules</h3><a class=anchor id=3-configure-and-run-xray-and-configure-iptables-rules></a><p>In the existing transparent proxy configuration(<strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>New V2Ray vernacular tutorial on transparent proxy</a></strong> ã€ <strong><a href=https://guide.v2fly.org/app/tproxy.html>New V2Ray vernacular tutorial on transparent proxy (TProxy)</a></strong> ã€ <strong><a href=../tproxy>Transparent proxyï¼ˆTProxyï¼‰configuration tutorial</a></strong>)tutorials, modify:</p><ol><li><p>Modify the json configuration file: remove mark-related content</p></li><li><p>Modify the iptables rule to remove the mark-related content and add the option at the OUTPUT chain application rule: &ldquo;-m owner ! &ndash;gid-owner 23333&rdquo;</p></li></ol><p>e.g.:</p><p><code>iptables -t mangle -A OUTPUT -j XRAY_SELF</code></p><p>Change to</p><p><code>iptables -t mangle -A OUTPUT -m owner ! --gid-owner 23333 -j XRAY_SELF</code></p><ol><li>Modify the way you run Xray so that it runs on a user with uid 0 and gid 23333, refer to <a href=#3-the_maximum_number_of_file_wide_openings>here</a>.</li></ol><h2 ref=the-following-provides-a-complete-configuration-process-for-implementing-the-tproxy-global-proxy>The following provides a complete configuration process for implementing the tproxy global proxy</h2><a class=anchor id=the-following-provides-a-complete-configuration-process-for-implementing-the-tproxy-global-proxy></a><h3 ref=1-finish-preliminary-preparation1-preliminary_preparation-å’Œ-add-user2-add_user>1. Finish <strong><a href=#1-Preliminary_preparation>Preliminary preparation</a></strong> å’Œ <strong><a href=#2-Add_user>Add user</a></strong></h3><a class=anchor id=1-finish-preliminary-preparation1-preliminary_preparation-å’Œ-add-user2-add_user></a><h3 ref=2-preparing-xray-profiles>2. Preparing Xray profiles</h3><a class=anchor id=2-preparing-xray-profiles></a><p>Configure Xray to listen to 12345 at dokodemo-door, turn on followRedirect and tproxy, no sniffing required:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;inbounds&#34;</span>: [
    {
      <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>12345</span>,
      <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dokodemo-door&#34;</span>,
      <span style=color:#f92672>&#34;settings&#34;</span>: {
        <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp,udp&#34;</span>,
        <span style=color:#f92672>&#34;followRedirect&#34;</span>: <span style=color:#66d9ef>true</span>
      },
      <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
        <span style=color:#f92672>&#34;sockopt&#34;</span>: {
          <span style=color:#f92672>&#34;tproxy&#34;</span>: <span style=color:#e6db74>&#34;tproxy&#34;</span>
        }
      }
    }
  ],
  <span style=color:#f92672>&#34;outbounds&#34;</span>: [
    {
        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#960050;background-color:#1e0010>Your</span> <span style=color:#960050;background-color:#1e0010>server</span> <span style=color:#960050;background-color:#1e0010>configuration</span>
    }
  ]
}
</code></pre></div><h3 ref=3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client>3. Configuring the maximum number of open files and run the Xray client</h3><a class=anchor id=3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client></a><p>About the maximum number of open files, see: <strong><a href=https://guide.v2fly.org/app/tproxy.html#%E8%A7%A3%E5%86%B3-too-many-open-files-%E9%97%AE%E9%A2%98>too many open files issues</a></strong></p><p>The current Xray server installed with the official script has the maximum number of open files automatically configured, so no further changes are required.</p><p><strong>Android</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ulimit -SHn <span style=color:#ae81ff>1000000</span>
setuidgid 0:23333 <span style=color:#e6db74>&#34;Command to run Xray&#34;</span>&amp;
</code></pre></div><p><strong>Other Linux system</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ulimit -SHn <span style=color:#ae81ff>1000000</span>
sudo -u xray_tproxy <span style=color:#e6db74>&#34;Command to run Xray&#34;</span>&amp;
</code></pre></div><p>e.g.:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ulimit -SHn <span style=color:#ae81ff>1000000</span>
sudo -u xray_tproxy xray -c /etc/xray/config.json &amp;
</code></pre></div><p><em>The first command:</em></p><p>Change the maximum number of open files, valid only for the current terminal and to be run every time before starting Xray, this command is to set the maximum number of open files for the client.</p><p><em>The second command:</em></p><p>Run the Xray client as a user with uid 0 and gid not 0, followed by & for running in the background.</p><p><strong>Check that the maximum number of open files is set successfully</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>cat /proc/<span style=color:#e6db74>&#34;Xray&#39;s pid&#34;</span>/limits
</code></pre></div><p>Find max open files, which should be the value you set. Xray&rsquo;s pid can be obtained by running <code>ps</code> or <code>ps -aux</code> or <code>ps -a</code></p><p>Both the server and client side should be checked.</p><h3 ref=4-setting-up-iptables-rules>4. Setting up iptables rules</h3><a class=anchor id=4-setting-up-iptables-rules></a><p><strong>Proxy ipv4</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>

<span style=color:#75715e># Proxy LAN devices</span>
iptables -t mangle -N XRAY
<span style=color:#75715e># &#34;ipv4 segment where the gateway is located&#34; is obtained by running the command &#34;ip address | grep -w inet | awk &#39;{print $2}&#39;&#34;, usually there are multiple</span>
iptables -t mangle -A XRAY -d <span style=color:#e6db74>&#34;first ipv4 segment where the gateway is located&#34;</span> -j RETURN
iptables -t mangle -A XRAY -d <span style=color:#e6db74>&#34;second ipv4 segment where the gateway is located&#34;</span> -j RETURN

<span style=color:#75715e># If the gateway is used as the primary router, add this line, see: [Other considerations for transparent proxy of iptables](https://xtls.github.io/en/documents/level-2/transparent_proxy/transparent_proxy/#proxy-ipv6)</span>
<span style=color:#75715e># The &#34;gateway LAN_IPv4 address segment&#34;, obtained by running the command &#34;ip address | grep -w &#34;inet&#34; | awk &#39;{print $2}&#39;&#34;, is one of the results</span>
iptables -t mangle -A XRAY ! -s <span style=color:#e6db74>&#34;gateway LAN_IPv4 address segment&#34;</span> -j RETURN

<span style=color:#75715e># Mark 1 for TCP and forward to port 12345</span>
<span style=color:#75715e># mark can only be set to 1 for the traffic to be accepted by the Xray dokodemo-door</span>
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
<span style=color:#75715e># Apply rules</span>
iptables -t mangle -A PREROUTING -j XRAY

<span style=color:#75715e># Proxy gateway itself</span>
iptables -t mangle -N XRAY_MASK
iptables -t mangle -A XRAY_MASK -d <span style=color:#e6db74>&#34;the first ipv4 segment where the gateway is located&#34;</span> -j RETURN
iptables -t mangle -A XRAY_MASK -d <span style=color:#e6db74>&#34;the second ipv4 segment where the gateway is located&#34;</span> -j RETURN

iptables -t mangle -A XRAY_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A OUTPUT -m owner ! --gid-owner <span style=color:#ae81ff>23333</span> ! -p icmp -j XRAY_MASK
</code></pre></div><p><strong>Proxy ipv6 (optional)</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip -6 rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>106</span>
ip -6 route add local ::/0 dev lo table <span style=color:#ae81ff>106</span>

<span style=color:#75715e># Proxy LAN devices</span>
ip6tables -t mangle -N XRAY6
<span style=color:#75715e># The &#34;ipv6 segment where the gateway is located&#34; is obtained by running the command &#34;ip address | grep -w inet6 | awk &#39;{print $2}&#39;&#34;.</span>
ip6tables -t mangle -A XRAY6 -d <span style=color:#e6db74>&#34;the first ipv6 segment where the gateway is located&#34;</span> -j RETURN
ip6tables -t mangle -A XRAY6 -d <span style=color:#e6db74>&#34;the second ipv6 segment where the gateway is located&#34;</span> -j RETURN

<span style=color:#75715e># If the gateway is used as the primary router, add this line, see: [Other considerations for transparent proxy of iptables](https://xtls.github.io/en/documents/level-2/transparent_proxy/transparent_proxy/#proxy-ipv6)</span>
<span style=color:#75715e># The &#34;gateway LAN_IPv6 address segment&#34;, obtained by running the command &#34;ip address | grep -w &#34;inet6&#34; | awk &#39;{print $2}&#39;&#34;, is one of the results</span>
ip6tables -t mangle -A XRAY6 ! -s <span style=color:#e6db74>&#34;gateway LAN_IPv6 address segment&#34;</span> -j RETURN

ip6tables -t mangle -A XRAY6 -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A XRAY6 -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A PREROUTING -j XRAY6

<span style=color:#75715e># Proxy gateway itself</span>
ip6tables -t mangle -N XRAY6_MASK 
ip6tables -t mangle -A XRAY6_MASK -d <span style=color:#e6db74>&#34;the first ipv6 segment where the gateway is located&#34;</span> -j RETURN
ip6tables -t mangle -A XRAY6_MASK -d <span style=color:#e6db74>&#34;the second ipv6 segment where the gateway is located&#34;</span> -j RETURN

ip6tables -t mangle -A XRAY6_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A OUTPUT -m owner ! --gid-owner <span style=color:#ae81ff>23333</span> ! -p icmp -j XRAY6_MASK
</code></pre></div></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/en/documents/level-2/iptables_gid/>Transparent proxy to circumvent Xray traffic via gid</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#ideas>Ideas</a></li><li><a href=#configuration-procedure>Configuration Procedure</a><ul><li><a href=#1-preliminary-preparation>1. Preliminary preparation</a></li><li><a href=#2-add-user-android-users-please-ignore-this-section>2. Add user (Android users please ignore this section)</a></li><li><a href=#3-configure-and-run-xray-and-configure-iptables-rules>3. Configure and run Xray, and configure iptables rules</a></li></ul></li><li><a href=#the-following-provides-a-complete-configuration-process-for-implementing-the-tproxy-global-proxy>The following provides a complete configuration process for implementing the tproxy global proxy</a><ul><li><a href=#1-finish-preliminary-preparation1-preliminary_preparation-å’Œ-add-user2-add_user>1. Finish <strong><a href=#1-Preliminary_preparation>Preliminary preparation</a></strong> å’Œ <strong><a href=#2-Add_user>Add user</a></strong></a></li><li><a href=#2-preparing-xray-profiles>2. Preparing Xray profiles</a></li><li><a href=#3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client>3. Configuring the maximum number of open files and run the Xray client</a></li><li><a href=#4-setting-up-iptables-rules>4. Setting up iptables rules</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-2/iptables_gid.md target=blank><i class="fab fa-github"></i>
Improve this page</a></li><li><i class="fas fa-calendar"></i>
Last update on 23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>