<!doctype html><html><head><title>Getting Started with Transparent Proxy :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-03-16T01:03:16 UTC"><meta name=description content="Project X Documentation."><meta name=author content="Project X"><title>Getting Started with Transparent Proxy :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https://xtls.github.io"</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/en/documents/level-2/transparent_proxy/transparent_proxy/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https://xtls.github.io/en"</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/en/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/en/about/>Project X&nbsp;‚ö°</a><ul><li data-nav-id=https://xtls.github.io/en/about/new/ class="dd-item
item_level_$level"><a href=/en/about/new/>X History&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/en/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/en/guide/>Quick start&nbsp;</a></li><li data-nav-id=https://xtls.github.io/en/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/en/config/>Configuration files&nbsp;üìú</a><ul><li data-nav-id=https://xtls.github.io/en/config/base/ class="dd-item haschildren
item_level_$level"><a href=/en/config/base/>Basic configuration module&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/en/config/base/log/ class="dd-item
item_level_$level"><a href=/en/config/base/log/>Êó•ÂøóÈÖçÁΩÆ</a></li><li data-nav-id=https://xtls.github.io/en/config/base/api/ class="dd-item
item_level_$level"><a href=/en/config/base/api/>API interfaces</a></li><li data-nav-id=https://xtls.github.io/en/config/base/dns/ class="dd-item
item_level_$level"><a href=/en/config/base/dns/>Built-in dns server</a></li><li data-nav-id=https://xtls.github.io/en/config/base/routing/ class="dd-item
item_level_$level"><a href=/en/config/base/routing/>Routing</a></li><li data-nav-id=https://xtls.github.io/en/config/base/policy/ class="dd-item
item_level_$level"><a href=/en/config/base/policy/>Êú¨Âú∞Á≠ñÁï•</a></li><li data-nav-id=https://xtls.github.io/en/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/en/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/en/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/en/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/en/config/base/transport/ class="dd-item
item_level_$level"><a href=/en/config/base/transport/>‰º†ËæìÊñπÂºè</a></li><li data-nav-id=https://xtls.github.io/en/config/base/stats/ class="dd-item
item_level_$level"><a href=/en/config/base/stats/>ÁªüËÆ°‰ø°ÊÅØ</a></li><li data-nav-id=https://xtls.github.io/en/config/base/reverse/ class="dd-item
item_level_$level"><a href=/en/config/base/reverse/>ÂèçÂêë‰ª£ÁêÜ</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/en/config/inbound-protocols/>Inbounds ÂèØÁî®ÂçèËÆÆÂàóË°®</a></li><li data-nav-id=https://xtls.github.io/en/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/en/config/outbound-protocols/>Outbounds ÂèØÁî®ÂçèËÆÆÂàóË°®</a></li><li data-nav-id=https://xtls.github.io/en/config/transports/ class="dd-item
item_level_$level"><a href=/en/config/transports/>‰º†ËæìÊñπÂºèÂàóË°®</a></li><li data-nav-id=https://xtls.github.io/en/config/fallback/ class="dd-item
item_level_$level"><a href=/en/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/en/config/xtls/ class="dd-item
item_level_$level"><a href=/en/config/xtls/>XTLS</a></li><li data-nav-id=https://xtls.github.io/en/config/env/ class="dd-item
item_level_$level"><a href=/en/config/env/>Environment Variables</a></li><li data-nav-id=https://xtls.github.io/en/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/en/config/multiple_config/>Â§öÊñá‰ª∂ÈÖçÁΩÆ</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/en/documents/>Using Experiences&nbsp;üìö</a><ul><li data-nav-id=https://xtls.github.io/en/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/en/documents/level-0/>Â∞èÂ∞èÁôΩÁôΩËØùÊñá&nbsp;üìô</a></li><li data-nav-id=https://xtls.github.io/en/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/en/documents/level-1/>Getting Started Skills&nbsp;</a></li><li data-nav-id=https://xtls.github.io/en/documents/level-2/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/en/documents/level-2/>Advanced Documentation&nbsp;üìò</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/en/develop/>ÂºÄÂèëÊåáÂçó&nbsp;üñ•Ô∏è</a><ul><li data-nav-id=https://xtls.github.io/en/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/en/develop/intro/>ÂºÄÂèëÊâãÂÜå</a></li><li data-nav-id=https://xtls.github.io/en/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/en/develop/protocols/>ÂçèËÆÆËØ¶Ëß£</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/en/faq/>Â∏∏ËßÅÈóÆÁ≠î&nbsp;üí¨</a></li><li data-nav-id=https://xtls.github.io/en/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/en/caseslip/>Â§ßÊ°àÁâçÊúØ&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/en/links/ class="dd-item alwaysopen
item_level_$level"><a href=/en/links/>Â∏∏Áî®ÈìæÊé•&nbsp;ü§ù</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io>Home</a></li><li><a class=text-link href=/en/documents/>Using Experiences</a></li><li><a class=text-link href=/en/documents/level-2/>Advanced Documentation</a></li><li class=active>Getting Started with Transparent Proxy</li></ol></nav><h1>Advanced Documentation<span>Getting Started with Transparent Proxy</span></h1><nav class=subpages><li class=active><a title=$pagetitle href=/en/documents/level-2/transparent_proxy/transparent_proxy/>Getting Started with Transparent Proxy</a></li><li><a title=$pagetitle href=/en/documents/level-2/tproxy/>TProxy Configuration</a></li><li><a title=$pagetitle href=/en/documents/level-2/iptables_gid/>ÈÄèÊòé‰ª£ÁêÜÈÄöËøágidËßÑÈÅøXrayÊµÅÈáè</a></li></nav><div class=jump-to-section><span onclick="$h=$(this),$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#what-is-transparent-proxytproxy>What is Transparent Proxy(TProxy)?</a></li><li><a href=#implementation-of-transparent-proxy>Implementation of Transparent Proxy</a><ul><li><a href=#tun2socks>tun2socks</a></li><li><a href=#iptablesnftables>iptables/nftables</a></li></ul></li><li><a href=#iptables-implement-the-principle-of-transparent-proxy>iptables implement the principle of transparent proxy</a></li><li><a href=#where-is-the-difficulty-of-transparent-proxy>Where is the difficulty of transparent proxy?</a></li><li><a href=#step-by-step-implementation-of-transparent-proxy-based-on-iptables-tproxy-from-zero>Step by step implementation of transparent proxy based on iptables-tproxy from zero</a><ul><li><a href=#before-the-start-you-need-to-have-certain-basic-knowledge>Before the start, you need to have certain basic knowledge:</a></li><li><a href=#initial-preparation-work>Initial Preparation Work</a></li><li><a href=#first-lets-try-to-do-the-first-stage>First, let‚Äôs try to do the first stage</a></li><li><a href=#second-stage>Second stage</a></li><li><a href=#the-third-stage>The third stage</a></li><li><a href=#fourth-stage>Fourth stage</a></li><li><a href=#proxy-ipv6>Proxy ipv6</a></li></ul></li></ul></nav></div><div class=content><h2 ref=what-is-transparent-proxytproxy>What is Transparent Proxy(TProxy)?</h2><a class=anchor id=what-is-transparent-proxytproxy></a><p>General speaking the Transparent Proxy is not let the device which has been proxied feeling itself to be proxied, further speaking is the proxied device do not need to run any proxy software(such as Xray, V2rayNG and so on). When you connected to the network, your device has been proxied.</p><p>And it means that, the proxy software is running in other places, such as running in the router, all the devices connected to the Internet via the router can automatically be proxied.</p><h2 ref=implementation-of-transparent-proxy>Implementation of Transparent Proxy</h2><a class=anchor id=implementation-of-transparent-proxy></a><p>Now the implementation of transparent proxy has two ways:</p><h3 ref=tun2socks>tun2socks</h3><a class=anchor id=tun2socks></a><p>It can be implemented on Windows/Linux (including Android). Because the implementation process is relatively simple and there are few tutorials, I will briefly describe it here.</p><p><strong>Windows</strong></p><ol><li><p>Install <strong><a href=https://github.com/NetchX/Netch/releases>Netch</a></strong> , Using mode<code>[3] [TUN/TAP] Bypass LAN</code>and active it.</p></li><li><p>Turn on the Hotspot</p></li><li><p>Open<code>Control Panel</code>-><code>Networok and Internet</code>-><code>Network and Sharing Center</code>-><code>Change adapter settings</code>, find<code>TAP-Windows Adapter</code>and<code>Microsoft Wi-Fi Direct Virtual Adapter</code>.</p></li><li><p>Right Click<code>TAP-Windows Adapter</code>, <code>Properties</code>-><code>Sharing</code>, Check<code>Allow other network users to connect through this computer‚Äôs Internet connection</code>, select the network connection of <code>Microsoft Wi-Fi Direct Virtual Adapter</code> in <code>Home Network Connection</code>, and click OK.</p></li></ol><p><strong>Android</strong></p><ol><li><p>Configure connection V2RayNG</p></li><li><p>Open Hotspot</p></li><li><p>Hotspot settings -> Allow Hotspot use VPN(partly Android may not have this option)</p></li></ol><h3 ref=iptablesnftables>iptables/nftables</h3><a class=anchor id=iptablesnftables></a><p>iptables & nftables are the same way to implemented Transparent Proxy, and the following uses iptables uniformly.</p><p>The Transparent Proxy which based on iptables only available in Linux system(concluding Openwrt/Android). For its more efficiency than tun2socks and it is suitable on router, make it be widely used.</p><p>The existing three vernacular transparent proxy tutorials actually talk about this transparent proxy implementation based on this scheme, they are: <strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>New V2Ray vernacular tutorials-Transparent Proxy</a></strong> , <strong><a href=https://guide.v2fly.org/app/tproxy.html>New V2Ray vernacular tutorials-TPROXY</a></strong> , <strong><a href=../../tproxy>Tproxy Configuration</a></strong> . And the first article is based on iptables-redirect mode, but is outdated and not recommended for use, only reference. The second and third articles talk about the implementation of transparent proxy based on iptables-tproxy mode.</p><h2 ref=iptables-implement-the-principle-of-transparent-proxy>iptables implement the principle of transparent proxy</h2><a class=anchor id=iptables-implement-the-principle-of-transparent-proxy></a><p>Linux use <code>Netfilter</code> to manage network, the <code>Netfilter</code> model is as follows:</p><p><img src=../netfilter.png alt=Netfilter></p><p><strong>Assuming that a router is used as a gateway (that is, our usual way of surfing the Internet), then:</strong></p><p>The traffic direction of LAN devices accessing the Internet through the router:</p><p><code>PREROUTING CHAIN->FORWARD CHAIN->POSTINGROUTING CHAIN</code></p><p>LAN device to access the router traffic (such as login router web management interface / ssh connection router / access dns servers of router, etc.) direction:</p><p><code>PREROUTING CHAIN->INPUT CHAIN->Gateway native</code></p><p>The direction of traffic from the router access to the Internet:</p><p><code>Gateway Native->OUTPUT CHAIN->POSTINGROUTING CHAIN</code></p><p><strong>By using iptables to manipulate the traffic direction of <code>PREROUTING CHAIN</code> and <code>OUTPUT CHAIN</code>, and forward it to Xray, it can proxy LAN equipment and gateway native.</strong></p><h2 ref=where-is-the-difficulty-of-transparent-proxy>Where is the difficulty of transparent proxy?</h2><a class=anchor id=where-is-the-difficulty-of-transparent-proxy></a><p>The difficulty of transparent proxy lies in routing. The so-called routing is to distinguish which traffic is directly connected and which should be proxied, so I personally think that it is more appropriate to call it <strong>Diversion</strong>.</p><p>We can divide routing from easy to difficult into the following stages:</p><ol><li><p>Proxy all the requests.</p></li><li><p>Local LAN IP / Multicast IP request direct connection, others request proxy.</p></li><li><p>Directly connect the connection request which initiated by Xray on the basic of the second point.</p></li><li><p>On the basis of the third point, directly connect to the connection request pointing to the IP in mainland China, and select the domestic and foreign DNS server to resolve the domestic and foreign domain names.</p></li></ol><p>The three tutorials mentioned above are all in the fourth stage. So it may seem a bit difficult to understand for novices to read directly.</p><h2 ref=step-by-step-implementation-of-transparent-proxy-based-on-iptables-tproxy-from-zero>Step by step implementation of transparent proxy based on iptables-tproxy from zero</h2><a class=anchor id=step-by-step-implementation-of-transparent-proxy-based-on-iptables-tproxy-from-zero></a><h3 ref=before-the-start-you-need-to-have-certain-basic-knowledge>Before the start, you need to have certain basic knowledge:</h3><a class=anchor id=before-the-start-you-need-to-have-certain-basic-knowledge></a><ol><li><p>You need to know about TCP/IP protocol, domain name and DNS server.</p></li><li><p>Know what is WAN port, LAN port, LAN_IP, WAN_IP and DHCP server. For the bypass route, there is only one network port, which is called the LAN port here</p></li><li><p>Have the most basic understanding of the Linux system (know how to run commands)</p></li><li><p>Be able to write the client json file configuration, and at least the configuration can be understood.</p></li></ol><h3 ref=initial-preparation-work>Initial Preparation Work</h3><a class=anchor id=initial-preparation-work></a><p><strong>1. Prepare a gateway running Linux system</strong></p><p>For example, a router with OpenWRT.</p><p><strong>2. Prepare Xray executable files and configuration files at the gateway (router)</strong></p><p>The configuration file monitors port 12345 and enables tproxy:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;log&#34;</span>: {
    <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warning&#34;</span>
  },
  <span style=color:#f92672>&#34;inbounds&#34;</span>: [
    {
      <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>12345</span>,
      <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dokodemo-door&#34;</span>,
      <span style=color:#f92672>&#34;settings&#34;</span>: {
        <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp,udp&#34;</span>,
        <span style=color:#f92672>&#34;followRedirect&#34;</span>: <span style=color:#66d9ef>true</span>
      },
      <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
        <span style=color:#f92672>&#34;sockopt&#34;</span>: {
          <span style=color:#f92672>&#34;tproxy&#34;</span>: <span style=color:#e6db74>&#34;tproxy&#34;</span>
        }
      }
    }
  ],
  <span style=color:#f92672>&#34;outbounds&#34;</span>: [
    {
       <span style=color:#960050;background-color:#1e0010>The</span> <span style=color:#960050;background-color:#1e0010>configuration</span> <span style=color:#960050;background-color:#1e0010>of</span> <span style=color:#960050;background-color:#1e0010>your</span> <span style=color:#960050;background-color:#1e0010>server</span>
    }
  ]
}
</code></pre></div><p>We start from easy to difficult. Without writing routing, we only write one inbound and one outbound.</p><h3 ref=first-lets-try-to-do-the-first-stage>First, let‚Äôs try to do the first stage</h3><a class=anchor id=first-lets-try-to-do-the-first-stage></a><p>Forward all traffic of the <code>PREROUTING CHAIN</code> to Xray.</p><p>Run Xray and execute the following commands:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY
</code></pre></div><p>After you have entered, if you use ssh to connect to the gateway, you will find that the ssh is disconnected (don‚Äôt worry, it can be restored after power off and restart), and the transparent proxy cannot access the Internet; if your gateway is Virtual machine, you will find that the gateway itself cannot access the Internet, and there will appear many requests about the source address as the destination address and the destination address as WAN_IP in the access_log of Xray.</p><p>Theoretically, the gateway&rsquo;s local access to the public network will only go through the <code>OUTPUT CHAIN</code> and <code>POSTROUTING CHAIN</code>. Why does manipulation of the <code>PREROUTING CHAIN</code> cause the gateway to fail to access the Internet? This is because network communication is often two-way. Although the gateway does not need to pass through the <code>PREROUTING CHAIN</code> to access the public IP, the accessed server return information to the gateway must pass through the <code>PREROUTING CHAIN</code>, and this part is forwarded to Xray. Therefore, a reverse request in the log appears.</p><p>Let&rsquo;s modify the rules. If the source IP is not from LAN, and then return. Restart the gateway, run Xray, and execute the following commands:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY
<span style=color:#75715e># &#34;Gateway LAN_IP address segment&#34; obtained by running the command &#34;ip address | grep -w &#34;inet&#34; | awk&#39;{print $2}&#39;&#34;, is one of them</span>
iptables -t mangle -A XRAY ! -s Gateway LAN_IP address segment -j RETURN
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY
</code></pre></div><p>Then you will find that although the ssh connection is broken, the transparent proxy is already available. As long as modify the system dns to public dns, we will be able to access the Internet (because the gateway cannot be accessed now, so set dns to the gateway will not work).</p><p>At this point, the first stage is finished. The reason why the gateway cannot be accessed is that the proxy rules proxy all the traffic, including the traffic which access to the gateway. Imagine accessing your local gateway on the VPS, it is definitely not accessible. So we need to connect this part of traffic directly. Please read the second stage:</p><h3 ref=second-stage>Second stage</h3><a class=anchor id=second-stage></a><p>Restart the gateway, run Xray, and execute the following commands:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY

<span style=color:#75715e># All the target address at network segment where the gateway is located request direct connection</span>
<span style=color:#75715e># Obtained by running the command &#34;ip address | grep -w &#34;inet&#34; | awk&#39;{print $2}&#39;&#34;, generally there are multiple</span>
iptables -t mangle -A XRAY -d Network segment <span style=color:#ae81ff>1</span> where the gateway is located -j RETURN
iptables -t mangle -A XRAY -d Network segment <span style=color:#ae81ff>2</span> where the gateway is located -j RETURN
...

<span style=color:#75715e># Request direct connection when the destination address is multicast IP</span>
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN

iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY
</code></pre></div><p>After using this rule, the previous rule <code>iptables -t mangle -A XRAY ! -s Gateway LAN_IP address segment -j RETURN</code> becomes a redundant rule and can be deleted.</p><p>At this point, the second stage is completed. The gateway is already accessible, and ssh will not be disconnected.</p><h3 ref=the-third-stage>The third stage</h3><a class=anchor id=the-third-stage></a><p>The DNS we usually use comes from routers, but this iptables rule only proxies the devices in the local area network, but does not proxy the gateway native, so the returned DNS query results may be wrong or polluted.</p><p>iptables-tproxy do not support <code>OUTPUT CHAIN</code> operation, but <code>Netfilter</code> has a feature, after marking the packet as <code>1</code> at <code>OUTPUT CHAIN</code> , the corresponding packet will be rerouted to the <code>PREROUTING CHAIN</code>. Therefore, the request that the gateway native needs to proxy, we can mark <code>1</code> at <code>OUTPUT CHAIN</code> .</p><p>If you want to proxy all the requests sent by the gateway native, it will introduce a problem, Xray runs on the gateway, Xray sends a request to the proxy server, and the request is proxied again, will form a loop.</p><p>Therefore, to proxy the gateway native, it is necessary to avoid loopback happening, that is, to circumvent Xray request traffic in proxy rules.</p><p><strong>There are three common methods:</strong></p><ol><li>Directly connect to the traffic which target address to VPS</li></ol><p>Restart the gateway, run Xray, and execute the following commands:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#75715e>#Proxy LAN Device</span>
<span style=color:#75715e>#Inherit the results of the previous stage</span>
ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY
iptables -t mangle -A XRAY -d Network segment <span style=color:#ae81ff>1</span> where the gateway is located -j RETURN
iptables -t mangle -A XRAY -d Network segment <span style=color:#ae81ff>2</span> where the gateway is located -j RETURN
...
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY

<span style=color:#75715e>#Proxy Gateway Native</span>
iptables -t mangle -N XRAY_MASK
iptables -t mangle -A XRAY_MASK -d Network segment <span style=color:#ae81ff>1</span> where the gateway is located -j RETURN
iptables -t mangle -A XRAY_MASK -d Network segment <span style=color:#ae81ff>2</span> where the gateway is located -j RETURN
...
iptables -t mangle -A XRAY_MASK -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_MASK -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY_MASK -d VPS Public IP/32 -j RETURN
iptables -t mangle -A XRAY_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A OUTPUT -p tcp -j XRAY_MASK
iptables -t mangle -A OUTPUT -p udp -j XRAY_MASK
</code></pre></div><p>But to configure like this has a disadvantage. If you use CDN or have a lot of VPS, it is hard to write rules.</p><ol start=2><li>Circumvent through Mark</li></ol><p>The three vernacular tutorials all use this method to circumvent, and refer it by yourself, so I won&rsquo;t repeat them here.</p><ol start=3><li>Circumvent through gid (recommended)</li></ol><p>Reference <strong><a href=../../iptables_gid>[TProxy]Avoid Xray traffic through gid</a></strong></p><p>This completes the third stage agent, which is usually called the global agent. But remember to set the DNS server of the gateway to a foreign DNS server, otherwise the polluted results may still be returned.</p><h3 ref=fourth-stage>Fourth stage</h3><a class=anchor id=fourth-stage></a><p>In fact, not everyone needs to achieve the fourth stage. The global proxy is already applicable for most situations.</p><p>Especially for bypass routes. When proxy is required, adjust the gateway to the bypass route IP, and when proxy is not required, change the gateway back to the main route IP.</p><p>As for the specific realization of the fourth stage, refer to the three vernacular tutorials. After understanding the above content, reading the three vernacular tutorials will be easier to understand.</p><h3 ref=proxy-ipv6>Proxy ipv6</h3><a class=anchor id=proxy-ipv6></a><p>The above rules only take effect for ipv4. If you want to proxy ipv6 requests, use the ip6tables command, which is basically the same as iptables. Refer to <strong><a href=../../iptables_gid#4-%E8%AE%BE%E7%BD%AEiptables%E8%A7%84%E5%88%99>[TProxy]Avoid Xray traffic through gid#4-set iptables rules</a></strong></p><h1 ref=other-considerations-for-transparent-proxy-of-iptables>Other considerations for transparent proxy of iptables</h1><a class=anchor id=other-considerations-for-transparent-proxy-of-iptables></a><ol><li><p>If the gateway which perform as a proxy is used as the main route, add a <code>iptables -t mangle -A XRAY ! -s Gateway LAN_IP address segment -j RETURN</code> to the <code>PREROUTING CHAIN</code> rule, these are the commands that used in the first stage and deleted in the second stage. If you don&rsquo;t write it, other people on the same network segment in the WAN port can fill in the gateway which is your WAN_IP, for stealing your transparent proxy to use, it may also bring a certain degree of danger.</p></li><li><p>The third article in <strong><a href=https://guide.v2fly.org/app/tproxy.html#%E8%AE%BE%E7%BD%AE%E7%BD%91%E5%85%B3>New V2Ray vernacular guide-Transparent Proxy(TPROXY)#Setting Gateway</a></strong> says: <code>Manually configure the network of PC and point the default gateway to the address of the Raspberry Pi, which is 192.168.1.22. At this time, the PC should be able to access the Internet normally (because no proxy has been set up yet, "normally" means that the domestic website can be accessed)</code>. In fact, even if IP forwarding is turned on in Ubuntu, CentOS, debian and other systems, the PC cannot access the Internet, this is normal. In fact, only OpenWRT can achieve as described in the text. According to <strong><a href=https://github.com/BioniCosmos>@BioniCosmos</a></strong> remind, this is because the general Linux system does not have Masquery rules.</p></li><li><p><strong><a href=https://guide.v2fly.org/app/tproxy.html#%E8%A7%A3%E5%86%B3-too-many-open-files-%E9%97%AE%E9%A2%98>The Problem of &ldquo;Too many open files&rdquo;</a></strong> , Refer the solution to <strong><a href=../../iptables_gid#3-%E9%85%8D%E7%BD%AE%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%A7%E5%BC%80%E6%95%B0%E8%BF%90%E8%A1%8Cxray%E5%AE%A2%E6%88%B7%E7%AB%AF>[TProxy]Avoid Xray traffic through gid-Configure the maximum file opening number & Run Xray client</a></strong></p></li><li><p>Regarding enable the ip_forward, to be added&mldr;</p></li><li><p>To prevent the existing connected package from passing through TPROXY twice, to be added&mldr;</p></li><li><p>Main routing, single-arm routing and bypass routing, to be added&mldr;</p></li></ol></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/en/documents/level-2/transparent_proxy/transparent_proxy/>Getting Started with Transparent Proxy</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#what-is-transparent-proxytproxy>What is Transparent Proxy(TProxy)?</a></li><li><a href=#implementation-of-transparent-proxy>Implementation of Transparent Proxy</a><ul><li><a href=#tun2socks>tun2socks</a></li><li><a href=#iptablesnftables>iptables/nftables</a></li></ul></li><li><a href=#iptables-implement-the-principle-of-transparent-proxy>iptables implement the principle of transparent proxy</a></li><li><a href=#where-is-the-difficulty-of-transparent-proxy>Where is the difficulty of transparent proxy?</a></li><li><a href=#step-by-step-implementation-of-transparent-proxy-based-on-iptables-tproxy-from-zero>Step by step implementation of transparent proxy based on iptables-tproxy from zero</a><ul><li><a href=#before-the-start-you-need-to-have-certain-basic-knowledge>Before the start, you need to have certain basic knowledge:</a></li><li><a href=#initial-preparation-work>Initial Preparation Work</a></li><li><a href=#first-lets-try-to-do-the-first-stage>First, let‚Äôs try to do the first stage</a></li><li><a href=#second-stage>Second stage</a></li><li><a href=#the-third-stage>The third stage</a></li><li><a href=#fourth-stage>Fourth stage</a></li><li><a href=#proxy-ipv6>Proxy ipv6</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-2/transparent_proxy/transparent_proxy.md target=blank><i class="fab fa-github"></i>Improve this page</a></li><li><i class="fas fa-calendar"></i>Last update on 23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>