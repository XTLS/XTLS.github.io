<!doctype html><html><head><title>TProxy Configuration :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-03-11T06:31:32 UTC"><meta name=description content="Project X Documentation."><meta name=author content="Project X"><title>TProxy Configuration :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https://xtls.github.io"</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/en/documents/level-2/tproxy/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https://xtls.github.io/en"</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/en/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/en/about/>Project X&nbsp;‚ö°</a><ul><li data-nav-id=https://xtls.github.io/en/about/new/ class="dd-item
item_level_$level"><a href=/en/about/new/>X History&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/en/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/en/guide/>Quick start&nbsp;</a></li><li data-nav-id=https://xtls.github.io/en/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/en/config/>Configuration files&nbsp;üìú</a><ul><li data-nav-id=https://xtls.github.io/en/config/base/ class="dd-item haschildren
item_level_$level"><a href=/en/config/base/>Basic configuration module&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/en/config/base/log/ class="dd-item
item_level_$level"><a href=/en/config/base/log/>Êó•ÂøóÈÖçÁΩÆ</a></li><li data-nav-id=https://xtls.github.io/en/config/base/api/ class="dd-item
item_level_$level"><a href=/en/config/base/api/>API interfaces</a></li><li data-nav-id=https://xtls.github.io/en/config/base/dns/ class="dd-item
item_level_$level"><a href=/en/config/base/dns/>Built-in dns server</a></li><li data-nav-id=https://xtls.github.io/en/config/base/routing/ class="dd-item
item_level_$level"><a href=/en/config/base/routing/>Routing</a></li><li data-nav-id=https://xtls.github.io/en/config/base/policy/ class="dd-item
item_level_$level"><a href=/en/config/base/policy/>Êú¨Âú∞Á≠ñÁï•</a></li><li data-nav-id=https://xtls.github.io/en/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/en/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/en/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/en/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/en/config/base/transport/ class="dd-item
item_level_$level"><a href=/en/config/base/transport/>‰º†ËæìÊñπÂºè</a></li><li data-nav-id=https://xtls.github.io/en/config/base/stats/ class="dd-item
item_level_$level"><a href=/en/config/base/stats/>ÁªüËÆ°‰ø°ÊÅØ</a></li><li data-nav-id=https://xtls.github.io/en/config/base/reverse/ class="dd-item
item_level_$level"><a href=/en/config/base/reverse/>ÂèçÂêë‰ª£ÁêÜ</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/en/config/inbound-protocols/>Inbounds ÂèØÁî®ÂçèËÆÆÂàóË°®</a></li><li data-nav-id=https://xtls.github.io/en/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/en/config/outbound-protocols/>Outbounds ÂèØÁî®ÂçèËÆÆÂàóË°®</a></li><li data-nav-id=https://xtls.github.io/en/config/transports/ class="dd-item
item_level_$level"><a href=/en/config/transports/>‰º†ËæìÊñπÂºèÂàóË°®</a></li><li data-nav-id=https://xtls.github.io/en/config/fallback/ class="dd-item
item_level_$level"><a href=/en/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/en/config/xtls/ class="dd-item
item_level_$level"><a href=/en/config/xtls/>XTLS</a></li><li data-nav-id=https://xtls.github.io/en/config/env/ class="dd-item
item_level_$level"><a href=/en/config/env/>Environment Variables</a></li><li data-nav-id=https://xtls.github.io/en/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/en/config/multiple_config/>Â§öÊñá‰ª∂ÈÖçÁΩÆ</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/en/documents/>Using Experiences&nbsp;üìö</a><ul><li data-nav-id=https://xtls.github.io/en/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/en/documents/level-0/>Â∞èÂ∞èÁôΩÁôΩËØùÊñá&nbsp;üìô</a></li><li data-nav-id=https://xtls.github.io/en/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/en/documents/level-1/>Getting Started Skills&nbsp;</a></li><li data-nav-id=https://xtls.github.io/en/documents/level-2/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/en/documents/level-2/>Advanced Documentation&nbsp;üìò</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/en/develop/>ÂºÄÂèëÊåáÂçó&nbsp;üñ•Ô∏è</a><ul><li data-nav-id=https://xtls.github.io/en/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/en/develop/intro/>ÂºÄÂèëÊâãÂÜå</a></li><li data-nav-id=https://xtls.github.io/en/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/en/develop/protocols/>ÂçèËÆÆËØ¶Ëß£</a></li></ul></li><li data-nav-id=https://xtls.github.io/en/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/en/faq/>Â∏∏ËßÅÈóÆÁ≠î&nbsp;üí¨</a></li><li data-nav-id=https://xtls.github.io/en/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/en/caseslip/>Â§ßÊ°àÁâçÊúØ&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/en/links/ class="dd-item alwaysopen
item_level_$level"><a href=/en/links/>Â∏∏Áî®ÈìæÊé•&nbsp;ü§ù</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io>Home</a></li><li><a class=text-link href=/en/documents/>Using Experiences</a></li><li><a class=text-link href=/en/documents/level-2/>Advanced Documentation</a></li><li class=active>TProxy Configuration</li></ol></nav><h1>Advanced Documentation<span>TProxy Configuration</span></h1><nav class=subpages><li><a title=$pagetitle href=/en/documents/level-2/transparent_proxy/transparent_proxy/>Getting Started with Transparent Proxy</a></li><li class=active><a title=$pagetitle href=/en/documents/level-2/tproxy/>TProxy Configuration</a></li><li><a title=$pagetitle href=/en/documents/level-2/iptables_gid/>ÈÄèÊòé‰ª£ÁêÜÈÄöËøágidËßÑÈÅøXrayÊµÅÈáè</a></li></nav><div class=jump-to-section><span onclick="$h=$(this),$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#before-the-start>Before the Start</a></li><li><a href=#configuration-of-xray>Configuration of Xray</a></li><li><a href=#policy-routing-configuration>Policy Routing Configuration</a></li><li><a href=#configuration-of-netfilter>Configuration of Netfilter</a></li><li><a href=#configure-permanentization--self-startup>Configure Permanentization & Self-startup</a></li></ul></nav></div><div class=content><p>This configuration is based on <a href=https://guide.v2fly.org/app/tproxy.html>New V2Ray vernacular tutorial on TProxy (transparent proxy)</a> , adding the new features of Xray, using the VLESS + XTLS Splice solution, and change the default outbound proxy distribution method to the default outbound direct connection in the old tutorial, the user should modify it according to the actual situation.</p><p>All the configurations in this article have been successfully tested in Raspberry Pi 2B and Ubuntu 20.04 environments. If you use them in other environments, please adjust the configuration yourself.</p><h2 ref=before-the-start>Before the Start</h2><a class=anchor id=before-the-start></a><p>Please check if your device has an available network connection, and the server has been configured successfully, the client has been installed.</p><p>It should be noticed that many transparent proxy tutorials currently open the IP forwarding of the Linux system, but this will cause the performance decreasing of Splice. For details, please refer to <a href=https://github.com/XTLS/Xray-core/discussions/59>Chapter 3 &ldquo;Record of solving the Big case&rdquo;&ndash;How we cracked the mystery of Splice performance degradation even lower than Direct performance</a>.</p><p>What I want to add here is that many transparent proxy tutorials will use Netfilter to diverse traffic, so that direct traffic is sent directly without going through Xray. At this time, IP forwarding must be enabled; And some tutorials, such as this article, will import all traffic into Xray. And then Xray&rsquo;s routing module performs traffic distribution, and there is no need to enable IP forwarding at this time.</p><h2 ref=configuration-of-xray>Configuration of Xray</h2><a class=anchor id=configuration-of-xray></a><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;log&#34;</span>: {
        <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warning&#34;</span>,
        <span style=color:#f92672>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;/var/log/xray/error.log&#34;</span>,
        <span style=color:#f92672>&#34;access&#34;</span>: <span style=color:#e6db74>&#34;/var/log/xray/access.log&#34;</span>
    },
    <span style=color:#f92672>&#34;inbounds&#34;</span>: [
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;all-in&#34;</span>,
            <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>12345</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dokodemo-door&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp,udp&#34;</span>,
                <span style=color:#f92672>&#34;followRedirect&#34;</span>: <span style=color:#66d9ef>true</span>
            },
            <span style=color:#f92672>&#34;sniffing&#34;</span>: {
                <span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>,
                <span style=color:#f92672>&#34;destOverride&#34;</span>: [
                    <span style=color:#e6db74>&#34;http&#34;</span>,
                    <span style=color:#e6db74>&#34;tls&#34;</span>
                ]
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;tproxy&#34;</span>: <span style=color:#e6db74>&#34;tproxy&#34;</span>
                }
            }
        }
    ],
    <span style=color:#f92672>&#34;outbounds&#34;</span>: [
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;direct&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;freedom&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;domainStrategy&#34;</span>: <span style=color:#e6db74>&#34;UseIPv4&#34;</span>
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;mark&#34;</span>: <span style=color:#ae81ff>2</span>
                }
            }
        },
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;vless&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;vnext&#34;</span>: [
                    {
                        <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;Server Domain&#34;</span>,
                        <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>443</span>,
                        <span style=color:#f92672>&#34;users&#34;</span>: [
                            {
                                <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;UUID&#34;</span>,
                                <span style=color:#f92672>&#34;flow&#34;</span>: <span style=color:#e6db74>&#34;xtls-rprx-splice&#34;</span>,
                                <span style=color:#f92672>&#34;encryption&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>
                            }
                        ]
                    }
                ]
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp&#34;</span>,
                <span style=color:#f92672>&#34;security&#34;</span>: <span style=color:#e6db74>&#34;xtls&#34;</span>,
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;mark&#34;</span>: <span style=color:#ae81ff>2</span>
                }
            }
        },
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;block&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;blackhole&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;response&#34;</span>: {
                    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>
                }
            }
        },
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;dns-out&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dns&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>
            },
            <span style=color:#f92672>&#34;proxySettings&#34;</span>: {
                <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;mark&#34;</span>: <span style=color:#ae81ff>2</span>
                }
            }
        }
    ],
    <span style=color:#f92672>&#34;dns&#34;</span>: {
        <span style=color:#f92672>&#34;hosts&#34;</span>: {
            <span style=color:#f92672>&#34;Server Domain&#34;</span>: <span style=color:#e6db74>&#34;Server IP&#34;</span>
        },
        <span style=color:#f92672>&#34;servers&#34;</span>: [
            {
                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;119.29.29.29&#34;</span>,
                <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>53</span>,
                <span style=color:#f92672>&#34;domains&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:cn&#34;</span>
                ],
                <span style=color:#f92672>&#34;expectIPs&#34;</span>: [
                    <span style=color:#e6db74>&#34;geoip:cn&#34;</span>
                ]
            },
            {
                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;223.5.5.5&#34;</span>,
                <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>53</span>,
                <span style=color:#f92672>&#34;domains&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:cn&#34;</span>
                ],
                <span style=color:#f92672>&#34;expectIPs&#34;</span>: [
                    <span style=color:#e6db74>&#34;geoip:cn&#34;</span>
                ]
            },
            <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>,
            <span style=color:#e6db74>&#34;1.1.1.1&#34;</span>,
            <span style=color:#e6db74>&#34;https+local://doh.dns.sb/dns-query&#34;</span>
        ]
    },
    <span style=color:#f92672>&#34;routing&#34;</span>: {
        <span style=color:#f92672>&#34;domainStrategy&#34;</span>: <span style=color:#e6db74>&#34;IPIfNonMatch&#34;</span>,
        <span style=color:#f92672>&#34;rules&#34;</span>: [
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;inboundTag&#34;</span>: [
                    <span style=color:#e6db74>&#34;all-in&#34;</span>
                ],
                <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>53</span>,
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;dns-out&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;ip&#34;</span>: [
                    <span style=color:#e6db74>&#34;119.29.29.29&#34;</span>,
                    <span style=color:#e6db74>&#34;223.5.5.5&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;direct&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;ip&#34;</span>: [
                    <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>,
                    <span style=color:#e6db74>&#34;1.1.1.1&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;domain&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:category-ads-all&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;block&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;domain&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:geolocation-!cn&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;ip&#34;</span>: [
                    <span style=color:#e6db74>&#34;geoip:jp&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:us&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:sg&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:hk&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:tw&#34;</span>,
                    <span style=color:#e6db74>&#34;109.239.140.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;14.102.250.18&#34;</span>,
                    <span style=color:#e6db74>&#34;14.102.250.19&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.164.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.168.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.172.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;174.142.105.153&#34;</span>,
                    <span style=color:#e6db74>&#34;50.7.31.230&#34;</span>,
                    <span style=color:#e6db74>&#34;67.220.91.15&#34;</span>,
                    <span style=color:#e6db74>&#34;67.220.91.18&#34;</span>,
                    <span style=color:#e6db74>&#34;67.220.91.23&#34;</span>,
                    <span style=color:#e6db74>&#34;69.65.19.160&#34;</span>,
                    <span style=color:#e6db74>&#34;72.52.81.22&#34;</span>,
                    <span style=color:#e6db74>&#34;85.17.73.31&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.4.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.56.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.56.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;108.177.120.94&#34;</span>,
                    <span style=color:#e6db74>&#34;108.177.120.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;172.217.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;74.125.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;23.246.0.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;37.77.184.0/21&#34;</span>,
                    <span style=color:#e6db74>&#34;45.57.0.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;64.120.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;66.197.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;108.175.32.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;192.173.64.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;198.38.96.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;198.45.48.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;173.245.48.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;103.21.244.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;103.22.200.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;103.31.4.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;141.101.64.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;108.162.192.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;190.93.240.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;188.114.96.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;197.234.240.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;198.41.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;162.158.0.0/15&#34;</span>,
                    <span style=color:#e6db74>&#34;104.16.0.0/12&#34;</span>,
                    <span style=color:#e6db74>&#34;172.64.0.0/13&#34;</span>,
                    <span style=color:#e6db74>&#34;131.0.72.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;144.220.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;52.124.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;54.230.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;54.239.128.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;52.82.128.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;99.84.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.172.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;54.239.192.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;70.132.0.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;13.32.0.0/15&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.208.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;13.224.0.0/14&#34;</span>,
                    <span style=color:#e6db74>&#34;13.35.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.164.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.168.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;71.152.0.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;216.137.32.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.249.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;99.86.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;52.46.0.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;52.84.0.0/15&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.173.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;130.176.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.200.0/21&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.174.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;64.252.128.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.254.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;143.204.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.252.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.176.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;13.249.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;54.240.128.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.250.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;52.222.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;54.182.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;54.192.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;103.2.30.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;125.209.208.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;147.92.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;203.104.144.0/21&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.8.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.12.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.16.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.160.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;3.123.36.126/32&#34;</span>,
                    <span style=color:#e6db74>&#34;35.157.215.84/32&#34;</span>,
                    <span style=color:#e6db74>&#34;35.157.217.255/32&#34;</span>,
                    <span style=color:#e6db74>&#34;52.58.209.134/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.93.124.31/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.162.243.80/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.173.34.141/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.235.23.242/32&#34;</span>,
                    <span style=color:#e6db74>&#34;169.45.248.118/32&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            }
        ]
    }
}
</code></pre></div><div class="notices primary"><p><strong>TIPs</strong></p><p>This configuration will hijack all traffic sent to port 53 to solve the DNS pollution problem, so the address of the client and the local DNS server address of this machine can be configured at will.</p><p>In addition, because the built-in <code>geoip.dat</code> file cannot perfectly implement routing traffic diverse, some addon IPs are added to the configuration file.</p></div><h2 ref=policy-routing-configuration>Policy Routing Configuration</h2><a class=anchor id=policy-routing-configuration></a><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback># ip route add local default dev lo table 100 # Add routing table 100
# ip rule add fwmark 1 table 100 # Set rules for routing table 100
</code></pre></div><h2 ref=configuration-of-netfilter>Configuration of Netfilter</h2><a class=anchor id=configuration-of-netfilter></a><div class="notices warning"><p><strong>Notices</strong></p><p>Choose one of nftables configuration and iptables configuration, and cannot be used two at the same time.</p></div><div class=tabs><input type=radio name=tabs-2 id=tabs-2-0 checked>
<label for=tabs-2-0>nftables</label><div class=tab><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>#!/usr/sbin/nft -f
<p>flush ruleset</p>
<p>define RESERVED_IP = {
10.0.0.0/8,
100.64.0.0/10,
127.0.0.0/8,
169.254.0.0/16,
172.16.0.0/12,
192.0.0.0/24,
224.0.0.0/4,
240.0.0.0/4,
255.255.255.255/32
}</p>
<p>table ip xray {
chain prerouting {
type filter hook prerouting priority mangle; policy accept;
ip daddr $RESERVED_IP return
ip daddr 192.168.0.0/16 tcp dport != 53 return
ip daddr 192.168.0.0/16 udp dport != 53 return
ip protocol tcp tproxy to 127.0.0.1:12345 meta mark set 1
ip protocol udp tproxy to 127.0.0.1:12345 meta mark set 1
}
chain output {
type route hook output priority mangle; policy accept;
ip daddr $RESERVED_IP return
ip daddr 192.168.0.0/16 tcp dport != 53 return
ip daddr 192.168.0.0/16 udp dport != 53 return
meta mark 2 return
ip protocol tcp meta mark set 1
ip protocol udp meta mark set 1
}
}
</code></pre></div><div class="notices primary"><p><strong>Instructions</strong></p></p><p>Write the above configuration into a file (such as <code>nft.conf</code>), then grant the file executable permissions, and finally execute the file with root permissionsÔºà<code># ./nft.conf</code>Ôºâ.</p></div></div><input type=radio name=tabs-2 id=tabs-2-1>
<label for=tabs-2-1>iptables</label><div class=tab><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>iptables -t mangle -N XRAY
iptables -t mangle -A XRAY -d 10.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY -d 100.64.0.0/10 -j RETURN
iptables -t mangle -A XRAY -d 127.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY -d 169.254.0.0/16 -j RETURN
iptables -t mangle -A XRAY -d 172.16.0.0/12 -j RETURN
iptables -t mangle -A XRAY -d 192.0.0.0/24 -j RETURN
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 240.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY -d 192.168.0.0/16 -p tcp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY -d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A PREROUTING -j XRAY

iptables -t mangle -N XRAY_SELF
iptables -t mangle -A XRAY_SELF -d 10.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY_SELF -d 100.64.0.0/10 -j RETURN
iptables -t mangle -A XRAY_SELF -d 127.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY_SELF -d 169.254.0.0/16 -j RETURN
iptables -t mangle -A XRAY_SELF -d 172.16.0.0/12 -j RETURN
iptables -t mangle -A XRAY_SELF -d 192.0.0.0/24 -j RETURN
iptables -t mangle -A XRAY_SELF -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_SELF -d 240.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_SELF -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY_SELF -d 192.168.0.0/16 -p tcp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY_SELF -d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY_SELF -m mark --mark 2 -j RETURN
iptables -t mangle -A XRAY_SELF -p tcp -j MARK --set-mark 1
iptables -t mangle -A XRAY_SELF -p udp -j MARK --set-mark 1
iptables -t mangle -A OUTPUT -j XRAY_SELF
</code></pre></div></div></div><p>After the configuration is complete, change the default gateway of other devices in the LAN to this device IP, and you can directly overturn the wall. After other hosts and this machine are tested successfully, you can proceed to the next configuration.</p><h2 ref=configure-permanentization--self-startup>Configure Permanentization & Self-startup</h2><a class=anchor id=configure-permanentization--self-startup></a><div class=tabs><input type=radio name=tabs-3 id=tabs-3-0 checked>
<label for=tabs-3-0>nftables</label><div class=tab><p>First move the edited nftables configuration file to the <code>/etc</code> directory, and rename it to <code>nftables.conf</code>. And then edit <code>/lib/systemd/system/nftables.service</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ini data-lang=ini><span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>nftables</span>
<span style=color:#a6e22e>Documentation</span><span style=color:#f92672>=</span><span style=color:#e6db74>man:nft(8) http://wiki.nftables.org</span>
<span style=color:#a6e22e>Wants</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target</span>
<span style=color:#a6e22e>Before</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target shutdown.target</span>
<span style=color:#a6e22e>Conflicts</span><span style=color:#f92672>=</span><span style=color:#e6db74>shutdown.target</span>
<span style=color:#a6e22e>DefaultDependencies</span><span style=color:#f92672>=</span><span style=color:#e6db74>no</span>
<p><span style=color:#66d9ef>[Service]</span>
<span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>oneshot</span>
<span style=color:#a6e22e>RemainAfterExit</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
<span style=color:#a6e22e>StandardInput</span><span style=color:#f92672>=</span><span style=color:#e6db74>null</span>
<span style=color:#a6e22e>ProtectSystem</span><span style=color:#f92672>=</span><span style=color:#e6db74>full</span>
<span style=color:#a6e22e>ProtectHome</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
<span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/nft -f /etc/nftables.conf ; /usr/sbin/ip route add local default dev lo table 100 ; /usr/sbin/ip rule add fwmark 1 table 100</span>
<span style=color:#a6e22e>ExecReload</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/nft -f /etc/nftables.conf</span>
<span style=color:#a6e22e>ExecStop</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/nft flush ruleset ; /usr/sbin/ip route del local default dev lo table 100 ; /usr/sbin/ip rule del table 100</span></p>
<p><span style=color:#66d9ef>[Install]</span>
<span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>sysinit.target</span>
</code></pre></div><p>And finally enable will be done.</p></p></div><input type=radio name=tabs-3 id=tabs-3-1>
<label for=tabs-3-1>iptables</label><div class=tab><p>Regarding the permanentization of iptables, it is recommended to install directly <code>iptables-persistent</code>.</p><p>During the installation process, you will be prompted to choose &ldquo;Whether to save the configuration&rdquo;. If the iptables configuration has been written to the system, then select &ldquo;Yes&rdquo; at this time; if it has not been written, it doesn&rsquo;t matter. After the installation is complete, write the configuration and execute <code>netfilter-persistent save</code> will be done (root permission is required).</p><p>And then edit <code>/lib/systemd/system/netfilter-persistent.service</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ini data-lang=ini><span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>netfilter persistent configuration</span>
<span style=color:#a6e22e>DefaultDependencies</span><span style=color:#f92672>=</span><span style=color:#e6db74>no</span>
<span style=color:#a6e22e>Wants</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target systemd-modules-load.service local-fs.target</span>
<span style=color:#a6e22e>Before</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target shutdown.target</span>
<span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>systemd-modules-load.service local-fs.target</span>
<span style=color:#a6e22e>Conflicts</span><span style=color:#f92672>=</span><span style=color:#e6db74>shutdown.target</span>
<span style=color:#a6e22e>Documentation</span><span style=color:#f92672>=</span><span style=color:#e6db74>man:netfilter-persistent(8)</span>

<span style=color:#66d9ef>[Service]</span>
<span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>oneshot</span>
<span style=color:#a6e22e>RemainAfterExit</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
<span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/netfilter-persistent start ; /usr/sbin/ip route add local default dev lo table 100 ; /usr/sbin/ip rule add fwmark 1 table 100</span>
<span style=color:#a6e22e>ExecStop</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/netfilter-persistent stop ; /usr/sbin/ip route del local default dev lo table 100 ; /usr/sbin/ip rule del table 100</span>

<span style=color:#66d9ef>[Install]</span>
<span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</code></pre></div></div></div></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/en/documents/level-2/tproxy/>TProxy Configuration</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#before-the-start>Before the Start</a></li><li><a href=#configuration-of-xray>Configuration of Xray</a></li><li><a href=#policy-routing-configuration>Policy Routing Configuration</a></li><li><a href=#configuration-of-netfilter>Configuration of Netfilter</a></li><li><a href=#configure-permanentization--self-startup>Configure Permanentization & Self-startup</a></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-2/tproxy.md target=blank><i class="fab fa-github"></i>Improve this page</a></li><li><i class="fas fa-calendar"></i>Last update on 23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>